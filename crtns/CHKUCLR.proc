CHKUCLR	//;CHECK REGISTER CHECK UNCLEAR FUNCTION
	/*
	       ORIG:  Jill Bulkin (6838) - 05/16/86
	   PROJ #'S:  1346
	       DESC:  MARK CHECKS IN THE CHECK REGISTER AS UNCLEARED -REMOVE DATE

	  ---- Revision History ------------------------------------------------
	   10/17/05 - PUTTASWH - CR17011
	   	      Modified CHECKS section to declare the GL variable and 
	   	      VPGO1 and FILE sections to delete the references to
	   	      XCHKREG table.
	   	      
	   12/02/03 - CARROLLJ - CR7239
		      Added #ACCEPT check to CHECKS linetag to correct compile
		      errors.

	   06/16/03 - CARROLLJ - 51349
		      Modified the CHECKS section to remove the CK array.

	   04/16/2002 , TELIV , 49794
		Convertion from M to PSL

	*/

VINIT	// init variables
	
	if '$D(%LIBS) set %LIBS="SYSDEV"		

	set %="|" 
	set %ProcessMode=0
	set (%PG,%PAGE)=1 
	set ER=0

	kill CHKCLR,OLNTB
	do VPG

	quit

VPG	// Page control
	if $D(VFMQ),"DFQ"[VFMQ do VER quit

	if %PG>0 do VPG01 quit:ER  do VPG quit

	do VPG01
	
	quit	

VPG01	//
	set %TAB("CO")=".CO2/TBL=[CHKREG1]CO:DISTINCT:QU"
	set %TAB("CKTYP")=".CHKTYP1/TBL=[UTBLCHKS]/XPP=D POS^CHKCLR"
	set %TAB("CKNO")=".CKNO2/TBL=[CHKREG1]CKNO:DISTINCT:QU ""[CHKREG1]CTYPE=<<CKTYP>>""/HLP=[CHKREG1]CKNO/XPP=D EXT^DBSQRY"
	set %READ="@@%FN,,,CO/REQ,CKTYP/REQ,CKNO/REQ"

	// JMH - 02/07/01
	do ^UTLREAD 

	if VFMQ="Q" set ER=1 set RM=$$^MSG(8483) quit

	if $D(Q) set SEQBY="["_%LIBS_",CHKREG1]CKNO" do ^DBSQRYA

	quit


VER	//
	if VFMQ="Q"!(ER) do EXIT quit    		// JMH - 02/01/01

	set ER=0 
	set CKNO=MIN(1) 
	set CKNO=CKNO-1
	do CHECKS 

	quit
	

CHECKS //
	type public Number GL
	type ResultSet rs=Db.select("CKNO","CHKREG1","CO=:CO AND GL=:GL AND CKNO>:CKNO","CKNO")
	if rs.isEmpty() set CKNO=""
	if rs.next() set CKNO=rs.getCol(1)

	if CKNO=""!(CKNO>MAX(1)) do EXIT quit
	
	#ACCEPT DATE=04/16/02;PGM=TELIV
	xecute Q(1,1) else  do CHECKS quit

	type RecordCHKREG1 chkreg1=Db.getRecord("CHKREG1","CO=:CO,GL=:GL,CKNO=:CKNO")

	// already voided
	if chkreg1.status=2 set ER=1 do CHECKS quit        

	// not cleared
	if chkreg1.status=0 set ER=1 do CHECKS quit         

	do FILE(.chkreg1)

	do CHECKS quit


FILE(RecordCHKREG1 chkreg1) 	// File data

	set chkreg1.status=0 
	set chkreg1.clear=""

	//Update check register
	do chkreg1.bypassSave()
	
	quit


EXIT	// Exit function

	//"Check clear correction completed"
	if 'ER set ER="W" set RM=$$^MSG(8482) quit

	set RID="CHKCLR2"
	do DRV^URID                            // call exception report

	quit

vSIG()	quit "60220^23754^Hema Puttaswamy^2332"	// Signature - LTD^TIME^USER^SIZE
