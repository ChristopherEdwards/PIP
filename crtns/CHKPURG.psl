CHKPURG /*	CHECK REGISTER PURGE (TO RMS FILE AND OPTIONAL REPORT)

	ORIG: TELIV - 02/19/2002
	DESC: Check Register Purge
	
	---- Revision History ------------------------------------------------
	
	01/19/04 - RussellDS - CR 7514
		   Moved into Profile04.

	02/20/02 - TELIV - 49451
		   Converted to PSL

	04/06/01 - SPIER 44495
	           Modified DTL section FETCH^SQL call to fix issue
	           when calling stored procedure rather then cache code, sqlsta
	           must be reviewed not sqlcnt.

	----------------------------------------------------------------------	
	*/

	new BANK,CNT,EIO,GL,IO,PGM,PIO,RP
	type String SID
	
	set %ProcessMode=0

	type RecordCHKPURG fCHKPURG=Class.new("RecordCHKPURG")
	set fCHKPURG.co=CUVAR.gls	
	
	if '$D(%LIBS) set %LIBS="SYSDEV"
	
	set SID="CHKPURG"	
	do DRV^USID(%ProcessMode,SID,.fCHKPURG) 

	//Check register purge aborted
	if VFMQ="Q" do { quit	
		set ER="W"
		set RM=$$^MSG(8466)       
		}

	set BANK=fCHKPURG.bank
	type RecordUTBLCHKBANK1 utblchkbank1=Db.getRecord("UTBLCHKBANK1","CO=:CO,KEY=:BANK")
	set GL=utblchkbank1.gl

	set %JD=fCHKPURG.prior
	set RP=fCHKPURG.rept
	set SPLDIR=CUVAR.spldir

	if RP do {
		set %TAB("EIO")=".IO3/XPP=S %EXT=1 D ^SCAIO S EIO=IO"
		set %TAB("EIO")=%TAB("EIO")_"/TBL=[DEVICE]DEVNAME:NOVAL" 
		set EIO=$I
		}

	
DEV	//
	set PIO=SPLDIR
	set %TAB("PIO")=".PIO1/XPP=D PPDEV^CHKPURG"

	if RP set %READ="EIO/REQ,PIO/REQ"
	else  set %READ="PIO/REQ"

	set OLNTB=9042

	do ^UTLREAD 

	//Check register purge aborted
	if VFMQ="Q" do { quit
		set ER="W" 
		set RM=$$^MSG(8466)
		}
	

VER	//
	
	set %TAB("CONT")=".CONT1"
	set %READ="CONT/REQ" 
	set OLNTB=11042

	do ^UTLREAD 

	//Check register purge aborted
	if VFMQ="Q" do { quit
		set ER="W" 
		set RM=$$^MSG(8466) 
		}

	//Check register purge aborted
	if 'CONT do { quit
		set ER="W" 
		set RM=$$^MSG(8466) 
		}
	

	
	type IO io=Class.new("IO")
	set io.fileName="SAVE.CHKREG"
	set io.directory=PIO
	set io.openParams="WRITE/NEWV"

	do io.open()

	catch ERROR {
		set ET=ERROR.type
		set RM=ERROR.context
		}

	if ER quit

	if RP do Db.delete("CHKREG1D","PID=:%ProcessID")

	do DTL(.io)

	quit



DTL(IO io)	//
	new CHKDATA,x

	type RecordCHKREG1D chkreg1d
	set CKNO="" 
	set CNT=0

	use IO

	// Open cursor and fetch only the fields valid for purging.
	type ResultSet rs=Db.select("CKNO,TJD,EFD,UID,BRCD,TRC,TAMT,CID,PAYEE,CTYPE,STATUS,CLEAR,COMBINED,MEMO","CHKREG1","CO=:CO AND GL=:GL AND TJD<:%JD AND (STATUS=2 OR CLEAR IS NOT NULL)")
	for  quit:'rs.next()  do { 
		set CHKDATA=rs.getRow()
		set CKNO=$P(CHKDATA,$C(9),1) 
		set CHKDATA=$P(CHKDATA,$C(9),2,14)

		//I18N=OFF
		use IO write "^CHKREG("_CO_","_GL_","_CKNO_")="""_CHKDATA_""""

		//I18N=ON
		do Db.delete("CHKREG1","CO=:CO AND GL=:GL AND CKNO=:CKNO")
		set CNT=CNT+1

		if RP do {
			set chkreg1d=Db.getRecord("CHKREG1D","PID=:PID,CKNO=:CKNO",1)
			set chkreg1d.tjd=$P(CHKDATA,$C(9),1)
			set chkreg1d.efd=$P(CHKDATA,$C(9),2)
			set chkreg1d.uid=$P(CHKDATA,$C(9),3)
			set chkreg1d.brcd=$P(CHKDATA,$C(9),4)
			set chkreg1d.trc=$P(CHKDATA,$C(9),5)
			set chkreg1d.tamt=$P(CHKDATA,$C(9),6)
			set chkreg1d.cid=$P(CHKDATA,$C(9),7)
			set chkreg1d.payee=$P(CHKDATA,$C(9),8)
			set chkreg1d.ctype=$P(CHKDATA,$C(9),9)
			set chkreg1d.status=$P(CHKDATA,$C(9),10)
			set chkreg1d.clear=$P(CHKDATA,$C(9),11)
			set chkreg1d.combined=$P(CHKDATA,$C(9),12)
			set chkreg1d.memo=$P(CHKDATA,$C(9),13)

			do chkreg1d.bypassSave()
		
			}
		}
	
	do EXIT(.io)
	
	quit	

	
EXIT(IO io)	//
	
	set ER="W"
	set RM=$$^MSG(6684,IO)                 //Save ~p1 to tape
	
	// optional report and exit
	
	// I18N=OFF	
	do io.write("End of File")
	// I18N=ON
	do io.close()

	if RP do {
		set IO=$G(EIO) set:IO="" IO=$I
		set RID="CHKPURG1"               
		do DRV^URID
		}

	//Check register purge complete
	set RM=$$^MSG(8465)
	quit 
	
	
ERR	//
	
	set ER=1 

	do ^UTLERR

	set VFMQ="Q"
	quit 
	
	
PPDEV	// Post processor for directory device to write purge file to
	
	if X="" set X=CUVAR.spldir

	new Y 
	set Y=$$TRNLNM^%ZFUNC(X)

	if Y'="" set X=Y
	quit 
	
	
 #OPTION ResultClass ON
Public String vSIG()	quit "60227^22818^Hema Puttaswamy^3756"	// Signature - LTD^TIME^USER^SIZE
