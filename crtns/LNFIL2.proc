LNFIL2 // LN DATA-QWIK filer, part (4)
 // Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 01/31/2007 11:25 - shetyes

	quit		// Not called from top

VJOURNAL(RecordLN ln)	//LN Journal file entries

	type Public Date %EffectiveDate
	type Public String %TSRC,vpar,vx()
	type String TSRC,vdi,vdx()

	if %TSRC.get().isNull() set TSRC="O"
	else  set TSRC=%TSRC

	if %ProcessMode=0 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj6(.ln)	// Mode=I Tran=B EFD=N Seq=1 JRNID=DTJNAACN_I
				do vj7(.ln)	// Mode=I Tran=B EFD=N Seq=1 JRNID=DTJNA_I
				do vj11(.ln)	// Mode=I Tran=B EFD=N Seq=1 JRNID=HIST_I
				do vj12(.ln)	// Mode=I Tran=B EFD=N Seq=1 JRNID=HIST_I_APPNUM
				}
			}
		else  if TSRC="O" do {
			if 'EFD.get() do {
				do vj6(.ln)	// Mode=I Tran=O EFD=N Seq=1 JRNID=DTJNAACN_I
				do vj7(.ln)	// Mode=I Tran=O EFD=N Seq=1 JRNID=DTJNA_I
				do vj11(.ln)	// Mode=I Tran=O EFD=N Seq=1 JRNID=HIST_I
				do vj12(.ln)	// Mode=I Tran=O EFD=N Seq=1 JRNID=HIST_I_APPNUM
				}
			}
		}
	else  if %ProcessMode=1 do {
		if TSRC="B" do {
			if EFD.get() do {
				do vj13(.ln)	// Mode=U Tran=B EFD=E Seq=1 JRNID=HIST_U
				}
			else  do {
				do vj13(.ln)	// Mode=U Tran=B EFD=N Seq=1 JRNID=HIST_U
				quit:'vx.data()
				if vx("STAT").data() do vj3(.ln,"STAT")	// Mode=U Tran=B EFD=N Seq=1 JRNID=CMSRECCID
				if vx("STAT").data() do vj8(.ln,"STAT")	// Mode=U Tran=B EFD=N Seq=1 JRNID=DTJNA_U
				if vx("TYPE").data() do vj14(.ln,"TYPE")	// Mode=U Tran=B EFD=N Seq=1 JRNID=TYPE_FROM_U
				if vx("TYPE").data() do vj15(.ln,"TYPE")	// Mode=U Tran=B EFD=N Seq=1 JRNID=TYPE_TO_U
				if vx("CRCD").data() do vj4(.ln,"CRCD")	// Mode=U Tran=B EFD=N Seq=2 JRNID=CRCD_TO_U
				if vx("CRLMT").data() do vj5(.ln,"CRLMT")	// Mode=U Tran=B EFD=N Seq=2 JRNID=CRLMT_U
				if vx("GLSC").data() do vj9(.ln,"GLSC")	// Mode=U Tran=B EFD=N Seq=2 JRNID=GLSC_FROM_U
				if vx("GLSC").data() do vj10(.ln,"GLSC")	// Mode=U Tran=B EFD=N Seq=2 JRNID=GLSC_TO_U
				if vx("CC").data() do vj1(.ln,"CC")	// Mode=U Tran=B EFD=N Seq=3 JRNID=CC_FROM_U
				if vx("CC").data() do vj2(.ln,"CC")	// Mode=U Tran=B EFD=N Seq=3 JRNID=CC_TO_U
				}
			}
		else  if TSRC="O" do {
			if EFD.get() do {
				do vj13(.ln)	// Mode=U Tran=O EFD=E Seq=1 JRNID=HIST_U
				}
			else  do {
				do vj13(.ln)	// Mode=U Tran=O EFD=N Seq=1 JRNID=HIST_U
				quit:'vx.data()
				if vx("STAT").data() do vj3(.ln,"STAT")	// Mode=U Tran=O EFD=N Seq=1 JRNID=CMSRECCID
				if vx("STAT").data() do vj8(.ln,"STAT")	// Mode=U Tran=O EFD=N Seq=1 JRNID=DTJNA_U
				if vx("TYPE").data() do vj14(.ln,"TYPE")	// Mode=U Tran=O EFD=N Seq=1 JRNID=TYPE_FROM_U
				if vx("TYPE").data() do vj15(.ln,"TYPE")	// Mode=U Tran=O EFD=N Seq=1 JRNID=TYPE_TO_U
				if vx("CRCD").data() do vj4(.ln,"CRCD")	// Mode=U Tran=O EFD=N Seq=2 JRNID=CRCD_TO_U
				if vx("CRLMT").data() do vj5(.ln,"CRLMT")	// Mode=U Tran=O EFD=N Seq=2 JRNID=CRLMT_U
				if vx("GLSC").data() do vj9(.ln,"GLSC")	// Mode=U Tran=O EFD=N Seq=2 JRNID=GLSC_FROM_U
				if vx("GLSC").data() do vj10(.ln,"GLSC")	// Mode=U Tran=O EFD=N Seq=2 JRNID=GLSC_TO_U
				if vx("CC").data() do vj1(.ln,"CC")	// Mode=U Tran=O EFD=N Seq=3 JRNID=CC_FROM_U
				if vx("CC").data() do vj2(.ln,"CC")	// Mode=U Tran=O EFD=N Seq=3 JRNID=CC_TO_U
				}
			}
		}

	quit


vj1(RecordLN ln,String vdi)	// CC_FROM_U  Table DAYENDXFR  Cost Center Change - From Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.oldVal
	set dayendxfr.ccc=ln.cc.curVal
	set dayendxfr.cglsc=ln.glsc
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.ctype=ln.type
	set dayendxfr.deftot=$$DFRCSTR^LNFUNCS(ln.cid)
	set dayendxfr.feerem=$$FRCSTR^LNFUNCS(ln.cid)
	set dayendxfr.glsc=ln.glsc
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.ndfbal=$$NDFREC^LNFUNCS(ln.cid)
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=0

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj2(RecordLN ln,String vdi)	// CC_TO_U  Table DAYENDXFR  Cost Center Change - To Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.curVal
	set dayendxfr.ccc=ln.cc.oldVal
	set dayendxfr.cglsc=ln.glsc
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.ctype=ln.type
	set dayendxfr.deftot=$$DFRCSTR^LNFUNCS(ln.cid)
	set dayendxfr.feerem=$$FRCSTR^LNFUNCS(ln.cid)
	set dayendxfr.glsc=ln.glsc
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.ndfbal=$$NDFREC^LNFUNCS(ln.cid)
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj3(RecordLN ln,String vdi)	// CMSRECCID  Table CMSRECCID  Add CMSREC entry for mod. LN records

	if +ln.carduf=1
	else  quit

							//// Save this line for Public datatyping, if needed
	type String vlastkey
	set vlastkey=Db.nextVal("CMSRECCID","")
	type RecordCMSRECCID cmsreccid=Db.getRecord("CMSRECCID","SEQ=:vlastkey",1)
	set cmsreccid.cid=ln.cid
	set cmsreccid.cmsflg=ln.cmsflg

	do cmsreccid.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj4(RecordLN ln,String vdi)	// CRCD_TO_U  Table DAYENDXFR  Currency Code - To Account Info

							//// Save this line for Public datatyping, if needed
	type String v1,vlastkey
	set v1=ln.eurefd
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.oldVal
	set dayendxfr.ccc=ln.cc.oldVal
	set dayendxfr.ccrcd=ln.crcd.oldVal
	set dayendxfr.cglsc=ln.glsc.oldVal
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.crcd=ln.crcd.curVal
	set dayendxfr.ctype=ln.type.oldVal
	set dayendxfr.glsc=ln.glsc.oldVal
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type.oldVal
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj5(RecordLN ln,String vdi)	// CRLMT_U  Table DTJNA  Credit Limit Change - Act as new acct

	type String VQ1

	set VQ1=$$CRLMT^LNFUNCS(%SystemDate,ln.cls,ln.grp,ln.type,ln.cid)

	if VQ1="0"
	else  quit

	type Public String %IDENT,TJD
	type String v1,v2,v3,v4,vlastkey
	set v1=TJD
	set v2=ln.cls
	set v3=ln.grp
	set v4=ln.type
	set vlastkey=ln.cid
	type RecordDTJNA dtjna=Db.getRecord("DTJNA","TJD=:v1,CLS=:v2,GRP=:v3,TYP=:v4,CID=:vlastkey",1)
	set dtjna.ident=%IDENT
	set dtjna.newcrlmt=ln.crlmt.curVal
	set dtjna.oldcrlmt=ln.crlmt.oldVal

	do dtjna.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj6(RecordLN ln)	// DTJNAACN_I  Table DTJNAACN  New Account Insert Journal

	type Public String TJD
	type String v1,v2,v3,v4,v5,vlastkey
	set v1=TJD
	set v2=ln.acn
	set v3=ln.cls
	set v4=ln.grp
	set v5=ln.type
	set vlastkey=ln.cid
	type RecordDTJNAACN dtjnaacn=Db.getRecord("DTJNAACN","SJD=:v1,ACN=:v2,CLS=:v3,GRP=:v4,TYPE=:v5,CID=:vlastkey",1)

	do dtjnaacn.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj7(RecordLN ln)	// DTJNA_I  Table DTJNA  Daily New Account Journal

	type Public String %IDENT,TJD
	type String v1,v2,v3,v4,vlastkey
	set v1=TJD
	set v2=ln.cls
	set v3=ln.grp
	set v4=ln.type
	set vlastkey=ln.cid
	type RecordDTJNA dtjna=Db.getRecord("DTJNA","TJD=:v1,CLS=:v2,GRP=:v3,TYP=:v4,CID=:vlastkey",1)
	set dtjna.ident=%IDENT

	do dtjna.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj8(RecordLN ln,String vdi)	// DTJNA_U  Table DTJNA  Daily New Account Journal

	if +ln.stat=0
	else  quit

	type Public String %IDENT,TJD
	type String v1,v2,v3,v4,vlastkey
	set v1=TJD
	set v2=ln.cls
	set v3=ln.grp
	set v4=ln.type
	set vlastkey=ln.cid
	type RecordDTJNA dtjna=Db.getRecord("DTJNA","TJD=:v1,CLS=:v2,GRP=:v3,TYP=:v4,CID=:vlastkey",1)
	set dtjna.ident=%IDENT
	set dtjna.reopn=1

	do dtjna.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj9(RecordLN ln,String vdi)	// GLSC_FROM_U  Table DAYENDXFR  GL Set Code Change - From Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.oldVal
	set dayendxfr.ccc=ln.cc.oldVal
	set dayendxfr.cglsc=ln.glsc.curVal
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.ctype=ln.type
	set dayendxfr.feerem=$$FRCSTR^LNFUNCS(ln.cid)
	set dayendxfr.glsc=ln.glsc.oldVal
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=0

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj10(RecordLN ln,String vdi)	// GLSC_TO_U  Table DAYENDXFR  GL Set Code Change - To Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.oldVal
	set dayendxfr.ccc=ln.cc.oldVal
	set dayendxfr.cglsc=ln.glsc.oldVal
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.ctype=ln.type
	set dayendxfr.feerem=$$FRCSTR^LNFUNCS(ln.cid)
	set dayendxfr.glsc=ln.glsc.curVal
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj11(RecordLN ln)	// HIST_I  Table HIST  History Entry for New Account

	type Public String %IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=ln.cid
	set vlastkey=Db.nextVal("HIST","CID=:v1")
	type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
	set hist.brcd=ln.boo
	set hist.cdt=+$H
	set hist.ident=%IDENT
	set hist.tcmt=$$^MSG(6795)
	set hist.time=$P($H,",",2)
	set hist.tjd=TJD
	set hist.tlo=TLO
	set hist.uid=%UID

	do hist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj12(RecordLN ln)	// HIST_I_APPNUM  Table HIST  Application Number - Insert

	type Public String EFD,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=ln.cid
	set vlastkey=Db.nextVal("HIST","CID=:v1")
	type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
	set hist.brcd=ln.boo
	set hist.cdt=+$H
	set hist.efd=$G(EFD)
	set hist.tcmt=$$^MSG(3333,"[LN]APPNUM::"_ln.appnum)
	set hist.time=$P($H,",",2)
	set hist.tjd=TJD
	set hist.tlo=TLO
	set hist.uid=%UID

	do hist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj13(RecordLN ln)	// HIST_U  Table HIST  History for File Maintenance

	type Public String vx()
	type String vdi
	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  if 'vx(vdi).piece("|",3) if vdi'="TLD" do {
		type Public String vx(),EFD,%IDENT,%UID,TJD,TLO,vfmtable
		type String v1,vlastkey

		type String vold,vnew,vfmtable

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)
		set vfmtable=vx(vdi).piece("|",11)

		set v1=ln.cid
		set vlastkey=Db.nextVal("HIST","CID=:v1")
		type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
		set hist.brcd=ln.boo
		set hist.cdt=+$H
		set hist.efd=$G(EFD)
		set hist.ident=%IDENT
		set hist.tcmt=$$TCMTFM^ACNFUNCS("","LN",vdi,vold,vnew,$G(EFD),,vfmtable)
		set hist.time=$P($H,",",2)
		set hist.tjd=TJD
		set hist.tlo=TLO
		set hist.uid=%UID

		do hist.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit


vj14(RecordLN ln,String vdi)	// TYPE_FROM_U  Table DAYENDXFR  Product Type Change - From Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.oldVal
	set dayendxfr.ccc=ln.cc.oldVal
	set dayendxfr.cglsc=ln.glsc.oldVal
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.ctype=ln.type.curVal
	set dayendxfr.glsc=ln.glsc.oldVal
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type.oldVal
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=0

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj15(RecordLN ln,String vdi)	// TYPE_TO_U  Table DAYENDXFR  Product Type Change - To Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=ln.acr
	set dayendxfr.cc=ln.cc.oldVal
	set dayendxfr.ccc=ln.cc.oldVal
	set dayendxfr.cglsc=ln.glsc.oldVal
	set dayendxfr.cid=ln.cid
	set dayendxfr.coa=ln.coa
	set dayendxfr.ctype=ln.type.oldVal
	set dayendxfr.glsc=ln.glsc.oldVal
	set dayendxfr.iunc=ln.iunt
	set dayendxfr.lchg=ln.lchg
	set dayendxfr.prn=ln.bal
	set dayendxfr.rec=ln.rec
	set dayendxfr.type=ln.type.curVal
	set dayendxfr.udbal=ln.udbalxfr
	set dayendxfr.unapf=ln.unapf
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit

