DEPIRN	 /* 
    ORIG: GRAY - 01/11/2000
    DESC: Effective Dated Rate Change
    
    ---- Comments --------------------------------------------------------
    
    ---- Revision History ------------------------------------------------

	06/18/03 - CARROLLJ - 51349
		   Removed call to EXT^TTXP2 from EFDIRN section and also
		   remove use of TR array.
 */	

	quit
	

Public EFDIRN(CID,RecordDEP dep,AICHG,OLDIRN,RecordDEPSEG depseg)	
	/*
		* File Transactions for ACR adjustments *
	This subroutine called from AU_IRN and AU_AIIRN DEP tiggers and from 
	BU_IRN DEPSEG trigger.
 
	ARGUMENTS:
		.CID	Account Number			TYP=N/MECH=VAL/NOREQ
		.dep	Deposit Account Record		TYP=RecordDEP/REQ
		.AICHG	Avl Int Rate changed flag	TYP=L/MECH=VAL/NOREQ
		.OLDIRN	Old Int Rate value		TYP=N/MECH=VAL/REQ
		.depseg	Account Segment Record		TYP=RecordDEPSEG/NOREQ 
	*/

	new %UX,CRCD,SEGFLG,SEQ,SAVEFD,par
	
	set SAVEFD=$G(EFD) new EFD set EFD=SAVEFD
	
	/*
	set ttx as a dummy record so that there is a transaction sequence 1
	set piece 17 of ttx so that crcd is placed in secondary transaction
	from ttx when calling into RECALC0
	*/
	Type RecordTTX ttx=Class.new("RecordTTX")
	set SEQ=1

	set CRCD=dep.crcd
	#if CUVAR.%MCP set ttx.crcd=$S(CRCD=%SystemCurrency:"",1:CRCD)
	
	// Segments in Use
	if dep.segflg do {
		new RSPAR
		// Available int flag
		set AICHG=$G(AICHG)
	
		set RSPAR("PRCTYP")=3+AICHG
		if $G(SEGMENT)'="" do {
			new SEGSTART
			
			set SEGSTART=depseg.segstart
			if EFD<SEGSTART set ER=1,RM=$$^MSG(3863,SEGMENT,$$DAT^%ZM(SEGSTART,$G(%MSKD)))
			
			set RSPAR("SEGMENT")=SEGMENT
			
			set RSPAR("RATE")=depseg.irn
			set depseg.irn=$G(OLDIRN)
			
			}
		else  if AICHG set RSPAR("RATE")=dep.aiirn,dep.aiirn=$G(OLDIRN)
		else  set RSPAR("RATE")=dep.irn,dep.irn=$G(OLDIRN)
	
		quit:ER

		do EXTERN^RECALSEG(.dep,.ttx,.RSPAR)

		}
	quit:ER
	

	// Segment is not in use
	if 'dep.segflg do NOREV^RECALC(.dep)
	
	if ER do { quit
		set X=RM kill RM
		// Account ~p1 modified.  Accrual not adjusted because:
		set RM(1)=$$^MSG(123,CID)
		set RM(2)=X
		}

	
	quit
	
Public %UID	// Called from MAN^ROLL
	
	if '%NET set ET="NETWORK" do ERR quit
	set TPD=%SystemDate,BRCD=Db.getOneRow("BOBR","CUVAR")
	quit
	
ERR	//
	if $G(ET)'="" set ER=1 do ^UTLERR
	set VFMQ="Q"
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43509^Sanchez SCM Administrator^2161"	// Signature - LTD^TIME^USER^SIZE
