O5498SA		/*
	ORIG: DHANALAKSHMI R - 11/03/2005
	DESC: IRS Processing - Form 5498-SA Original

	---- Comments --------------------------------------------------------
			  THIS PROCEDURE IS TO BE COMPILED
			      DO NOT RUN STANDALONE

	I18N=QUIT: Excluded from I18N standards.

	---- Revision History ------------------------------------------------
	
	05/30/07 - DHANALAKSHMI R - CR 25413
		Added for IRS processing of Health Savings Account 
		(Form 5498 - SA Original).

	*/

        quit
	
	
MTRCNTRL

	// Master control

	type public Number ER

	do Db.delete("B5498SA")
	
	// Build and write the "A" record
	do ARECBLD quit:ER

	// Build and write the "B" record
	do BRECBLD quit:ER

	// Build and write the "C" record
	do CRECBLD quit:ER

	// Store the TTR report totals
	do STORETOT
	
	do Db.delete("TMPRPT3","PID=:%ProcessID")
	
	quit
	

ARECBLD	

	// "A" record builder

	type public String TAMT()

	type Number AMTIND, FORMCODE

	// IRS form code
	set FORMCODE = "K"
	
	// IRS amount type indicators
	set AMTIND = "12345"
	
	set TAMT(1).piece("|",2) = "Archer MSA contributions"
	set TAMT(2).piece("|",2) = "Current Year Contributions"
	set TAMT(3).piece("|",2) = "Prior Year Contributions"
	set TAMT(4).piece("|",2) = "Rollover Contributions"
	set TAMT(5).piece("|",2) = "Fair Market Value"
	
	// Write the record to tape
	do ARECWRT
	
	quit
	

BRECBLD

	// "B" record builder

	type public Date BEGYR, ENDYR
	type public Number AMT(), FAMT(), FCNT, YEAR

	type Date DOB, DOD
	type Number BACN, BENSEQ, CONT, FMV, I, IRATYP, PYBAL, ROLL, RPASEQ
	type Number TAXYR, TAXYR1, X
	type String ACN, ADDR, BSPECMCZ, CID, CITY, CNTRY, CORRTN, DOCCODE, FORCNTY
	type String FULLADDR, IRA(), IRAROLL, LNAME, NAME, NEXT, RMDIND, ROIRAROLL
	type String SEPROLL, SIMPLEROLL, SPECIAL, STATE, TIN, TINTYPE, MCZC, VAR, ZIP

	type DbSet ds = Db.selectDbSet("IRA","TAXYR=:YEAR")

	while ds.next() do {

		type RecordIRA ira = ds.getRecord("IRA")

		set ACN = ira.acn
		set RPASEQ = ira.rpaseq

		type RecordIRATYPE iratyp = Db.getRecord("IRATYPE", "ACN = :ACN,RPASEQ = :RPASEQ", 1)

		set IRATYP = iratyp.iratyp

		// Quit if not a HSA
		if (IRATYP '= 18),(IRATYP '= 19)  quit

		set TAXYR = YEAR
		set TAXYR1 = YEAR + 1
	
	 	type RecordIRA ira1 = Db.getRecord("IRA", "ACN = :ACN,RPASEQ = :RPASEQ,TAXYR = :TAXYR1", 1)

		do ^IRAYEBAL

		set AMT(2) = ira.c1 * 100
		set AMT(3) = ira1.c2 * 100
		set AMT(4) = ira.c4 * 100
		set AMT(5) = FMV * 100

		// No contribution to report
		if (AMT(1) + AMT(2) + AMT(3) + AMT(4) + AMT(5)) = 0 quit

		type RecordCIF cif = Db.getRecord("CIF", "ACN = :ACN")

		// Account number (RPA sequence number)
		set CID=ACN_"-"_RPASEQ

	 	// Taxpayers identification number
		set TIN=cif.taxid

		// Type of TIN
		if (TIN?2N1"-"7N) set TINTYPE=1
		else  if (TIN?3N1"-"2N1"-"4N) set TINTYPE=2
		else  set TINTYPE=" "

		// Corrected return indicator
		set CORRTN=" "

	 	// Payee First Name
		set NAME = cif.nam

		// Payee Last Name
		set LNAME = cif.lnm

		set FULLADDR = cif.mad1_"|"_cif.mad2_"|"_cif.mad3_"|"_cif.mcity_"|"_cif.mstate_"|"_cif.mzip_"|"_cif.mcntry
		set ADDR = FULLADDR.piece("|",1)_" "_FULLADDR.piece("|",2)_" "_FULLADDR.piece("|",3)

		// Payee City
		set CITY = FULLADDR.piece("|",4)

		// Payee State
		set STATE = FULLADDR.piece("|",5)

		// Payee ZIP
		set ZIP = FULLADDR.piece("|",6).piece("-",1)_FULLADDR.piece("|",6).piece("-",2)

		// Foreign country
		set CNTRY = FULLADDR.piece("|",7)

 		// Foreign country indicator
		set FORCNTY = $S(FULLADDR.piece("|",7)="US":" ",1:1)

		// Type of TIN
		if (TIN?2N1"-"7N) set TINTYPE=1
		else  if (TIN?3N1"-"2N1"-"4N) set TINTYPE=2
		else  set TINTYPE=" "

		// Special date position 544-750
		// Blank |544|547
		set SPECIAL = "    "

		// Blank |548
		set SPECIAL = SPECIAL_1

		// Blank |549|750
		set SPECIAL = SPECIAL_"".justify(202)

		// Write the record to tape
		do BRECWRT

		// Write the record to table B5498SA
		do B5498SA

		// Calculate number of records and tax form report totals
		set FCNT = FCNT + 1
		set FAMT(2) = FAMT(2) + (AMT(2) / 100)
		set FAMT(3) = FAMT(3) + (AMT(3) / 100)
		set FAMT(4) = FAMT(4) + (AMT(4) / 100)
		set FAMT(5) = FAMT(5) + (AMT(5) / 100)
		}

	quit


B5498SA

	// Insert B record data into B5498SA table

	type public Number ACN, AMT()
	type public String ADDR, CID, CITY, FULLADDR, LNAME, NAME, STATE, TIN, TINTYPE, ZIP

	type Number BSEQ
	type String X

	if (TINTYPE = 2) set X = LNAME
	else  set X = NAME

	// Format name
	do NAMCNTRL^IRSTPMTR

	type ResultSet rs = Db.select("BSEQ","B5498SA","PDATE=:%SystemDate AND BACN=:ACN","BSEQ DESC")
	if rs.next() set BSEQ = rs.getCol("BSEQ") + 1
	else  set BSEQ = 1

	// B Record-IRS 5498-SA Form Data
	type RecordB5498SA b5498sa = Db.getRecord("B5498SA", "PDATE = :%SystemDate, BACN = :ACN, BSEQ = :BSEQ", 1)

	set b5498sa.bnamcon = X
	set b5498sa.btintype = TINTYPE
	set b5498sa.btin = TIN.translate(" ","-")
	set b5498sa.bcid = CID
	set b5498sa.bamt2 = AMT(2) / 100
	set b5498sa.bamt3 = AMT(3) / 100
	set b5498sa.bamt4 = AMT(4) / 100
	set b5498sa.bamt5 = AMT(5) / 100
	set b5498sa.bname = NAME
	set b5498sa.baddr1 = ADDR.piece(" ",1)
	set b5498sa.baddr2 = ADDR.piece(" ",2)
	set b5498sa.baddr3 = ADDR.piece(" ",3)
	set b5498sa.bcity = CITY
	set b5498sa.bstate = STATE
	set b5498sa.bzip = FULLADDR.piece("|",6)
	set b5498sa.bhsai = 1

	do b5498sa.save()
	quit


CRECBLD

	// "C" record builder

	// Write the record to tape
	do CRECWRT

	quit


%STOPLOD

	// Stop %ZRTNLOD from this point on down
	quit


TRECWRT

	// Dummy line reference for GT.M
	quit


ARECWRT

	// Dummy line reference for GT.M
	quit


BRECWRT

	// Dummy line reference for GT.M
	quit


CRECWRT

	// Dummy line reference for GT.M
	quit


STORETOT

	// Dummy line reference for GT.M
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "60787^19565^Dhanalakshmi R^5452"	// Signature - LTD^TIME^USER^SIZE
