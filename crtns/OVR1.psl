OVR1	//RFLG1;PBS -  - V2.0 - System-generated Restriction Authorization Maintenance
	/*
	       ORIG:

	  ---- Revision History ------------------------------------------------

	   03/31/05 - TITOVE - CR 15221
	   	      Modified VPG section to prevent undefined on %PG.

	   10/23/02 - CHHABRIAS - 49451
		      Converted to PSL

	  ----------------------------------------------------------------------

	*/

UPD 	//
	do INIT(1)
	quit

INQ 	//
	do INIT(2)
	quit

DEL	//
	do INIT(3)
	quit


INIT(%ProcessMode)	//
	new OLNTB,VFMQ,ZNW
	set %PG=0
	set %PAGE=1
	type RecordUTBLOVR1 fUTBL
	do VPG(.fUTBL)
	quit


VPG(RecordUTBLOVR1 fUTBL)	// Page control

	type public Number %PG
	type public String VFMQ

	type Boolean FINISH = 0
	
	for  do { quit:FINISH
		
		if %PG = 0 do VPG00 if 1
		else  if %PG > 0 do VPG01(.fUTBL)
		
		if "DFQ"[VFMQ do VER(.fUTBL) set FINISH = 1 quit
		
		set %PG = %PG + 1
		}
	quit


VPG00	// Set up
	set %TAB("GRP")=".GRP1/TBL=[STBLLIBS]"
	set %TAB("OVR")=".OVR1/TBL=OVRLOOK(/XPR=D CHECK^OVR(GRP)"
	set %TAB("UCLS")=".UCLS4/TBL=[UTBLOVR1]/XPP=D PP^OVR1"
	if %ProcessMode=2 set %TAB("IO")=$$IO^SCATAB($I)

	set %READ="@@%FN,,,GRP/REQ,OVR/REQ,UCLS/REQ"
	set %NOPRMT="N"
	if %ProcessMode=2 set %READ=%READ_",,IO/REQ"

	do ^UTLREAD

	if VFMQ="Q" set ER=1 quit

	set KEYL(1)="OVR"
        set KEYL(3)=OVR
	quit


PP	// UTLREAD post processor
	if X="" quit

	set KEYL(1)="OVR"
	set KEYL(2)=X
	set KEYL(3)=OVR
	kill ZNW

	do ALL^UTBLOVR

	if $G(%OSAVE)>1 quit
	if Db.isDefined("UTBLOVR1","GRP=:GRP,OVR=:OVR,UCLS=:X") quit

	// Record is new
	set I(3)=""
	set ZNW=1
	set %OSAVE=0
	quit


VPG01(RecordUTBLOVR1 fUTBL)	// Restrict screen

	set fUTBL=Db.getRecord("UTBLOVR1","GRP=:GRP,OVR=:OVR,UCLS=:UCLS",1)

	if %ProcessMode=2,IO'=$I do OPEN^SCAIO if ER set VFMQ="Q" quit

	do DRV^USID(%ProcessMode,"UTBLOVR",.fUTBL)

	kill SAVTR
	quit


VER(RecordUTBLOVR1 fUTBL) 	//
	if %ProcessMode=2!(%ProcessMode=4)!(VFMQ="Q") do END quit
	if %ProcessMode=3 do Db.delete("UTBLOVR1","GRP=:GRP AND OVR=:OVR AND UCLS=:UCLS")
	else  do fUTBL.save()
	do END

	quit


END	//
	if ER!(%ProcessMode=2)!(%ProcessMode=4) quit

	if VFMQ="Q" do {

		// System-generated restriction ~p1.  Userclass authorization ~p2 not created.
		if $G(ZNW)=1 set RM=$$^MSG(2581,OVR,UCLS) quit

		// System-generated restriction ~p1.  Userclass authorization ~p2 not modified.
		if %ProcessMode=1 set RM=$$^MSG(2583,OVR,UCLS) quit

		// System-generated restriction ~p1.  Userclass authorization ~p2 not deleted.
		set RM=$$^MSG(2582,OVR,UCLS)
		}
	else  do {

		// System-generated restriction ~p1.  Userclass authorization ~p2 created.
		if $G(ZNW)=1 set RM=$$^MSG(2578,OVR,UCLS) quit

		// System-generated restriction ~p1.  Userclass authorization ~p2 modified.
		if %ProcessMode=1 set RM=$$^MSG(2580,OVR,UCLS) quit

		// System-generated restriction ~p1.  Userclass authorization ~p2 deleted.
		set RM=$$^MSG(2579,OVR,UCLS)
		}

	set ER="W"
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "60018^66165^Eugene Titov^2698"	// Signature - LTD^TIME^USER^SIZE
