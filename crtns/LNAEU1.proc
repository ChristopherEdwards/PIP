LNAEU1	//Public;On-Demand Auto-Escrow Posting
	/*
	   ORIG: GORMAN - 11/01/93
	   DESC: On-Demand Auto-Escrow Posting

	  ---- Revision History ------------------------------------------------
		
	  31/01/06 -  Srinivar - 19137
	  	      Cleaned up the warnings
	  	      Modified the code to conform to PSL standards.
	  	      Modified the FILE section to pass escrow CID as a 
	  	      second parameter while calling EXC^LNAEU.
	  
	   07/18/02 - Diana Shvachkina - 49794
		      Converted to PSL.
	*/
	
	do INIT quit

INIT	
	type Number BRCD,OLNTB,%PG,%PAGE
	type String ER,ET,RM,VFMQ
	
	set %PG=1 
	set %PAGE=1 
	set %ProcessMode=1
	
	kill OLNTB,VFMQ
	
	do SOURCE^BCHSOURC("BOFF","AEU",.%UserID,.BRCD) 
	if ER do { quit
		// Batch teller and/or branch not defined
		set RM=$$^MSG(7484)
		do EXC^LNAEU(RM)
		set ER="W"
		}

	do ^TTXLOK if ER do { quit
		// TTX file locked by another user - job aborted
		set:'ET.get() ET="TTXLOK"
		do EXC^LNAEU(ET)
		do ^UTLERR
		set ER="W"
		}

	do VPG
	quit

VPG	// Page control

	type public String VFMQ
	type public Number %PG
	
	do VPG0
	if "DFQ"[VFMQ do VER quit
	set %PG=%PG+1
	do VPG
	quit
	
VPG0	
	do VPG01 
	quit 

VPG01	// Set up

	type String %READ,%TAB
	type public String VFMQ

	// /DES=File Date/TYP=D/LEN=10
	set %TAB("EFD")=".FDATE1/HLP=[LNAEU2]EFD/TBL=[LNAEU2]EFD:DISTINCT"
	// /DES=Sequence/TYP=N/LEN=6
	set %TAB("EXTSEQ")=".SEQ2/HLP=[LNAEU2]EXTSEQ/TBL=[LNAEU2]EXTSEQ:DISTINCT"

	set %READ="@@%FN,,,EFD/REQ,EXTSEQ/REQ"
	do ^UTLREAD if VFMQ="Q" quit
	quit

ERR	
	type public Boolean ER
	type public String VFMQ
	
	set ER=1 do ^UTLERR
	set VFMQ="Q"
	quit

VER	// Verification
	
	type public String VFMQ
	if %ProcessMode=2!(%ProcessMode=4)!(VFMQ="Q") do END quit
	do FILE
	do END 
	quit

FILE	// File data
	
	type public Number BRCD,CID,EXTSEQ,ECID
	type Number COUNT,SEQ,TIME,TRC
	type Date DATE
	type String TIME,ESC
	
	set ESC="ESC1"
	
	// Get last transaction sequence for this branch and user
	set TRC=Db.currVal("TTX","TJD=:%SystemDate,BRCD=:BRCD,UID=:%UserID")	

	set DATE=%CurrentDate
	set TIME=%CurrentTime
	set COUNT=0

	type ResultSet lnaeu2rs
	set lnaeu2rs=Db.select("CID","LNAEU2","EFD=:%EffectiveDate AND EXTSEQ=:EXTSEQ")
	while lnaeu2rs.next() do {
		set CID=lnaeu2rs.getCol(1)
		type RecordLNAEU2 lnaeu2=Db.getRecord("LNAEU2","EFD=:%EffectiveDate,EXTSEQ=:EXTSEQ,CID=:CID")
		
		// User has told us to ignore
		if lnaeu2.ignore quit

		// Already Posted
		if lnaeu2.postdate quit
		
		set ECID=$$ECID^LNU(CID,ESC)
		// Has activity taken place on account?
		if lnaeu2.hseq-Db.nextVal("HIST","CID") do EXC^LNAEU("LNAEU1",ECID) quit

		set TRC=TRC\((1000*1000)+1001)

		type ResultSet lnaeu4rs
		set lnaeu4rs=Db.select("TRC","LNAEU4","EFD=:%EffectiveDate AND EXTSEQ=:EXTSEQ AND CID=:CID AND TRTYPE=0")
		while lnaeu4rs.next() do {
			set SEQ=lnaeu4rs.getCol(1)
			type RecordLNAEU4 lnaeu4=Db.getRecord("LNAEU4","EFD=:%EffectiveDate,EXTSEQ=:EXTSEQ,CID=:CID,TRTYPE=0,TRC=:SEQ")
			type RecordTTX ttx=Class.new("RecordTTX")
			set ttx.tjd=%SystemDate
			set ttx.brcd=BRCD
			set ttx.uid=%UserID
			set ttx.tseq=TRC
			set ttx.bcrcd=lnaeu4.bcrcd
			set ttx.brcde=lnaeu4.brcde
			set ttx.bseamt=lnaeu4.bseamt
			set ttx.cc=lnaeu4.cc
			set ttx.cdt=lnaeu4.cdt
			set ttx.chktyp=lnaeu4.chktyp
			set ttx.cid=lnaeu4.cid
			set ttx.crcd=lnaeu4.crcd
			set ttx.custcd=lnaeu4.custcd
			set ttx.dir=lnaeu4.dir
			set ttx.efd=lnaeu4.efd
			set ttx.endbal=lnaeu4.endbal
			set ttx.etc=lnaeu4.etc
			set ttx.glsc=lnaeu4.glsc
			set ttx.itc=lnaeu4.itc
			set ttx.lnerc=lnaeu4.lnerc
			set ttx.msd=lnaeu4.msd
			set ttx.mult=lnaeu4.mult
			set ttx.rate=lnaeu4.rate
			set ttx.rty=lnaeu4.rty
			set ttx.spr=lnaeu4.spr
			set ttx.tamt=lnaeu4.tamt
			set ttx.tcmt=lnaeu4.tcmt
			set ttx.tim=lnaeu4.tim
			set ttx.tlo=lnaeu4.tlo
			set ttx.trc=TRC
			set ttx.tresref=lnaeu4.tresref
			set ttx.tsb=lnaeu4.tsb
			set ttx.tso=lnaeu4.tso
			set ttx.uidt=lnaeu4.uidt
			set ttx.vdt=lnaeu4.vdt
			set ttx.xpdo=lnaeu4.xpdo
			do ttx.bypassSave()

			set COUNT=COUNT+1
			set TRC=TRC+1
			}
		
		set lnaeu2.postdate=DATE
		set lnaeu2.posttime=TIME
		do lnaeu2.bypassSave()
		}

	// Post created transaction records, if any
	if COUNT do ^TTXP1

	quit

END	// End of processing
	
	type public Boolean ER
	type public String VFMQ
	
	type String RM
	
	if ER.get()!(%ProcessMode=2)!(%ProcessMode=4) quit
	set ER="W"
	// Process Aborted
	if VFMQ="Q" set RM=$$^MSG(2238) quit
	// Process Completed
	set RM=$$^MSG(2237)

	quit

vSIG()	quit "60305^35696^Srinivasan, Rajesh^4214"	// Signature - LTD^TIME^USER^SIZE
