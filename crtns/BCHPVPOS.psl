BCHPVPOS //Batch BCHLNPVPOS - Post Principal Variance
 ;;Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 08/30/2007 15:08 - joynerd
 //
 // ********** This is a DATA-QWIK generated Routine **********
 // Level 33  - BCHLNPVPOS Batch Definition
 // ***********************************************************
 //
 //
 type public Number ER
 type public String %FN,RM
 catch vERROR {
 type public Number ER
 type public String RM
 
 do Runtime.rollback()
 
 // DBFILER errors do not log on a call to ZE^UTLERR
 if vERROR.type="%PSL-E-DBFILER" do {
  type String ET = vERROR.type
  do ^UTLERR
 }
 else  do ZE^UTLERR
 
 set ER = 1
 set RM = vERROR.description
 }
 type Number %BatchExit,%BatchRestart,vBCHSTS
 type String vCONTEXT,vINPUT,vSYSVAR,vRESULT
 set %BatchExit=0,%BatchRestart=0,ER=0,RM=""
 do INIT^BCHUTL(.vSYSVAR)
 set vBCHSTS=$$STATUS^BCHUTL("BCHLNPVPOS")
 if vBCHSTS=1 set ER=1,RM=$$^MSG(3410) quit
 if vBCHSTS=2 set ER=1,RM=$$^MSG(3414) quit
 if vBCHSTS=0 set %BatchRestart=1
 do vOPEN(.vINPUT,.%BatchExit) if %BatchExit do EXIT^BCHUTL("BCHLNPVPOS") quit
 do JOBMGR^BCHUTL(%FN,"BCHLNPVPOS",.vINPUT)
 do ^JOBMGR(.vINPUT)
 do EXIT^BCHUTL("BCHLNPVPOS")
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
vPROC(TJD,CID) //
 type public Number ER
 type public String ET,%EVENT,%FN,%INTRPT(),RM,vCONTEXT
 catch vERROR {
 type public Number ER
 type public String RM
 
 do Runtime.rollback()
 
 do LOG^UTLEXC("BCHLNPVPOS","*","",TJD.get()_","_CID.get(), vERROR.thrownAt, vERROR.type)
 
 // DBFILER errors do not log on a call to ZE^UTLERR
 if vERROR.type="%PSL-E-DBFILER" do {
  type String ET = vERROR.type
  do ^UTLERR
 }
 else  do ZE^UTLERR
 
 set ER = 1
 set RM = vERROR.description
 }
 if ('%INTRPT.get().isNull())!(%INTRPT.data() > 1) do INTRPT^BCHUTL(%EVENT.get())
 if %BatchRestart,$$CHKLOG^BCHUTL(%SystemDate,%FN,"BCHLNPVPOS",TJD.get()_","_CID.get()) do { quit
 do LOG^BCHUTL(%SystemDate,%FN,"BCHLNPVPOS",TJD.get()_","_CID.get(),"Record already processed")
 }
 do Runtime.start("BA")
 set vCONTEXT=""
 set (ET,RM)=""
 set ER=0
 do vEXEC(.vCONTEXT,TJD,CID)
 if ER.get() do { quit
 type String et
 set et=$S(ET.get().isNull():RM.get(),1:ET)
 
 do Runtime.rollback()
 do LOG^UTLEXC("BCHLNPVPOS","*","",TJD.get()_","_CID.get(),"",et)
 }
 do UPDLOG^BCHUTL(%SystemDate,%FN,"BCHLNPVPOS",TJD.get()_","_CID.get(),vCONTEXT)
 do Runtime.commit()
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
vEXEC(vCONTEXT,TJD,CID) //
	new ts
	
	// define TranSet object
	type TranSet ts
	set ts=Class.new("TranSet")
       	do PROC(.ts)
	do POST(.ts)
       	quit
	
PROC(TranSet ts)	//

	new AMT,DUE,pvo
	type RecordDAYENDPVO pvo=Db.getRecord("DAYENDPVO","TJD,CID")

	type RecordLN ln
	set ln=Db.getRecord("LN","CID")
	
	type RecordPRODCTL ltype=Db.getRecord("PRODCTL","ln.type")

	set DRETC=ltype.drtrpv
	set CRETC=ltype.crtrpv
	
	type RecordTRN drtrn=Db.getRecord("TRN","ETC=:DRETC")
	type RecordTRN crtrn=Db.getRecord("TRN","ETC=:CRETC")

	set DRITC=drtrn.itc
	set CRITC=crtrn.itc

	do TR
	
	set AMT=pvo.pvar,DUE=pvo.dueamt
	if DUE<AMT set AMT=DUE
	if ln.tld'<TJD!ln.fmld'<TJD do { if ln.dist1nd'<ln.schnd quit
		set AMT=ln.pvar
		set DUE=ln.tdue+ln.lchg+$$MCND^LNCO3(1,.ln,CID)
		if DUE<AMT set AMT=DUE
		}

	new TTXBLD
	
	type RecordTTX ttx
	set ttx=Class.new("RecordTTX")
	set ITC=DRITC
	set ETC=DRETC
	set TCMT=drtrn.des
	set CRCD=ln.crcd
	do TTX(.TTXBLD)
	do TTX^TTXBLD(.ttx,.TTXBLD)
	set x=ts.copyTran(ttx)
	set ITC=CRITC
	set ETC=CRETC
	set TCMT=crtrn.des
	do TTX(.TTXBLD)
	do TTX^TTXBLD(.ttx,.TTXBLD)
	set x=ts.copyTran(ttx)
	quit
	
POST(TranSet ts)	//

	new par
	set par("IPMODE")=3
	set par("OPTION")=2
	
	// Post transactions for this account.
	do ts.postTSet(TPD,BRCD,.par)
	quit
  	 
TTX(TTXBLD)	//

	set TTXBLD("CID")=CID
	set TTXBLD("ITC")=ITC
	set TTXBLD("ETC")=ETC
 	set TTXBLD("TAMT")=AMT
	set TTXBLD("TLO")=%UserStation
	set TTXBLD("TCMT")=TCMT
	set TTXBLD("CRCD")=CRCD
	quit
	
TR	// Setting PMing Indicator

	/*
	Dayend entry is set when TJD+3-LN.SCHND=0. QUE001 is an end of day 
	process set by BTTLN for TJD+1 causing the PM indicator to be a 1.
	*/

	if TPD-TJD=0 quit
	set DRITC=$E(DRITC,1,7)_$E("0000000",1,7-$L(DRITC))_1_$E(DRITC,9,99)
	set CRITC=$E(CRITC,1,7)_$E("0000000",1,7-$L(CRITC))_1_$E(CRITC,9,99)
	quit
  	
LOGERR	// Log error in exception file

	// Principal Variance Posting
	do LOG^UTLEXC($T(+0),"*",$$^MSG(7075)_"|1",$G(CID),$G(%ZTSEQ),$G(RM),$S($G(CID):+$G(BAL),1:""))
	kill RM,%ZTSEQ
	quit
	
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vTHREXEC(vINPUT,vRETURN) //
 type String vRECORD,TJD,CID
 for  set vRECORD=vINPUT.piece("|",1),vINPUT=vINPUT.extract(vRECORD.length()+2,99999) quit:vRECORD.isNull()  do {
 set TJD=vRECORD.piece($C(9),1)
 set CID=vRECORD.piece($C(9),2)
 do vPROC(TJD,CID)
 }
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vSCHEXEC(vINPUT,vRETURN) //
 type public String vBUFOVFL
 type String vRECORD,vrow,TJD,CID
 type Number vcur,vlen
 set vINPUT=vBUFOVFL.get()
 set vBUFOVFL="",vlen=0
 type public ResultSet vRESULT
 for  do { quit:'vcur
 set vcur=vRESULT.next() if 'vcur quit
 set vrow=vRESULT.getRow()_"|",vlen=vlen+vrow.length()
 if vlen>32767 set vBUFOVFL=vrow,vcur=0 quit
 set vINPUT=vINPUT_vrow if vlen+24>32767 set vcur=0 quit
 }
 set vINPUT=vINPUT.extract(1,vINPUT.length()-1)
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vSCHPOST(vINPUT,vRETURN) //
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
vOPEN(String vINPUT, Boolean %BatchExit) //
 
 #ACCEPT Date=08/01/03;PGM=Allan Mattson;CR=20967
 type public ResultSet vRESULT=Db.select("TJD,CID","DAYENDPVO","DAYENDPVO.TJD=:TJD")
 #ACCEPT Date=08/01/03;PGM=Allan Mattson;CR=20967
 if vRESULT.isEmpty() set %BatchExit=1 quit
 #ACCEPT Date=08/01/03;PGM=Allan Mattson;CR=20967
 set %BatchExit=0
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vTHRINIT(vINPUT,vRETURN) //
	do SOURCE^BCHSOURC("PVO","ALL",.%UserID,.BRCD,.%UserClass)

	/*
	TPD will equal the System Date unless TPD is defined in
	the Teller Proof Control file
	*/

	set TPD=%SystemDate
	type RecordTPCTRL tpctrl
	if Db.isDefined("TPCTRL","BRCD,%UserID,TPD") do {
		set tpctrl=Db.getRecord("TPCTRL","BRCD,%UserID,TPD")
		if tpctrl.pmdate'="" set TPD=tpctrl.pmdate
		}

 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vTHREXIT(vINPUT,vRETURN) //
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vSCHINIT(vINPUT,vRETURN) //
	do SOURCE^BCHSOURC("PVO","ALL",.%UserID,.BRCD,.%UserClass)
	if '%UserID set ER=1,RM=$$^MSG("4223") quit
	if ER set ET=RM do LOGERR quit

	do ^TTXLOK if ER S:'$G(ET) ET="TTXLOK" do LOGERR quit

 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
private vSCHEXIT(vINPUT,vRETURN) //
 #ACCEPT Date=07/15/03;PGM=Allan Mattson;CR=20967
 quit
vVERSION() // Compiler Version ID
 quit "V7-0.02"
