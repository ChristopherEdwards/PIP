EURBCUR	//

	/*
	ORIG: kumarss - 11/28/2005
	DESC: System Base Currency Conversion Driver

	---- Comments --------------------------------------------------------

	---- Revision History ------------------------------------------------

	11/28/05 - KumarSS - 16668
		   Converted to PSL.
		   Removed revision history prior to 2004
		   
	----------------------------------------------------------------------

	*/

	do NEW
	quit


NEW

	set %ProcessMode=0

	do INIT
	quit


INIT

	type public Number %PG,%PAGE

	type String OLNTB,VFMQ

	set %PG=0,%PAGE=1

	do VPG00
	quit


VPG00

	type public String %CRCD

	type String %NOPRMT,%READ,%TAB(),CRCDNEW,CRCDOLD,MSG,VFMQ

	set CRCDOLD=%CRCD.get()
	if CRCDOLD="" set CRCDOLD=CUVAR.%CRCD
	set CRCDNEW=CUVAR.EMUCRCD

	// Convert system base currency from ~p1 to ~p2
	set MSG=$$^MSG(3415,CRCDOLD,CRCDNEW)

	set %TAB(MSG)=MSG.get()
	set %READ="@@%FN,,,@MSG/CEN"
	set %NOPRMT="C"
	do ^UTLREAD
	if VFMQ="Q" quit

	set MSG=""
	set VFMQ=$$^DBSMBAR(161)

	do VER
	quit


ERR
	type public Boolean ER
	type String VFMQ

	set ER=1
	do ^UTLERR
	set VFMQ="Q"
	
	quit


	//-----------------------------------------------------------------------
VER	// Verification
	//-----------------------------------------------------------------------

	type public Number VFMQ

	if VFMQ=2 do END
	do FILE
	do END

	quit


	//-----------------------------------------------------------------------
FILE	// File data
	//-----------------------------------------------------------------------

	type public String CO,CRCDNEW,CRCDOLD,VFMQ

	type Boolean EMU,LIMPROC
	type Date TJD

	quit:VFMQ=2

	if CO.get()="" set CO=CUVAR.CO

	type RecordCRCD crcd=Db.getRecord("CRCD","CO=:CO,CRCD=:CRCDOLD")
	set EMU=crcd.emu

	// Conversion not permitted unless ~p1 is an IN currency
	if 'EMU do Runtime.setErrMSG("CRCD",3450,CRCDOLD) quit

	set TJD=CUVAR.TJD

	do ^EURBASE

	set TJD=CUVAR.TJD
	
	type RecordCUVAR cuvar=Db.getRecord("CUVAR")

	set cuvar.origcrcd=CRCDOLD		// Update the Institution Variables
	set cuvar.eurcnvdt=TJD
	set cuvar.%crcd=CRCDNEW			// Update system base currency with new currency

	do cuvar.save()

	// Include Limit Processing
	set LIMPROC=CUVAR.LIMPRO
	if LIMPROC do ^CNV53LIM 

	quit


	//-----------------------------------------------------------------------
END	// End of processing
	//-----------------------------------------------------------------------

	type public Number VFMQ
	type public String CRCDNEW,ER,RM

	quit:ER.get()
	quit:VFMQ=2

	// System base currency converted to ~p1
	set RM=$$^MSG(3430,CRCDNEW)
	set ER="W"

	quit

vSIG()	quit "60276^57726^Laura Hillanbrand^2419"	// Signature - LTD^TIME^USER^SIZE
