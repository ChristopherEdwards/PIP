CARDFIL0 // CRD DATA-QWIK filer, part (2)
 // Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 05/09/2007 16:33 - joynerd

	quit		// Not called from top

VJOURNAL(RecordCRD crd)	//CRD Journal file entries

	type Public Date %EffectiveDate
	type Public String %TSRC,vpar,vx()
	type String TSRC,vdi,vdx()

	if %TSRC.get().isNull() set TSRC="O"
	else  set TSRC=%TSRC

	if %ProcessMode=3 do {
		if TSRC="O" do {
			if EFD.get() do {
				do vj5(.crd)	// Mode=D Tran=O EFD=E Seq=1 JRNID=HIST_D
				}
			else  do {
				do vj2(.crd)	// Mode=D Tran=O EFD=N Seq=1 JRNID=CRDHIST_D
				do vj5(.crd)	// Mode=D Tran=O EFD=N Seq=1 JRNID=HIST_D
				}
			}
		}
	else  if %ProcessMode=0 do {
		if TSRC="O" do {
			if EFD.get() do {
				do vj6(.crd)	// Mode=I Tran=O EFD=E Seq=1 JRNID=HIST_I
				}
			else  do {
				do vj1(.crd)	// Mode=I Tran=O EFD=N Seq=1 JRNID=CMSRECCRD
				do vj3(.crd)	// Mode=I Tran=O EFD=N Seq=1 JRNID=CRDHIST_I
				do vj6(.crd)	// Mode=I Tran=O EFD=N Seq=1 JRNID=HIST_I
				}
			}
		}
	else  if %ProcessMode=1 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj4(.crd)	// Mode=U Tran=B EFD=N Seq=1 JRNID=CRDHIST_U
				}
			}
		else  if TSRC="O" do {
			if 'EFD.get() do {
				do vj1(.crd)	// Mode=U Tran=O EFD=N Seq=1 JRNID=CMSRECCRD
				do vj4(.crd)	// Mode=U Tran=O EFD=N Seq=1 JRNID=CRDHIST_U
				}
			}
		}

	quit


vj1(RecordCRD crd)	// CMSRECCRD  Table CMSRECCRD  Adds CMSREC entry for new/mod. card rec.

	type Public String %O
	type String vlastkey
	set vlastkey=Db.nextVal("CMSRECCRD","")
	type RecordCMSRECCRD cmsreccrd=Db.getRecord("CMSRECCRD","SEQ=:vlastkey",1)
	set cmsreccrd.acn=crd.acn
	set cmsreccrd.crdnum=crd.crdnum
	set cmsreccrd.crdtyp=crd.crdtyp
	set cmsreccrd.mode=%O

	do cmsreccrd.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj2(RecordCRD crd)	// CRDHIST_D  Table CRDHIST  Adds CRDHIST entry for deleted card rec.

	type Public String %UID,TJD,TLO
	type String v1,v2,vlastkey
	set v1=crd.crdtyp
	set v2=crd.crdnum
	set vlastkey=Db.nextVal("CRDHIST","CRDTYP=:v1,CRDNUM=:v2")
	type RecordCRDHIST crdhist=Db.getRecord("CRDHIST","CRDTYP=:v1,CRDNUM=:v2,HSEQ=:vlastkey",1)
	set crdhist.tcmt=$$^MSG(3028,"Card")
	set crdhist.time=$P($H,",",2)
	set crdhist.tjd=TJD
	set crdhist.tlo=TLO
	set crdhist.uid=%UID

	do crdhist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj3(RecordCRD crd)	// CRDHIST_I  Table CRDHIST  Adds CRDHIST entry for new card record

	type Public String %UID,TJD,TLO
	type String v1,v2,vlastkey
	set v1=crd.crdtyp
	set v2=crd.crdnum
	set vlastkey=Db.nextVal("CRDHIST","CRDTYP=:v1,CRDNUM=:v2")
	type RecordCRDHIST crdhist=Db.getRecord("CRDHIST","CRDTYP=:v1,CRDNUM=:v2,HSEQ=:vlastkey",1)
	set crdhist.tcmt=$$^MSG(6712,"Card")
	set crdhist.time=$P($H,",",2)
	set crdhist.tjd=TJD
	set crdhist.tlo=TLO
	set crdhist.uid=%UID

	do crdhist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj4(RecordCRD crd)	// CRDHIST_U  Table CRDHIST  Adds CRDHIST entry for a mod. card rec.

	type Public String vx()
	type String vdi

	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  do {
		type Public String vx(),%UID,TJD,TLO
		type String v1,v2,vlastkey

		type String vold,vnew

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)

		set v1=crd.crdtyp
		set v2=crd.crdnum
		set vlastkey=Db.nextVal("CRDHIST","CRDTYP=:v1,CRDNUM=:v2")
		type RecordCRDHIST crdhist=Db.getRecord("CRDHIST","CRDTYP=:v1,CRDNUM=:v2,HSEQ=:vlastkey",1)
		set crdhist.tcmt=$$TCMTFM^ACNFUNCS("","CRD",vdi,vold,vnew)
		set crdhist.time=$P($H,",",2)
		set crdhist.tjd=TJD
		set crdhist.tlo=TLO
		set crdhist.uid=%UID

		do crdhist.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit


vj5(RecordCRD crd)	// HIST_D  Table CIFH  Card Insert journal file

	type Public String %IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=crd.acn
	set vlastkey=Db.nextVal("CIFH","ACN=:v1")
	type RecordCIFH cifh=Db.getRecord("CIFH","ACN=:v1,SEQ=:vlastkey",1)
	set cifh.ident=%IDENT
	set cifh.tcmt=$$TCMT^CIFFUNCS("","CRD","CRDNUM",crd.crdtyp_"-"_crd.crdnum,$$^MSG(805))
	set cifh.tjd=TJD
	set cifh.tlo=TLO
	set cifh.uid=%UID

	do cifh.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj6(RecordCRD crd)	// HIST_I  Table CIFH  Card Insert journal file

	type Public String %IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=crd.acn
	set vlastkey=Db.nextVal("CIFH","ACN=:v1")
	type RecordCIFH cifh=Db.getRecord("CIFH","ACN=:v1,SEQ=:vlastkey",1)
	set cifh.ident=%IDENT
	set cifh.tcmt=$$TCMT^CIFFUNCS("","CRD","CRDNUM",crd.crdtyp_"-"_crd.crdnum,$$^MSG(7131))
	set cifh.tjd=TJD
	set cifh.tlo=TLO
	set cifh.uid=%UID

	do cifh.save("/NOVALFK/NOVALDD/NOVALRI")

	quit

