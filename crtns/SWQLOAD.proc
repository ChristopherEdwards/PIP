SWQLOAD	//Private;SWIFT Queue Loading
	/*
	   ORIG: YANGR - 04/04/94
	   DESC: SWIFT Queue Load

	   INPUTS:
	   . System

	   . Data [ddfile]di

	   . v1 desc of variable /TYP=T

	   RETURNS:
	   . XX desc of return  /TYP=T

	   EXAMPLE:
	   Text of example (line one)

	--- Revision History -------------------------------------------------

           07/26/05 - SkariahV- CR16679
	              Removed #WARN and #OPTIMIZE directives.
	              
	   05/28/03 - BHANGALEV - 51351
	   	      Converted to PSL	
	   
	-----------------------------------------------------------------------
	*/


Public Main	//
	/*
	  This is the SWIFT Queue Load Utility
	  1. Empty the FID's of the global SWIFTQ
	  2. According to fid SWIFT , rebuild the queue for
	     SWIFTQ("PND", SWIFTQ("REP", SWIFTQ("PRC"  (no TJD parameter)
	     SWIFTQ("RTT", SWIFTQ("CMP"   (with TJD parameter)

	*/
	
	type Public Number REFNO,STAT,TYPE
	type Public String ER,RM
	
	do Db.fastDelete("SWIFTQ1")
	do Db.fastDelete("SWIFTQ2")
	do Db.fastDelete("SWQCNT")
	do Db.fastDelete("SWQCNTD")
	
	//Now go through the file SWIFT 
	set (REFNO,TYPE,STAT)=""
	
	type DbSet rs=Db.selectDbSet("SWIFT","SWDIRECT='OUT'")
	while rs.next() do {
		type RecordSWIFT swift=rs.getRecord("SWIFT") 

		set REFNO=swift.trrefno
		set TYPE=swift.msg
		set STAT=swift.status
		
		//load SWIFTQ("RTT"),with TJD parameter
		if STAT=0 do LOADQDT(.swift,REFNO,TYPE)
			
		//load SWIFTQ("PND"),no TJD parameter
		if STAT=1 do LOADQ(REFNO,TYPE)
			
		//load SWIFTQ("REP"),no TJD parameter
		if STAT=2 do LOADQ(REFNO,TYPE)
			
		//load SWIFTQ("CMP"),with TJD parameter
		if STAT=3 do LOADQDT(.swift,REFNO,TYPE)
			
		//received messages
		if STAT=8 do LOADQDT(.swift,REFNO,TYPE)
		}

	// SWIFT queues have been rebuilt
	set ER="W"
	set RM=$$^MSG(7355)
	
	quit


LOADQDT(RecordSWIFT swift,Number REFNO,Number TYPE)	//

	/*
	  ARGUMENTS:
	  	. swift		SWIFT Object		/REQ/MECH=REF
	  	. REFNO		Reference Number	/REQ/MECH=VAL
	  	. TYPE		Message Type		/REQ/MECH=VAL
	  	
	  Load Global SWIFTQ with TJD according to global SWIFT("OUT",REFNO,TYPE,0)
	  Set TJD for above two queues
	  date for "CMP":$P($G(SWIFT("OUT",REFNO,TYPE,0)),"|",5)  Response Date
	  date for "RTT":$P($G(SWIFT("OUT",REFNO,TYPE,1)),"|",52) SWIFT date

	  Since we do not have data for SWIFT date yet, set it to response date TJD
	  S $P(SWIFT("OUT",REFNO,TYPE,1),"|",52)=$P(SWIFT("OUT",REFNO,TYPE,0),"|",5)

	*/
	
	type Public Number SEQ,STAT
	type Date DATE
	
	//build RTT queue
	if STAT=0 do {

		//swift date
		set DATE=swift.swftdt
		if DATE="" quit

		type RecordSWQCNTD swqcntd=Db.getRecord("SWQCNTD","QUE='RTT',DT=:DATE",1)
		set SEQ=swqcntd.nseq+1
		
		/* 
		   set the last sequence, total record, and
		   total processed today.
		*/
		set swqcntd.nseq=SEQ
		set swqcntd.tot=SEQ
		set swqcntd.ptoday=0
		
		do swqcntd.bypassSave()
		
		type RecordSWIFTQ1 swiftq1=Db.getRecord("SWIFTQ1","QUE='RTT',DT=:DATE,SEQ=:SEQ,TRREFNO=:REFNO,TYPE=:TYPE",1)
		do swiftq1.bypassSave()
		
		}

	//build CMP queue
	if STAT=3 do {
		
		set DATE=swift.date
		type RecordSWQCNTD swqcntd=Db.getRecord("SWQCNTD","QUE='CMP',DT=:DATE",1)
		set SEQ=swqcntd.nseq+1
		
		/* 
		   set the last sequence, total record, and
		   total processed today.
		*/
		set swqcntd.nseq=SEQ
		set swqcntd.tot=SEQ
		set swqcntd.ptoday=SEQ
		
		do swqcntd.bypassSave()
		
		type RecordSWIFTQ1 swiftq1=Db.getRecord("SWIFTQ1","QUE='CMP',DT=:DATE,SEQ=:SEQ,TRREFNO=:REFNO,TYPE=:TYPE",1)
		do swiftq1.bypassSave()
		
		}

	// build TLX queue
	if STAT=7 do {
		
		set DATE=swift.swftdt
		type RecordSWQCNTD swqcntd=Db.getRecord("SWQCNTD","QUE='TLX',DT=:DATE",1)
		set SEQ=swqcntd.nseq+1
		
		/* 
		   set the last sequence, total record, and
		   total processed today.
		*/
		set swqcntd.nseq=SEQ
		set swqcntd.tot=SEQ
		set swqcntd.ptoday=SEQ
		
		do swqcntd.bypassSave()
		
		type RecordSWIFTQ1 swiftq1=Db.getRecord("SWIFTQ1","QUE='TLX',DT=:DATE,SEQ=:SEQ,TRREFNO=:REFNO,TYPE=:TYPE",1)
		do swiftq1.bypassSave()
		}

	// build REC queue
	if STAT=8 do {
		
		set DATE=swift.swftdt
		type RecordSWQCNTD swqcntd=Db.getRecord("SWQCNTD","QUE='REC',DT=:DATE",1)
		set SEQ=swqcntd.nseq+1
		
		/* 
		   set the last sequence, total record, and
		   total processed today.
		*/
		set swqcntd.nseq=SEQ
		set swqcntd.tot=SEQ
		set swqcntd.ptoday=SEQ
		
		do swqcntd.bypassSave()
		
		type RecordSWIFTQ1 swiftq1=Db.getRecord("SWIFTQ1","QUE='REC',DT=:DATE,SEQ=:SEQ,TRREFNO=:REFNO,TYPE=:TYPE",1)
		do swiftq1.bypassSave()
		
		}
	quit


LOADQ(Number REFNO,Number TYPE)	//
	
	/*
	  ARGUMENTS:
	  	. REFNO		Reference Number	/REQ/MECH=VAL
	  	. TYPE		Message Type		/REQ/MECH=VAL
	*/
		  	
	type Public Number SEQ,STAT
	
	//Load Global SWIFTQ according to global SWIFT("OUT",REFNO,TYPE,0)

	if STAT=1 do {
		
		type ResultSet rs=Db.select("SEQ","SWIFTQ2","QUE='PND'","SEQ DESC")
		if rs.next() set SEQ=rs.getCol("SEQ")+1
	
		type RecordSWQCNT swqcnt=Db.getRecord("SWQCNT","QUE='PND'",1)
					
		/* 
		   set the last sequence, total record, and
		   total processed today.
		*/
		set swqcnt.nseq=SEQ    
		set swqcnt.tot=SEQ
		set swqcnt.ptoday=0
			
		do swqcnt.bypassSave()
		
		//build PND queue
		type RecordSWIFTQ2 swiftq2=Db.getRecord("SWIFTQ2","QUE='PND',SEQ=:SEQ,TRREFNO=:REFNO,TYPE=:TYPE",1)
		do swiftq2.bypassSave()
		
		}

	if STAT=2 do {
	
		type ResultSet rs=Db.select("SEQ","SWIFTQ2","QUE='REP'","SEQ DESC")
		if rs.next() set SEQ=rs.getCol("SEQ")+1
		
		type RecordSWQCNT swqcnt=Db.getRecord("SWQCNT","QUE='REP'",1)
					
		/* 
		   set the last sequence, total record, and
		   total processed today.
		*/
		set swqcnt.nseq=SEQ
		set swqcnt.tot=SEQ
		set swqcnt.ptoday=0
			
		do swqcnt.bypassSave()
		
		//build REP queue
		type RecordSWIFTQ2 swiftq2=Db.getRecord("SWIFTQ2","QUE='REP',SEQ=:SEQ,TRREFNO=:REFNO,TYPE=:TYPE",1)
		do swiftq2.bypassSave()
		}

	quit

vSIG()	quit "60107^27461^Viji Skariah^5547"	// Signature - LTD^TIME^USER^SIZE
