CRCDMG  //CRCD;PBS -  - V5.0 - Currency Margins
        /*
 
               ORIG: Frank R. Sanchez (2497)
 
        ------- Revision History------------------------------------------------
        09/02/02 - SRIVASTAVAN - 49451
                   Converted to PSL
	------------------------------------------------------------------------ 
        */
 
UPD     //

        do INIT(1) 

	quit

 
INQ     //

        do INIT(2) 

	quit

 
INIT(%ProcessMode)      //

	new OLNTB,VFMQ

	type RecordCRCDMG fCRCDMG
        type RecordCRCD fCRCD

	set CO=%CompanyName

	#if 'CUVAR.%mcp
	do { quit
		set ER=1
		set ET="MCPNE" 

		do ^UTLERR 
		}
	#endif
	 	
        set %PG=0
        set %PAGE=1

	do VPG(.fCRCDMG,.fCRCD)

        quit

 
VPG(RecordCRCDMG fCRCDMG,RecordCRCD fCRCD)     // Page control

	new FINISH
        set FINISH=0
        for  do { quit:FINISH
                if %PG=0 do VPG00 if ER set FINISH=1 quit
                if %PG>0 do VPG01(.fCRCDMG,.fCRCD)
                if "DFQ"[VFMQ do VER(.fCRCDMG) set FINISH=1 quit
                set %PG=%PG+1
                }
        quit
 
 
VPG00   // Set up

        set %TAB("CO")=".CO2/HLP=[CRCD]CO/TBL=[CRCD]CO:DISTINCT"
	set %TAB("CRCD")=".CRCD1/HLP=[CRCD]CRCD/TBL=[CRCD]:QU ""[CRCD]CO=<<CO>>""/XPP=D EURCHK^CRCDMG"
	set %TAB("CUSTCD")=".CUSTCD1/TBL=[UTBLCC]"
	set OLNTB="0038"
        set %READ="@@%FN,,,CO/REQ,CRCD/REQ,CUSTCD/REQ"

        do ^UTLREAD
 	
	if VFMQ="Q" set ER=1 

       	quit


VPG01(RecordCRCDMG fCRCDMG,RecordCRCD fCRCD)   // Currency Margin Screen

        set fCRCD=Db.getRecord("CRCD","CO=:CO,CRCD=:CRCD")
	set fCRCDMG=Db.getRecord("CRCDMG","CO=:CO,CRCD=:CRCD,CUSTCD=:CUSTCD",1)

        set DELETE=0
       
	do DRV^USID(%ProcessMode,"CRCDMG",.fCRCDMG,.fCRCD)

        do VER(.fCRCDMG)

        quit
 
 
VER(RecordCRCDMG fCRCDMG)     //

        if %ProcessMode=2!(%ProcessMode=4)!(VFMQ="Q") do END quit

        if DELETE new %ProcessMode set %ProcessMode=3
 
        do FILE(.fCRCDMG)
 
        do END
 
        quit
 
 
FILE(RecordCRCDMG fCRCDMG)    // File data

        set %EffectiveDate=%SystemDate

        if %ProcessMode=3 do {
                do Db.delete("CRCDMG","CO=:CO AND CRCD=:CRCD AND CUSTCD=:CUSTCD")
                }
        else  do fCRCDMG.save()

        quit
 
 
END     // Exit

	if ER!(%ProcessMode=2)!(%ProcessMode=4) quit

        set CRCD=$G(CRCD)
 
        // Margins for currency code ~p1 not modified
        if VFMQ="Q" set RM=$$^MSG(1668,CRCD)
 
        // Margins for currency code ~p1 modified
        else  set RM=$$^MSG(1667,CRCD)
        set ER="W"
        quit
 
 
EURCHK  // Currency Code Post Processor
 
	type RecordCRCD crcd=Db.getRecord("CRCD","CO=:CO,CRCD=:X",1)
	if crcd.getMode()=0 do { quit
		set ER=1
		set RM=$$^MSG(1293)
		}
 
	//Invalid function for IN currency
	if crcd.emu=1 do {
		set ER=1
		set RM=$$^MSG(3230)
		}
	quit 
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43499^Sanchez SCM Administrator^2670"	// Signature - LTD^TIME^USER^SIZE
