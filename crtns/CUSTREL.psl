CUSTREL	  /*
ORIG: VETSENM - 05/01/2001
DESC: Assign Customer Relationship Status Code

---- Comments --------------------------------------------------------
  This procedure will automatically assign a Customer Relationship Status to
  a customer.
---- Revision History ------------------------------------------------

     06/05/07 - MBUIM - CR 26661
     		Modified C1 section to replace Db.update with getRecord and
     		.save() methods, as the status was not filing.
     		Also updated procedure with PSL Standards.
     		Removed old Revision History
	
     12/04/03 - CARROLLJ - CR7239
		Modified C1 section to pass correct parameteres to UINDX.
                  
 */
	type Number ACN , STATUS
	type String MATRIX
	
	type ResultSet rsa=Db.select("ACN,RELMAT","CIF")
	if rsa.isEmpty() quit
        while rsa.next() do {
                set ACN=rsa.getCol(1)
                set MATRIX=rsa.getCol(2)
		if MATRIX="" quit 
		else  do C1(ACN,MATRIX)
		}
	quit
	
C1(ACN,MATRIX) //Define the customer status and update customer 
	       //record with new value.
	       
	type Number CID,FNDCID(),SEQ,STATUS
	
	set SEQ="" 
	type ResultSet data=Db.select("CID","RELCIF","ACN=:ACN")
	if data.isEmpty() quit 
	while data.next() do {
		set SEQ=SEQ+1
		set CID=data.getCol(1)
		set FNDCID(SEQ)=CID
	}
	set CID=FNDCID(1)
	type RecordACN acn=Db.getRecord("ACN","CID=:CID")
	set STATUS=$$STATUS^UINDX(.acn,MATRIX)
	set STATUS=$G(STATUS)

	//Update CIF record with the new customer status
	type RecordCIF cif = Db.getRecord("CIF","ACN=:ACN")
	set cif.relcode = STATUS
	
	do cif.save()           

	quit

STATUS(ACN) //Customer Relationship Status Code
        /*
           The function is used to populate [LN]RELCODE, [DEP]RELCODE and
           [ACN]RELCODE fields and to build strings to import into datawindows.
 
           ARGUMENT:
 
           . ACN                   Customer Number /TYP=N/REQ/MECH=VAL 
 
           RETURNS:
           Customer Relationship Status Code
 
           EXAMPLE:
           W $$STATUS^CUSTREL(100)
        */
	 type Number STATUS, XSTATUS

	 /* 
	    Check if customer status should be overridden. If Customer 
	    Relationship Status Code Override field in not null set STATUS 
	    equal to this value, if this field is not defined set 
            customer status as existing Customer Relationship Status Code. 
	*/

	 type RecordCIF cif = Db.getRecord("CIF","ACN=:ACN")
	 
	 set XSTATUS = cif.relcode 
	
	 if cif.relcodovr'="" set STATUS = cif.relcodovr
	 else  set STATUS = XSTATUS.get()

	 quit STATUS	
		
 #OPTION ResultClass ON
Public String vSIG()	quit "60788^47174^Marie Mbui^2447"	// Signature - LTD^TIME^USER^SIZE
