GCRMDR /* DESC: Maintain daily scoring user tabl

	---- Revision History ------------------------------------------------

          09/24/02 - DATTAR - 49451
     	             Converted to PSL

 	----------------------------------------------------------------------
  	*/


NEW	//

	do INIT(0) 
	quit
	

UPD	//

	do INIT(1) 
	quit	


INQ	//

	do INIT(2) 
	quit


DEL	//

	do INIT(3) 
	quit
	

INIT(%ProcessMode) //

	new OLNTB,VFMQ
	set (%SVPG,%PG,PG,RPT)=0
	set %PAGE=2
	type RecordUTBLGCRBALT fUTBLGCT

	do VPG(.fUTBLGCT)

	quit


VPG(RecordUTBLGCRBALT fUTBLGCT) //Page control

	new FINISH
	set FINISH=0
	for  do { quit:FINISH
		set %SVPG=%PG
		if %PG=0 do VPG00 if VFMQ="Q" set FINISH=1 quit

		if %PG=1 do VPG01(.fUTBLGCT) if VFMQ="Q" set FINISH=1 quit

		if %PG>1 do VPG02 if VFMQ="Q" set FINISH=1 quit

	 	if "DFQ"[VFMQ do VER(.fUTBLGCT) set FINISH=1 quit

		// Advance screen
		if VFMQ=%SVPG set %PG=$P(%PG+1,".",1)

		// Previous screen
		else  do {
			set %PG=$P(%SVPG-1,".",1)
			set PG=PG-2
			}

		}
	quit


VPG00   //Set up

	if %ProcessMode=0 set %TAB("TBLNM")="[UTBLGCRBAL]TBLNM/XPP=do TBL^GCRMDR(X)"
	else  do {
		set %TAB("TBLNM")="[UTBLGCRBALT]TBLNM/TBL=[UTBLGCRBALT]"
		if %ProcessMode=2 set %TAB("IO")=$$IO^SCATAB($I)
		}

	set %READ="@@%FN,,,TBLNM/REQ" 
	set %NOPRMT="N"
	if %ProcessMode=2 set %READ=%READ_",IO/REQ"

	do ^UTLREAD 

	if VFMQ="Q" quit 

	if %ProcessMode do {
		do LOADDATA(TBLNM)

		// Set %PAGE to include number of existing entries
		new %MODS
		set %MODS=1

		do RPTS
		set RP=$P((RPT/16)+1,".",1)+1

		if %PAGE<RP set %PAGE=RP
		}
	quit

	
TBL(TBLNM) //

	type ResultSet rs=Db.select("TBLNM","UTBLGCRBAL","TBLNM=:TBLNM")
	if '%ProcessMode,'rs.isEmpty() set ET="RECOF" do ERR
	quit 
	
	
LOADDATA(TBLNM) // Load GCR Monthly Scoring data into GCRBAL and GCRMTHLY arrays
	
	/*
	   Position: for GCRMBAL(SEQ)=1-Minimum Average Liability Balance
	                              2-Gcr Coverage
	                              3-Same Day Coverage
	
	          GCRMTHLY(SEQ)=1-Account age
	                              2-Max Overdraft Number GCR code 9
	                              3-Max Overdraft Number GCR code 8
	                              4-Max Overdraft Number GCR code 7
	                              5-Max Overdraft Number GCR code 6
	                              6-Max Overdraft Number GCR code 5
	                              7-Max Overdraft Number GCR code 4
	                              8-Max Overdraft Number GCR code 3
	                              9-Max Overdraft Number GCR code 2
	                             10-Max Overdraft Number GCR code 1
	                             11-Max Overdraft Number GCR code 0
		
	   Load GCRBAL(GCRCODE) array
	*/

	new ARRAY,GCRCD,GCRCODE,GCRCVR,GCRSDAY,LIABBAL,MINAGE,ODNBR,SEQ

	do OLDGCRB(TBLNM)

	set GCRCODE="" 
	for  set GCRCODE=$O(OLDGCRB(GCRCODE),-1) quit:GCRCODE=""  do {
		set LIABBAL=$P(OLDGCRB(GCRCODE),"|",1)
		set GCRCVR=$P(OLDGCRB(GCRCODE),"|",2)
		set GCRSDAY=$P(OLDGCRB(GCRCODE),"|",3)
		set GCRBAL(GCRCODE)=LIABBAL_"|"_GCRCVR_"|"_GCRSDAY
		}

	// Load GCRMTHLY array
	do OLDGCRM(TBLNM)

	set ARRAY=0
	set SEQ="" 
	for  set SEQ=$O(OLDGCRM(SEQ)) quit:SEQ=""  do {
		set GCRCD="" 
		for  set GCRCD=$O(OLDGCRM(SEQ,GCRCD)) quit:GCRCD=""  do {
			set ODNBR(GCRCD)=OLDGCRM(SEQ,GCRCD)
			}
		set ARRAY=ARRAY+1
		set GCRMTHLY(ARRAY)=SEQ_"|"_ODNBR(9)_"|"_ODNBR(8)_"|"_ODNBR(7)_"|"_ODNBR(6)_"|"_ODNBR(5)
		set GCRMTHLY(ARRAY)=GCRMTHLY(ARRAY)_"|"_ODNBR(4)_"|"_ODNBR(3)_"|"_ODNBR(2)_"|"_ODNBR(1)_"|"_ODNBR(0)
		}
	quit 
	
	
OLDGCRB(TBLNM) // Return GCR Monthly Scoring from TBLNM create OLDGCRCB array

	kill OLDGCRB
	type ResultSet rs=Db.select("GCRCD,GCRLBAL,GCRCV,SDDEPCVR","UTBLGCRBAL","TBLNM=:TBLNM")
        while rs.next() set OLDGCRB(rs.getCol(1))=rs.getCol(2)_"|"_rs.getCol(3)_"|"_rs.getCol(4)
	quit	
	

OLDGCRM(TBLNM) // Return GCR Monthly Scoring from TBLNM create OLDGCRCM array
	
	kill OLDGCRM
        type ResultSet rs=Db.select("MINAGE,GCRCD,MAXODNBR","UTBLGCROD","TBLNM=:TBLNM")
	while rs.next() set OLDGCRM(rs.getCol(1),rs.getCol(2))=rs.getCol(3)
        quit	

	
VPG01(RecordUTBLGCRBALT fUTBLGCT) //Screen

	set fUTBLGCT=Db.getRecord("UTBLGCRBALT","TBLNM=:TBLNM",1)
	do DRV^USID(%ProcessMode,"GCRBAL",.fUTBLGCT)

	quit 
	
	
RPTS	// Set pages needed by setting RPT equal to the entries in the GCRMONTHLIY
	/*
	   array plus one.  So if 16 arrays are filled and 1 more is added then
	   the first screen will repeat for additional members to be added or
	   viewed.
	
	*/
	for I=%MODS:1 quit:'$D(GCRMTHLY(I))  do {
	
		// Change logical (0) to null for compare
		if $$RTBAR^%ZFUNC(GCRMTHLY(I))="" quit 

		set RPT=I
		}
	set RPT=RPT+1
	quit 
	
	
VPG02	// Second screen
	
	new %MODS
	if PG<0 set PG=0

	if %SVPG>VFMQ set VFMQ=%SVPG
	else  set VFMQ=$P(%SVPG-1,".",1)

	set %REPEAT=16 
	set %MODS=PG*%REPEAT+1
	
	do RPTS
	set RP=$P((RPT/%REPEAT)+1,".",1)+1
	if %PAGE<RP set %PAGE=RP

	do DRV^USID(%ProcessMode,"GCRMOD")

	if VFMQ="Q"!(VFMQ="F") quit 
	set PG=PG+1
	quit 
	
	
ERR	//

	set ER=1 

	do DSPBP^UTLERR

	set VFMQ="Q"
	quit 
	
	
VER(RecordUTBLGCRBALT fUTBLGCT)

	if %ProcessMode=0!(%ProcessMode=3) do { quit:VFMQ="Q"

		do CRTGCRBL(.fUTBLGCT) 

		if ER set VFMQ="Q" 
		}

	if %ProcessMode=0!(%ProcessMode=3) do { quit:VFMQ="Q"

		do CRTGCROD

		if ER set VFMQ="Q" 
		}

	if %ProcessMode=1 do { quit:VFMQ="Q"

		do UPDGCRBL(.fUTBLGCT)

		if ER set VFMQ="Q"
		}

	if %ProcessMode=1 do { quit:VFMQ="Q"

		do UPDGCROD

		if ER set VFMQ="Q" 
		}

	do END 
	quit
	
	
CRTGCRBL(RecordUTBLGCRBALT fUTBLGCT) // GCR Monthly Scoring Balance array fUTBLGCB
	
	/*
	
		   Position: for GCRBAL(GCRCD)=1-Liability Balance
	           2-GCR Coverage
	           3-Same Day Deposit
		
	*/
	new fUTBLGCB,GCRCD,SEQ
	do fUTBLGCT.save()
	set GCRCD="" for  set GCRCD=$O(GCRBAL(GCRCD),-1) quit:GCRCD=""  do {
		type RecordUTBLGCRBAL fUTBLGCB=Class.new("RecordUTBLGCRBAL")
		set fUTBLGCB.tblnm=TBLNM
		set fUTBLGCB.gcrcd=GCRCD
		set fUTBLGCB.gcrlbal=$P(GCRBAL(GCRCD),"|",1)
		set fUTBLGCB.sddepcvr=$P(GCRBAL(GCRCD),"|",3)
		set fUTBLGCB.gcrcv=$P(GCRBAL(GCRCD),"|",2)
		do fUTBLGCB.save()
		}
	quit 
	
	
CRTGCROD // GCR Mothly Scoring Overdraft Number array fUTBLGCO
	
	/*
	   Position: for GCRMTHLY =  1-Account age
	                             2-Max Overdraft Number GCR code 9
	         3-Max Overdraft Number GCR code 8
	                             4-Max Overdraft Number GCR code 7
	                             5-Max Overdraft Number GCR code 6
	                             6-Max Overdraft Number GCR code 5
	                             7-Max Overdraft Number GCR code 4
	                             8-Max Overdraft Number GCR code 3
	                             9-Max Overdraft Number GCR code 2
	                            10-Max Overdraft Number GCR code 1
	                            11-Max Overdraft Number GCR code 0
	
	
	*/
	new GCRCD,MINAGE
	set SEQ="" 
	for  set SEQ=$O(GCRMTHLY(SEQ)) quit:SEQ=""  do {
		set MINAGE=$P(GCRMTHLY(SEQ),"|",1) quit:MINAGE="" 
		set I="" 
		set Y=2
		for I=9:-1:0 do {
			set MAXODNBR=$P(GCRMTHLY(SEQ),"|",Y)
			set GCRCD=I
			set Y=Y+1
			type RecordUTBLGCROD fUTBLGCO=Class.new("RecordUTBLGCROD")
			set fUTBLGCO.tblnm=TBLNM
			set fUTBLGCO.minage=MINAGE
			set fUTBLGCO.gcrcd=GCRCD
			set fUTBLGCO.maxodnbr=MAXODNBR
			do fUTBLGCO.save()
			}
		}
	quit 
	
	
UPDGCRBL(RecordUTBLGCRBALT fUTBLGCT) // GCR Monthly Scoring Balance array fUTBLGCB
	
	/*
	   Position: for GCRBAL(GCRCD)=1-Liability Balance
	                               2-GCR Coverage
	                               3-Same Day Deposit
	
	
	   Updates and insert
	*/
	new GCRCD

	do fUTBLGCT.save()

	set GCRCD="" 
	for  set GCRCD=$O(GCRBAL(GCRCD),-1) quit:GCRCD=""  quit:ER  do {
		type RecordUTBLGCRBAL fUTBLGCB=Db.getRecord("UTBLGCRBAL","TBLNM=:TBLNM,GCRCD=:GCRCD",1)		
		do fUTBLGCB.setAuditFlag(1)
		set fUTBLGCB.gcrlbal=$P(GCRBAL(GCRCD),"|",1)
		set fUTBLGCB.sddepcvr=$P(GCRBAL(GCRCD),"|",3)
		set fUTBLGCB.gcrcv=$P(GCRBAL(GCRCD),"|",2)
		do fUTBLGCB.save()
		kill OLDGCRB(GCRCD)
		}
			
	set GCRCD="" 
	for  set GCRCD=$O(OLDGCRB(GCRCD)) quit:GCRCD=""  quit:ER  do {
		do Db.delete("UTBLGCRBAL","TBLNM=:TBLNM AND GCRCD=:GCRCD")		
		}
	quit 
	
	
UPDGCROD // GCR Monthly Scoring Overdraft Number array fUTBLGCO
	
	/*
	   Position: for GCRMTHLY =  1-Account age
	                             2-Max Overdraft Number GCR code 9
	                             3-Max Overdraft Number GCR code 8
	                             4-Max Overdraft Number GCR code 7
	                             5-Max Overdraft Number GCR code 6
	                             6-Max Overdraft Number GCR code 5
	                             7-Max Overdraft Number GCR code 4
	                             8-Max Overdraft Number GCR code 3
	                             9-Max Overdraft Number GCR code 2
	                            10-Max Overdraft Number GCR code 1
	                            11-Max Overdraft Number GCR code 0
	
	
	   Updates and insert
	*/
	new SEQ,GCRCD,AGE,DELAGE
	set SEQ="" 
	for  set SEQ=$O(GCRMTHLY(SEQ)) quit:SEQ=""  quit:ER  do {
		set MINAGE=$P(GCRMTHLY(SEQ),"|",1)
		if MINAGE="" quit
		set Y=2 
		for I=9:-1:0 do {
			set MAXODNBR=$P(GCRMTHLY(SEQ),"|",Y)
			set GCRCD=I
			set Y=Y+1
	
			type RecordUTBLGCROD fUTBLGCO=Db.getRecord("UTBLGCROD","TBLNM=:TBLNM,MINAGE=:MINAGE,GCRCD=:GCRCD",1)
			set fUTBLGCO.tblnm=TBLNM
			set fUTBLGCO.minage=MINAGE
			set fUTBLGCO.gcrcd=GCRCD
			set fUTBLGCO.maxodnbr=MAXODNBR
			do fUTBLGCO.save()
			}
	
		kill OLDGCRM(MINAGE)		
		}
	
	set OLDAGE="" 
	for  set OLDAGE=$O(OLDGCRM(OLDAGE)) quit:OLDAGE=""  quit:ER  do {
		do Db.delete("UTBLGCROD","TBLNM=:TBLNM AND MINAGE=:OLDAGE")
		}
	quit 
	

END	//
	if $G(ER)!(%ProcessMode=2)!(%ProcessMode=4) quit
	
	if VFMQ="Q" do {
		// Record not created
		if %ProcessMode=0 set RM=$$^MSG(6709,TBLNM) quit    

		// Record not modified
		if %ProcessMode=1 set RM=$$^MSG(6710,TBLNM) quit   

		// Record not deleted
		set RM=$$^MSG(6711,TBLNM)           
		}
	else  do {
		// Record created
		if %ProcessMode=0 set RM=$$^MSG(6712,TBLNM) quit    

		// Record modified
		if %ProcessMode=1 set RM=$$^MSG(6713,TBLNM) quit 

		// Record deleted
		set RM=$$^MSG(3028,TBLNM)           
		}
	set ER="W"
		
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43518^Sanchez SCM Administrator^9713"	// Signature - LTD^TIME^USER^SIZE
