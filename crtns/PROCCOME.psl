PROCCOME		/*
	---- Revision History ------------------------------------------------

	07/19/99 - DOUGANM - 33890
                Converted M code to PSL.	
	
	07/16/99 - ARPAV - 33860:002
		Newing all variables used to ensure that correct
		adjustment amounts will be processed.
	
	----------------------------------------------------------------------
	*/

	quit

CALC(AGENT,PLAN,CID,DATE)	
	/*

	Gets the plan and agent then calls COMCID to calculate
	the new commisions, then updates DAYEND with the new amount.
	
	*/

	new EFD,PSTDT,SEQUENCE,MAN,DATA,METHOD,FRE,RETVAL,AGENCY,SQLSEQ
	new ADJAMT,DIFFAGNT,DIFFAGCY,ACCUMAMT,ADJAGNCY         
	
	set SQLSEQ=""
	
	// Get the agency number
	set AGENCY=Db.getOneRow("AGNUM","AGENT","AGENT")
	
	// Get all commission dates for plan and account
	new rs 
	type ResultSet rs=Db.select("PSTDT,SEQ,MAN","DAYENDCOMPST","PSTDT>:DATE AND AGENT=:AGENT AND CID=:CID AND CPLAN=:PLAN AND MAN<>1") 
	if 'rs.isEmpty() while rs.next()  do { 
		set RETVAL=rs.getRow() 
		set PSTDT=$P(RETVAL,$C(9),1)
		set SEQUENCE=$P(RETVAL,$C(9),2)
		set MAN=$P(RETVAL,$C(9),3)
		// Get method and frequency for plan
		set DATA=Db.getOneRow("AMTH,CALCFRE","UTBLCOMPLN","PLAN")
		set METHOD=$P(DATA,$C(9),1)
		set FRE=$P(DATA,$C(9),2)
		if METHOD=1 do {
			new INTEREST,RATE,RETDATA,AGNRATE,AGNIND
			set RETDATA=Db.getOneRow("AMT,CRCD,RATE,INDEX,POSTED,AGNCYAMT","DAYENDCOMPST","PSTDT,AGENT,PLAN,CID,SEQUENCE")
			set AMT=$P(RETDATA,$C(9),1)
			set CRCD=$P(RETDATA,$C(9),2)
			set RATE=$P(RETDATA,$C(9),3)
			set INDEX=$P(RETDATA,$C(9),4)
			set POSTED=$P(RETDATA,$C(9),5)
			set AGNCYAMT=$P(RETDATA,$C(9),6)
			set NEWAMT=$$EXT^COMCID(PLAN,CID,AGENT,PSTDT,.INTEREST,.RATE,.AGNIND,.AGNRATE)
			set PREVAGNT=$G(PREVAMT)+$P(NEWAMT,"|",1)
			set PREVAGCY=$G(PREVAGCY)+$P(NEWAMT,"|",2)
			set ADJAMT=($P(NEWAMT,"|",1)-AMT)+$G(ADJAMT)
			set ADJAGNCY=($P(NEWAMT,"|",2)-AGNCYAMT)+$G(ADJAGNCY)
			if ('ADJAMT),('ADJAGNCY) quit 
			set EFD=$$NJD^UFRE(%SystemDate,FRE) quit:ER 
			set OFF=Db.getOneRow("POSTOFF","UTBLCOMPLN","PLAN")
			set EFD=EFD+OFF
			}
		}
	
	if $G(METHOD)'=1 quit ""
	set DIFFAGNT=0                         
	set DIFFAGCY=0                        

	// Calculate accumulation of agent adjustments
	new rs 
	type ResultSet rs=Db.select("ADJAMT","DAYENDCOMADJ","PSTDT>:DATE AND AGENT=:AGENT AND CID=:CID AND CPLAN=:PLAN AND EFD IS NOT NULL") 
	if 'rs.isEmpty() while rs.next()  do { 
		set RETVAL=rs.getRow() 
		set ACCUMAMT=$G(ACCUMAMT)+RETVAL
		}

	set DIFFAGNT=ADJAMT-ACCUMAMT
	
	set ACCUMAMT=0
	if AGENCY'="" do {
		// Calculate accumulation of agency adjustments
		new rs 
		type ResultSet rs=Db.select("ADJAMT","DAYENDCOMADJ","PSTDT>:DATE AND AGENT=:AGENCY AND CID=:CID AND CPLAN=:PLAN AND EFD IS NOT NULL") 
		if 'rs.isEmpty() while rs.next()  do { 
	       		set RETVAL=rs.getRow() 
			set ACCUMAMT=$G(ACCUMAMT)+RETVAL
			}
		set DIFFAGCY=ADJAGNCY-ACCUMAMT
		}
	
	quit DIFFAGNT_"|"_DIFFAGCY
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43498^Sanchez SCM Administrator^2823"	// Signature - LTD^TIME^USER^SIZE
