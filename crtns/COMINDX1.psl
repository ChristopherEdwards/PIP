COMINDX1 // Commission Index -  Screen Driver
	  /*
 
               ORIG: Vince Arpa  6/22/98
               INIT:
               DESC:
 
          ---- Revision History---------------------------------------
         08/05/02 - SRIVASTAVAN - 49451
                    Converted to PSL
 
         01/25/01 - STATTOND - 43390
                    Added code in VPG01 to call the new screen,
                    UTBLCOMINDX3.
	  ------------------------------------------------------------- 
          */
 
NEW     //

	do INIT(0) 
	quit

 
UPD     //

	do INIT(1) 
	quit

 
INQ     //

	do INIT(2) 
	quit

 
DEL     //

	do INIT(3)
	quit

 
INIT(%ProcessMode)	//
	
	new CNT,COMTYPE,DUP,ERFLAG,MAX,OLNTB,VFMQ

	set %PG=0
	set %PAGE=1
	set OPT=%ProcessMode
	set ANT=0
	set DFT=0
	set MAX=13

	do VPG
	quit

 
VPG	// Page control

	new FINISH

	type RecordUTBLCOMINDX fCOMINDX	

	set FINISH=0
	for  do { quit:FINISH
		if %PG=0 do VPG00(.fCOMINDX) if ER set FINISH=1 quit
		if %PG>0 do VPG01(.fCOMINDX)
		if "DFQ"[VFMQ do VER set FINISH=1 quit
		set %PG=%PG+1		
		}
	quit

 
VPG00(RecordUTBLCOMINDX fCOMINDX)   // Set up screen for Commission Index and effective date

	set %TAB("CINDEX")="[UTBLCOMINDX]CINDEX/HLP=[UTBLCOMINDX]CINDEX/TBL=[UTBLCOMINDX]"
	set %TAB("EFD")=".EFD1/TBL=[UTBLCOMINDX1]EFD:DISTINCT:QU ""[UTBLCOMINDX1]CINDEX=<<CINDEX>>""/XPP=D POEFD^COMINDX1"
	if %ProcessMode=2 set %TAB("IO")=$$IO^SCATAB($I)
 
	set %READ="@@%FN,,,CINDEX/REQ/,EFD/REQ" 
	set %NOPRMT="F"
 
	if %ProcessMode=2 set %READ=%READ_",,IO/REQ"
 
	do ^UTLREAD 
	
	if VFMQ="Q" set ER=1 quit

	if %ProcessMode=2,IO'=$I do OPEN^SCAIO
	
	set fCOMINDX=Db.getRecord("UTBLCOMINDX","CINDEX=:CINDEX") 

	// Load index into array
	do LOADI

	if %ProcessMode=2 set %PAGE=CNT\MAX+1
	quit
 
 
VPG01(RecordUTBLCOMINDX fCOMINDX)   // Screen Set Up for data entry
 
	new %MODS,%REPEAT,A,BASREL,COMTYPE

	// Commission Type
	set COMTYPE=fCOMINDX.comtype

	// Always a full page in modify or insert mode
	set %REPEAT=MAX
	set %MODS=(MAX*(%PG-1))+1
 
	if COMTYPE=0 set SID="UTBLCOMINDX1"
	if COMTYPE=1 set SID="UTBLCOMINDX2"
	if COMTYPE=2 set SID="UTBLCOMINDX3"

	do DRV^USID(%ProcessMode,SID,.fCOMINDX) 
	
	quit
 

LOADI   // Load rate array for screen from current most index

	new DATE,I,SEQ
	set SEQ=1
	set RATE(SEQ)=SEQ_"|||"
	set DATE=EFD+1
	set DATE=$$GETDATE
 
	if DATE'="" do {
		type DbSet rs=Db.selectDbSet("UTBLCOMINDX1","CINDEX=:CINDEX AND EFD=:DATE")
		while rs.next() do {
			type RecordUTBLCOMINDX1 fCOMIND1=rs.getRecord("UTBLCOMINDX1")
			set $P(RATE(SEQ),"|",1)=SEQ             	// Sequence
			set $P(RATE(SEQ),"|",2)=fCOMIND1.mtier		// Tier
			set $P(RATE(SEQ),"|",3)=fCOMIND1.rate		// Rate
			set $P(RATE(SEQ),"|",4)=fCOMIND1.amt		// Amount
			set DUP(fCOMIND1.mtier)=""                      //Used to check for duplicates
			set SEQ=SEQ+1
			}
		}
	if %ProcessMode=2 set CNT=SEQ-1 quit
 
	for  quit:SEQ>(MAX*10)  do {
		set RATE(SEQ)=SEQ_"|||"
		set SEQ=SEQ+1
		}
	quit


POEFD   // Post processor for create mode EFD
 
	// Date must not be in the past
	if OPT'=2,X<%SystemDate set ER=1,RM=$$^MSG(755) quit
 
	if X="" quit

	if %OSAVE quit
 
	// Index ~p1 already exists for ~p2
	type ResultSet rs=Db.select("MTIER","UTBLCOMINDX1","CINDEX=:CINDEX AND EFD=:X")
	if rs.next()  do { quit
		set ER=1
		set RM=$$^MSG(1219,CINDEX,$$DAT^%ZM(X,$G(%MSKD))) 
		}

	set I(3)=""
	quit
 

VER	//

	if %ProcessMode=2!(%ProcessMode=4)!(VFMQ="Q") do END quit
 
	do FILE
 
	do END 

	quit

 
FILE	// File data

	new cnt
 
	/*
	If maintenance is performed, then rates may have been removed as well.
	Loop through the user table and remove the records before the update.
	*/
 
	if (%ProcessMode=1)!(%ProcessMode=3) do {
	
		// Delete Record
		do Db.delete("UTBLCOMINDX1","CINDEX=:CINDEX AND EFD=:EFD")
		}
 
	// Loop through the RATE array and set each balance tier accordingly
 
	if %ProcessMode=3 quit                 // Quit if delete
	set cnt=""
	for  set cnt=$O(RATE(cnt)) quit:cnt=""  do {
		new AMT,MTIER,RT
		set MTIER=$P(RATE(cnt),"|",2)

		if '$L(MTIER) quit

		set RT=$P(RATE(cnt),"|",3)
		set AMT=$P(RATE(cnt),"|",4)

		type RecordUTBLCOMINDX1 fCOMIND1=Class.new("RecordUTBLCOMINDX1")

		set fCOMIND1.cindex=CINDEX
		set fCOMIND1.efd=EFD
		set fCOMIND1.mtier=MTIER
		set fCOMIND1.rate=RT
		set fCOMIND1.amt=AMT

		//Update Record
		do fCOMIND1.save()
	
		}
 
	quit
 

END     //  Display return Messages

	if $G(ER)!(%ProcessMode=2)!(%ProcessMode=4) quit
 
	set CINDEX=$G(CINDEX)
 
	if VFMQ="Q" do {
 
		// Rates for index ~p1 not created
		if %ProcessMode=0 set RM=$$^MSG(2315,CINDEX) quit
 
		// Rates for index ~p1 not modified
		if %ProcessMode=1 set RM=$$^MSG(2317,CINDEX) quit
 
		// Rates for index ~p1 not deleted
		set RM=$$^MSG(2316,CINDEX)
		}
 
	else  do {
 
		// Rates for index ~p1 created
		if %ProcessMode=0 set RM=$$^MSG(2312,CINDEX) quit
 
		// Rates for index ~p1 modified
		if %ProcessMode=1 set RM=$$^MSG(2314,CINDEX) quit
 
		// Rates for index ~p1 deleted
		set RM=$$^MSG(2313,CINDEX)
		}
 
 	set ER="W"
	quit

 
GETDATE() //
	
	type ResultSet rs=Db.select("EFD","UTBLCOMINDX1","CINDEX=:CINDEX AND EFD<:DATE","EFD DESC")
	if rs.next() set DATE=rs.getCol("EFD")
	else  set DATE=""
	quit DATE

 
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43498^Sanchez SCM Administrator^4881"	// Signature - LTD^TIME^USER^SIZE
