MRPC072(String return, Number versn,Number CID)	// MRPC call for account level exemption plan
	/*
	---- Revision History ------------------------------------------------
	08/22/05 - RussellDS - CR16911
		   Integrate code previously in DEPEXP.PROC in order to
		   obsolete that procedure.
		   
		   Clean up code.
		   
		   Remove old revision history.
	*/
	
	type String EXPTBL(), FEEPLN, N, RETLIST

	// Version number of client message is not compatible with server
	if $G(versn)'=1 quit $$ERRMSG^PBSUTL($$^MSG(2951))

	// Retrive valid exemption plans
	
	type RecordDEP dep = Db.getRecord("DEP", "CID=:CID", 1)
	
	set FEEPLN = dep.feepln
	
	if 'FEEPLN.isNull() do {
	
		type ResultSet rs = Db.select("FEEDT", "FEEPLN", "PLAN=:FEEPLN AND FEEDT<:%SystemDate", "FEEDT DESC")
		
		if rs.next() do {
			
			type Date DATE = rs.getCol("FEEDT")
	
			type DbSet ds = Db.selectDbSet("FEESRV", "PLAN=:FEEPLN AND FEEDT=:DATE") 
	
			while ds.next()  do {
				
				type String FEESCH
				
				type RecordFEESRV feesrv = ds.getRecord("FEESRV")
				
				set FEESCH = feesrv.feesch
				
				if 'FEESCH.isNull() do {
				
					set DATE = DATE + 1
					
					type ResultSet rs2 = Db.select("FEESCHDT", "UTBLFEESCH", "FEESCH=:FEESCH AND FEESCHDT<:DATE", "FEESCHDT DESC")
					
					if rs2.next() set EXPTBL(FEESCH) = ""
				}
			}
		}
	}



	// Builds return string for PFW
	
	set (N, RETLIST) = ""
	for  set N = EXPTBL(N).order() quit:N.isNull()  set RETLIST = RETLIST_N_$C(13,10)

	// Returns list to PFW

	set return = $$V2LV^MSG(RETLIST)

	quit ""

vSIG()	quit "60139^42758^Dan Russell^1383"	// Signature - LTD^TIME^USER^SIZE
