SCARMNU1		/*
	ORIG: alagarss - 08/12/2005
	DESC: Profile Menu Report

	---- Comments --------------------------------------------------------

	---- Revision History ------------------------------------------------
	03/21/2006 - chhabris - CR20216
		     Modified START section to exit out of for loop when
		     FINISH=1, added select condition MENU>=:F(2) as the menu
		     was always starting with 1, also modified the procedure
		     to enhance readability.

	08/12/2005 - ALAGARSS - CR16677
	             Converted to PSL.
	             Also removed the revision history prior to 2004.
	I18N=QUIT
	
	----------------------------------------------------------------------
	*/

 	quit


EXTVAR	//
	type Public Number F,T
	type Public String RM,YN
	
	set YN=0
	while (YN=2) do {
		use 0 write !

		// From MENU : 
		write !,$J($$^MSG("4850"),40) R F(2)

		// To MENU : 
		write !,$J($$^MSG("4854"),40) R T(2)
		write !!!

		// Verified? 
		set RM=$$^MSG(5347)
		set YN=$$^DBSMBAR(140)

		// QUIT
		if YN=3 quit		
		if YN=1 do START quit
		}
	quit


START	//

	type public Number F,I,IX,%QUIT,%TOT,T,%TIM,%TREC
	type public String %,%DI,%FUN,%GC,%GH2,%GT,%LIBS,%PGOF,%PN,%RID
	type public String FID,fXSCATBL,IO,IOSL,IOTYP,J,KVAR,MENU,OPT,PD,V,XL
	type public Date %ED
	type public Boolean ER
	type Boolean FINISH,FINISH1

	set %="|",%PN=0,%TREC=0,%PGOF=0,%QUIT=0,%TIM=$$TIM^%ZM

	set FID="XSCATBL1",%RID="RPMENU",%LIBS="SYSDEV"

	if '%ED.exists() set %ED=$$DAT^%ZM($H)       

	use 0 if 'IO.data() do ^SCAIO do TERM^%ZUSE(IO,"WIDTH=132/ECHO") if IOTYP'="TRM" set IOSL=60
	else  write *27,*91,*63,*51,*104
	
	set IOSL=21                            

	// Reset Group Totals
	for IX=1:1:5 do {
		for %FUN="SUM","MAX","MIN" do {
			set %DI=""
			for  set %DI=%TOT(%DI).order() quit:%DI.isNull()  set %GT(IX,%DI,%FUN)=""
			}
		set %GC(IX)=""
		quit
		}

	use IO write # 
	set MENU=F(2)-1
	set OPT=""
	set (FINISH,FINISH1)=0

	type ResultSet rs=Db.select("MENU","SCAMENU0","MENU>=:F(2)")

		while rs.next() quit:FINISH  do { 

        		set %GH2=1
        		set MENU=rs.getCol("MENU")
        		if MENU.isNull()!(MENU>T(2)) do EXIT set (FINISH,FINISH1)=1

        		type ResultSet rs1=Db.select("SNUMB","SCAMENU","MNUMB=:MENU")

			while rs1.next() quit:FINISH1  do { 

				set OPT=rs1.getCol("SNUMB")

				if OPT.isNull()!(OPT>999) quit

				type RecordSCAMENU scamenu=Db.getRecord("SCAMENU","MNUMB=:MENU,SNUMB=:OPT",1)
				set fXSCATBL=scamenu.mdesc_"|"_scamenu.funmenu

				if fXSCATBL="|" set fXSCATBL="?"

				// Check Page Overflow
				if $Y>IOSL do HDR quit:%QUIT

				// Print Detail
				do PRINT

				// Accumulate Detail Totals
				for XL=1:1:5 do SUBT	
				if FINISH1=1 quit

				// Reset Detail Totals To Zero
				do SUBC set %TREC=%TREC+1
				if %QUIT set FINISH=1 do EXIT quit
        			}
			}

	quit


PRINT	//
	type public String %GH2,%PGOF,fXSCATBL,IOSL,MENU,OPT,PD,V
	type public Boolean %QUIT

	// Check Page Header Print Flag
	if '%PGOF set %PGOF=1 do HDR quit:%QUIT
	
	if %GH2 do GH2 set %GH2=0 quit:%QUIT

	write !
	
	set V=OPT,PD=$J((V+.5)\1,2) write ?16,PD
	set V=$P(fXSCATBL,"|",1),PD=$E(V,1,31) write ?21,PD
	set V=$P(fXSCATBL,"|",2),PD=$E(V,1,12) write ?55,PD
	
	quit

	
HDR	// Page Header
	type public String %ED,%PN,%TIM,IOTYP
	type public Number %QUIT

	if IOTYP="TRM",%PN>0 do WAIT quit:%QUIT
	write # S %PN=%PN+1

	// MENU LISTING
	// DATE: 
	write !,?25,$$^MSG("4852"),?100,$$^MSG("3789"),%ED,"  ",%TIM  

	// PAGE: 
	write !,?115,$$^MSG(2125,%PN)
	write !,!!,?15,"OPTION",?25,"DESCRIPTION",?55,"CALLS"
	write !,?1,"==================================================================================================================================="

	write !
	quit


GH2	//
	type public String %QUIT,IOSL,MENU
	type String des

	// Group Header
	if $Y+4>IOSL do HDR quit:%QUIT
	
	// MENU 
	type ResultSet rs1=Db.select("DES","SCAMENU0","MENU=:MENU")
	if rs1.next() set des=rs1.getCol("DES")

	write !,!!,?1,$$^MSG("4851"),MENU,?20,des
	
	write !
	quit


WAIT	//
	type public Number %QUIT,X
	type public String MSG
	
	// Continue?
	set MSG=$$^MSG(603)

	set X=$$^DBSMBAR(161,"","",1)
	if X=2 set %QUIT=1,$Y=0

	quit


SUBT	// Accumulate Totals  %GT(LEV,%DI,%FUN)=GROUP  LEV+1=PAGE   LEV+2=REPORT
	type public String %DI,%GC(),%GI(),%GT(),%TOT(),XL
	type public Boolean FINISH1
	type Boolean FINISH

	set FINISH=0
	set %DI=""
	for  do { quit:FINISH
		// COUNT
		set %DI=$O(%TOT(%DI)) 
		if %DI.isNull() set %GC(XL)=%GC(XL)+1 set FINISH=1 quit
		// SUM
		set %GT(XL,%DI,"SUM")=%GT(XL,%DI,"SUM")+%TOT(%DI) 
		// MIN
		if %GT(XL,%DI,"MIN")=""!(%TOT(%DI)<%GT(XL,%DI,"MIN")) set %GT(XL,%DI,"MIN")=%TOT(%DI)
		// MAX
		if %GT(XL,%DI,"MAX")=""!(%TOT(%DI)>%GT(XL,%DI,"MAX")) set %GT(XL,%DI,"MAX")=%TOT(%DI)
		}
	quit

	
SUBC	// Clear Detail Totals
	type public String %DI,%TOT()
	type public Number I

	set %DI="" 
	for I=1:1 set %DI=%TOT(%DI).order() quit:%DI=""  set %TOT(%DI)=""
	quit


EXIT	//
	type public String %,IO,IX,%GT,%GC,KVAR,PD,TYP,%TOT,V,XL
	type public Number %PGOF,%PN,%QUIT,%TREC,%TIM

	// End of report .... Press RETURN to continue: 
	if '%QUIT write !!,$$^MSG("4819")  read %QUIT,!,#,!        

 	use IO write #
	do CLOSE^SCAIO

	set %="|",%PN=0,%TREC=0,%QUIT=0,%PGOF=0,%TIM=$$TIM^%ZM  
	kill %TOT,%GT,KVAR,PD,TYP,V,XL,IX
	quit


INIT1	//
	type public String %DI,%FUN,%GC(),%GT(),IX,I,%TOT()

	for %FUN="SUM","MAX","MIN" do {
		set %DI=""
		for I=1:1 do { quit:%DI=""
			set %DI=%TOT(%DI).order()
			set %GT(IX,%DI,%FUN)=""
			}
		}

	set %GC(IX)=""
	quit


IOSC1	//
	write *27,*91,*63,*51,*104
	quit
 
 #OPTION ResultClass ON
Public String vSIG()	quit "60346^6514^Sanjay Chhrabria^5279"	// Signature - LTD^TIME^USER^SIZE
