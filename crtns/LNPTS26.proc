LNPTS26		/*
	PAYOFF OF LOAN - KEEP ACCOUNT OPEN

	---- Revision History ------------------------------------------------
	
	   08/29/06 - GIRIDHAL CR 22612
	   	      Modified section LOAD to change the condition on which the
	   	      for loop quits. Existing code exited before the last
	   	      piece was processed thereby causing wrong ending balances
	   	      when RPOO was processed.
	   	      
	   06/23/06 - DESHPANDE S K - CR 20748
		      Removed unused reference to %TRNSEQ and replace call
		      $$RECOV^LNPTS2(ttx.tso) with $$FIELD^UTSO(ttx.tso,"RECOV").
		   	
	   05/25/06 - GIRIDHAL - CR 21297
	   	      Removed references to SPLTDY from LOAD section
	   	      
	   07/11/05 - KinI - 16566
	   	      Modified PROC section to add ttx object as parameter to
	   	      LNFEE^LNPO2 call. 

	   05/05/05 - Carol Scott - CR 15816
	   	      Modified section LOAD to define SEQ with %TRNSEQ since
	   	      calling program notes that this can either be a primary
	   	      or a secondary transaction.
	   	      In section RUN, added a $ to a P.
	   	      	
	   05/06/05 - KinI - 15524
	   	      Modified ADJINT, ADJ2 and BILL sections to replace 
	   	      lnbil1.bp1 pieces with direct sub-fields update per 
	   	      DBI standards. Modified to check BSEQ before calling
	   	      sections above.	
	   	
	-----------------------------------------------------------------------
	*/

	quit


public	PROC(RecordLN ln,
	     RecordTTX ttx,
	     RecordTRN trn)

	set BSEQ=ln.bseq		// Billing - Last Sequence Number
	set UNAPF=ln.unapf		// Unapplied Funds
	set TDUE=ln.tdue		// Total Due
	set CUIN=ln.cuin		// Current Interest
	set UNIN=ln.unin		// Uncollected Interest
	set CUPR=ln.cupr		// Current Principal
	set UNPR=ln.unpr		// Uncollected Principal
	set ACR=$$^SCARND(ln.acr,0,CID)	// Accrued Interest
	set BAL=ln.bal			// Ledger Balances
	set COA=ln.coa			// Charge-Off Amount
	set REC=ln.rec			// Recovery Amount
	set TBA=ln.tba			// Total Outstanding Due Amount
	set PPO=ln.ppo			// Payoff - Priority Order

	set BALCMP=$S(ln.aruf:BAL-ln.udbal,1:BAL)      // Unadvanced Balance

	// If TRN.PCFL43 is not on, don't allow payoff w/negative accrual balance
	// Cannot process with negative accrual  ~p1
	if $E(E23,43)'=1,ACR<0 do Runtime.setErrMSG("LN",471,"ACR") quit:ER

	set ADJ=ACR-UNIN-CUIN
	if (ADJ < 0) , (BSEQ > 0) do ADJINT(.ln,BSEQ)

	set L=$$FIELD^UTSO(ttx.tso,"LCEFDAMT")	// Transaction Source of Funds
	if L="" set L=ln.lchg			// Late Charge Due
	set L=$$LCHGADJ^LNPO2(.ln,CID,L)	// Check min/max amounts

	// Total Fees Not Billed
	set MC=$$MCNB^LNCO3(.ln,CID)

	// Total Fees Due
	set M=$$MCHG^LNCO3(CID)

	// Add fees calculated as part of payoff
	set M=M+$$LNFEE^LNPO2(.ln,"01",,.ttx)

	// Use payment transaction code
	if ZAMT<(L+M+ACR+BALCMP-UNAPF-COA+REC) do Runtime.setErrMSG("LN",2839) quit:ER

	do LOAD(.ln,.ttx,.trn,BSEQ)

	quit


public	LOAD(RecordLN ln,RecordTTX ttx,RecordTRN trn,BSEQ)

	type Boolean LOOPDONE;
	
	set XP("TBA")="^LNPTS3(.ln,.ttx,.trn)|"
	set XP("P")="^LNPTS4(.ln,.ttx,.trn)|"
	set XP("A")="^LNPTS15(.ln,.ttx)|"
	set XP("L")="INIT^LNPTS12(.ln,.ttx)|"
	set XP("M")="^LNPTS13(.ln,.ttx,.trn)|"

	set X=$S(CUIN<0:0,1:CUIN)
	set A=$S(ACR-UNIN-X<0:0,1:ACR-UNIN-X)
	set X=$S(CUPR<0:0,1:CUPR)
	set P=BALCMP-UNPR-X

	if (BSEQ > 0) do BILL(BSEQ)

	if (A < 0) , (BSEQ > 0) do {
		set ADJ=A
		set A=0
		do ADJ2(.ln,BSEQ)
		}
	
	/*
	   Compute payoff amount.  Add in TBA if interest and principal is
	   billed.  Because TBA may contain billed fees, reduce it by the net
	   of the total fees due and the total fees not billed.  This net amount
	   is already contained in TBA.
	*/
	set X=L+M+A+P-UNAPF-COA+REC
	if 'ln.idp set X=X+TBA-(M-MC)          // Check IDP

	if UNAPF do UNAPF(.ln,.ttx)

	set RECOV=$$FIELD^UTSO(ttx.tso,"RECOV")

	do LNFEE^LNPTS23(.ln,.ttx,1) if ER quit

	if RECOV do {
		set R=RECOV*OPR8R
		do GL^LNPTSU(.ttx,R,11)
		do GL^LNPTSU(.ttx,-R,10) 
		set ln.coa=ln.coa+(-R)       // Charge-Off Amount
		}

	if PPO'=1,(PPO'=2) do {
		set IXP(1)="M|"_M
		set IXP(2)="TBA"_"|"_TBA
		set IXP(3)="L"_"|"_L
		set IXP(4)="A"_"|"_A
		set IXP(5)="P"_"|"_P
		set P=5
		}

	if PPO=1 do {
		set IXP(1)="M|"_M
		set IXP(2)="TBA"_"|"_TBA
		set IXP(3)="P"_"|"_P
		set IXP(4)="A"_"|"_A
		set IXP(5)="L"_"|"_L
		set P=2
		}

	if PPO=2 do {
		set IXP(1)="M|"_M 
		set IXP(2)="TBA"_"|"_TBA
		set IXP(3)="L"_"|"_L	
		set IXP(4)="P"_"|"_P
		set IXP(5)="A"_"|"_A
		set P=4
		}

	if ZAMT-X,$E(E23,10) set OVR(CID,"OVR","PAYOFF")=$$^SCARND(X,0,CID)

	set N=""
	set X=ZAMT+UNAPF
	set LOOPDONE=0
	for  set N=$O(IXP(N)) quit:(N="")  do { quit:LOOPDONE

		set Q=IXP(N)
		set AC=$P(Q,"|",1)
		set Y=$P(Q,"|",2)

		if Y'>X do {
			set $P(XP(AC),"|",2)=Y 
			set X=X-Y
			}
		else  set LOOPDONE=1
		}
	
	if N="" do { do RUN(.ln) quit
		quit:'X
		set $P(XP("P"),"|",2)=$P(XP("P"),"|",2)+X
		}

	set $P(XP(AC),"|",2)=X

	do RUN(.ln)
	quit


RUN(RecordLN ln)

	set IXP=""
	for  set IXP=$O(IXP(IXP)) quit:IXP=""!ER  do {

		set XP=$P(IXP(IXP),"|",1) 
		quit:'$P(XP(XP),"|",2)

		set (zamt,ZAMT)=$P(XP(XP),"|",2)
		for  do { quit:'ZAMT!(zamt-ZAMT=0)  set zamt=ZAMT
			set X=$P(XP(XP),"|",1)
			do @X
			}

		quit:ER 
		}

	if IXP="" do { quit
		kill F
		set N=""
		for  set N=$O(XP(N)) quit:N=""  do {
			set X=$P(XP(N),"|",3)
			for J=1:1 quit:$P(X,",",J,99)=""  do {
				set Y=$P(X,",",J)
				set:+Y F(Y)=""
				}
			}

		set ZAMT=0
		set ln.acr=0
		kill OVR(CID,"OVR","MINBAL")
		}

	quit


UNAPF(RecordLN ln,RecordTTX ttx)

	set ln.unapf=0			// Unapplied Funds
	do GL^LNPTSU(.ttx,-UNAPF,9)
	quit 


ADJINT(RecordLN	ln,
       Number BSEQ) 	// Billing - Last Sequence Number

	// Interest adjustment

	type Number I
	type String D

	type RecordLNBIL1 lnbil1 = Db.getRecord("LNBIL1","CID,BSEQ")

	set lnbil1.casd = lnbil1.casd + ADJ
	set lnbil1.ctab = lnbil1.ctab + ADJ
	set lnbil1.cpid = lnbil1.cpid + ADJ
	set lnbil1.cpib = lnbil1.cpib + ADJ

	set D = $$SUB^BILFUNCS("I",.lnbil1)
	for I = 3,4 set $P(D,"#",I) = $P(D,"#",I) + ADJ
	do SETELMT^BILFUNCS(.lnbil1,"I",D)

	do lnbil1.bypassSave()

	set TBA = TBA + ADJ
	set TDUE = TDUE + ADJ
	set CUIN = CUIN + ADJ
	if (CUIN < 0) do {
		set UNIN = UNIN - CUIN
		set CUIN = 0
		}

	set ln.tdue = TDUE                       // Total Due
	set ln.cuin = CUIN                       // Current Interest
	set ln.unin = UNIN                       // Uncollected Interest
	set ln.tba = TBA                         // Total Outstanding Due Amount

	quit 


ADJ2(RecordLN ln,
     Number BSEQ) 	// Billing - Last Sequence Number

	// Interest adjustment

	type RecordLNBIL1 lnbil1=Db.getRecord("LNBIL1","CID,BSEQ")

	set lnbil1.casd=lnbil1.casd+ADJ
	set lnbil1.ctab=lnbil1.ctab+ADJ
	set lnbil1.cpid=lnbil1.cpid+ADJ
	set lnbil1.cpib=lnbil1.cpib+ADJ

	set D=$$SUB^BILFUNCS("I",.lnbil1)
	for I=3,4 set $P(D,"#",I)=$P(D,"#",I)+ADJ
	do SETELMT^BILFUNCS(.lnbil1,"I",D)

	set TBA=TBA+ADJ
	set ln.tba=TBA		// Total Outstanding Due Amount

	do lnbil1.bypassSave()

	quit 


BILL(Number BSEQ)	// Billing - Last Sequence Number

	type Number I
	type String D

	type RecordLNBIL1 lnbil1=Db.getRecord("LNBIL1","CID,BSEQ")

	if (lnbil1.cdpd '> %SystemDate) quit

	for I=2:1 set D=$$SUB^BILFUNCS(I,.lnbil1) quit:D=""
		set:$E(D,1,2)="P#" P=P-$P(D,"#",4) 
		set:$E(D,1,2)="I#" A=A-$P(D,"#",4)
		
	quit

vSIG()	quit "60507^38610^Lakshmi Giridharan^6948"	// Signature - LTD^TIME^USER^SIZE
