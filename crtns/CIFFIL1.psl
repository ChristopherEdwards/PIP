CIFFIL1 // CIF DATA-QWIK filer, part (3)
 // Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 05/09/2007 16:32 - joynerd

	quit		// Not called from top

VJOURNAL(RecordCIF cif)	//CIF Journal file entries

	type Public Date %EffectiveDate
	type Public String %TSRC,vpar,vx()
	type String TSRC,vdi,vdx()

	if %TSRC.get().isNull() set TSRC="O"
	else  set TSRC=%TSRC

	if %ProcessMode=3 do {
		if TSRC="B" do {
			do vj1(.cif)	// Mode=D Tran=B EFD=N,E Seq=1 JRNID=CIFD_D
			}
		else  if TSRC="O" do {
			do vj1(.cif)	// Mode=D Tran=O EFD=N,E Seq=1 JRNID=CIFD_D
			}
		}
	else  if %ProcessMode=0 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj2(.cif)	// Mode=I Tran=B EFD=N Seq=1 JRNID=CIFH_I
				do vj5(.cif)	// Mode=I Tran=B EFD=N Seq=1 JRNID=DTJNA
				}
			}
		else  if TSRC="O" do {
			if 'EFD.get() do {
				do vj2(.cif)	// Mode=I Tran=O EFD=N Seq=1 JRNID=CIFH_I
				do vj5(.cif)	// Mode=I Tran=O EFD=N Seq=1 JRNID=DTJNA
				}
			}
		}
	else  if %ProcessMode=1 do {
		if TSRC="B" do {
			if EFD.get() do {
				do vj3(.cif)	// Mode=U Tran=B EFD=E Seq=1 JRNID=CIFH_U
				}
			else  do {
				do vj3(.cif)	// Mode=U Tran=B EFD=N Seq=1 JRNID=CIFH_U
				quit:'vx.data()
				for vdi="BOO","LNM","NAM","NATION","MAD1","MAD2","MAD3","MAD4" if vx(vdi).data() do vj4(.cif,vdi) quit	// Mode=U Tran=B EFD=N Seq=1 JRNID=CMSRECACN
				for vdi="MAD1","MAD2","MAD3","MAD4" if vx(vdi).data() do vj6(.cif,vdi) quit	// Mode=U Tran=B EFD=N Seq=1 JRNID=MADDR_UP
				for vdi="PAD1","PAD2","PAD3","PAD4" if vx(vdi).data() do vj7(.cif,vdi) quit	// Mode=U Tran=B EFD=N Seq=1 JRNID=PADDR_UP
				if vx("PCNTRY").data() do vj9(.cif,"PCNTRY")	// Mode=U Tran=B EFD=N Seq=1 JRNID=ZAMLCIFJNL
				}
			}
		else  if TSRC="O" do {
			if EFD.get() do {
				do vj3(.cif)	// Mode=U Tran=O EFD=E Seq=1 JRNID=CIFH_U
				}
			else  do {
				do vj3(.cif)	// Mode=U Tran=O EFD=N Seq=1 JRNID=CIFH_U
				quit:'vx.data()
				for vdi="BOO","LNM","NAM","NATION","MAD1","MAD2","MAD3","MAD4" if vx(vdi).data() do vj4(.cif,vdi) quit	// Mode=U Tran=O EFD=N Seq=1 JRNID=CMSRECACN
				for vdi="MAD1","MAD2","MAD3","MAD4" if vx(vdi).data() do vj6(.cif,vdi) quit	// Mode=U Tran=O EFD=N Seq=1 JRNID=MADDR_UP
				for vdi="PAD1","PAD2","PAD3","PAD4" if vx(vdi).data() do vj7(.cif,vdi) quit	// Mode=U Tran=O EFD=N Seq=1 JRNID=PADDR_UP
				if vx("XNAME").data() do vj8(.cif,"XNAME")	// Mode=U Tran=O EFD=N Seq=1 JRNID=XPRIOR
				if vx("PCNTRY").data() do vj9(.cif,"PCNTRY")	// Mode=U Tran=O EFD=N Seq=1 JRNID=ZAMLCIFJNL
				}
			}
		}

	quit


vj1(RecordCIF cif)	// CIFD_D  Table CIFD  Daily transaction Journal

	type Public String EFD,%UID,TJD,TLO
	type String v1,v2,vlastkey
	set v1=TJD
	set v2=cif.acn
	set vlastkey=Db.nextVal("CIFD","TJD=:v1,ACN=:v2")
	type RecordCIFD cifd=Db.getRecord("CIFD","TJD=:v1,ACN=:v2,SEQ=:vlastkey",1)
	set cifd.efd=$G(EFD)
	set cifd.hdate=+$H
	set cifd.htime=$P($H,",",2)
	set cifd.tcmt=$$^MSG(704,cif.acn)
	set cifd.tlo=TLO
	set cifd.uid=%UID

	do cifd.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj2(RecordCIF cif)	// CIFH_I  Table CIFH  History file

	type Public String %IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=cif.acn
	set vlastkey=Db.nextVal("CIFH","ACN=:v1")
	type RecordCIFH cifh=Db.getRecord("CIFH","ACN=:v1,SEQ=:vlastkey",1)
	set cifh.hdate=+$H
	set cifh.htime=$P($H,",",2)
	set cifh.ident=%IDENT
	set cifh.tcmt=$$^MSG(6793)
	set cifh.tjd=TJD
	set cifh.tlo=TLO
	set cifh.uid=%UID

	do cifh.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj3(RecordCIF cif)	// CIFH_U  Table CIFH  Maintenance History

	type Public String vx()
	type String vdi
	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  if 'vx(vdi).piece("|",3) if vdi'="XNAME" do {
		type Public String vx(),EFD,%IDENT,%UID,TJD,TLO
		type String v1,vlastkey

		type String vold,vnew

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)

		set v1=cif.acn
		set vlastkey=Db.nextVal("CIFH","ACN=:v1")
		type RecordCIFH cifh=Db.getRecord("CIFH","ACN=:v1,SEQ=:vlastkey",1)
		set cifh.efd=$G(EFD)
		set cifh.hdate=+$H
		set cifh.htime=$P($H,",",2)
		set cifh.ident=%IDENT
		set cifh.tcmt=$$TCMTFM^CIFFUNCS(cif.acn,cif.cls,vdi,vold,vnew,$G(EFD))
		set cifh.tjd=TJD
		set cifh.tlo=TLO
		set cifh.uid=%UID

		do cifh.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit


vj4(RecordCIF cif,String vdi)	// CMSRECACN  Table CMSRECACN  Adds CMSREC entry for mod. CIF record.

	if +cif.carduf=1
	else  quit

							//// Save this line for Public datatyping, if needed
	type String vlastkey
	set vlastkey=Db.nextVal("CMSRECACN","")
	type RecordCMSRECACN cmsrecacn=Db.getRecord("CMSRECACN","SEQ=:vlastkey",1)
	set cmsrecacn.acn=cif.acn
	set cmsrecacn.cmsflg=cif.cmsflg

	do cmsrecacn.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj5(RecordCIF cif)	// DTJNA  Table DTJNA  New CIF Account File

	type Public String TJD
	type String v1,v2,v3,v4,vlastkey
	set v1=TJD
	set v2="*"
	set v3="CIF"
	set v4=cif.type
	set vlastkey=cif.acn
	type RecordDTJNA dtjna=Db.getRecord("DTJNA","TJD=:v1,CLS=:v2,GRP=:v3,TYP=:v4,CID=:vlastkey",1)

	do dtjna.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj6(RecordCIF cif,String vdi)	// MADDR_UP  Table DTJADDRCHG  Mailing Address Update Journal

	if +cif.maddrflg'=1
	else  quit

	type Public String TJD
	type String v1,v2,vlastkey
	set v1=TJD
	set v2=cif.acn
	set vlastkey=5
	type RecordDTJADDRCHG dtjaddrchg=Db.getRecord("DTJADDRCHG","SJD=:v1,ACN=:v2,AKEY=:vlastkey",1)
	set dtjaddrchg.oad1=cif.mad1.oldVal
	set dtjaddrchg.oad2=cif.mad2.oldVal
	set dtjaddrchg.oad3=cif.mad3.oldVal
	set dtjaddrchg.oad4=cif.mad4.oldVal
	set dtjaddrchg.ocity=cif.mcity.oldVal
	set dtjaddrchg.ocntry=cif.mcntry.oldVal
	set dtjaddrchg.ostate=cif.mstate.oldVal
	set dtjaddrchg.ozip=cif.mzip.oldVal

	do dtjaddrchg.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj7(RecordCIF cif,String vdi)	// PADDR_UP  Table DTJADDRCHG  Legal Address Update Journal

	if +cif.paddrflg'=1
	else  quit

	type Public String TJD
	type String v1,v2,vlastkey
	set v1=TJD
	set v2=cif.acn
	set vlastkey=6
	type RecordDTJADDRCHG dtjaddrchg=Db.getRecord("DTJADDRCHG","SJD=:v1,ACN=:v2,AKEY=:vlastkey",1)
	set dtjaddrchg.oad1=cif.pad1.oldVal
	set dtjaddrchg.oad2=cif.pad2.oldVal
	set dtjaddrchg.oad3=cif.pad3.oldVal
	set dtjaddrchg.oad4=cif.pad4.oldVal
	set dtjaddrchg.ocity=cif.pcity.oldVal
	set dtjaddrchg.ocntry=cif.pcntry.oldVal
	set dtjaddrchg.ostate=cif.pstate.oldVal
	set dtjaddrchg.ozip=cif.pzip.oldVal

	do dtjaddrchg.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj8(RecordCIF cif,String vdi)	// XPRIOR  Table XPRIOR  Prior Name

							//// Save this line for Public datatyping, if needed
	type String v1,vlastkey
	set v1=cif.xname.oldVal
	set vlastkey=cif.acn
	type RecordXPRIOR xprior=Db.getRecord("XPRIOR","NAM=:v1,ACN=:vlastkey",1)

	do xprior.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj9(RecordCIF cif,String vdi)	// ZAMLCIFJNL  Table ZAMLJNL  Modified Columns for AML Reporting

	type Public String TJD
	type String v1,v2,vlastkey
	set v1=TJD
	set v2="CIF"
	set vlastkey=cif.acn
	type RecordZAMLJNL zamljnl=Db.getRecord("ZAMLJNL","ZTJD=:v1,TABTYPE=:v2,CID=:vlastkey",1)

	do zamljnl.save("/NOVALFK/NOVALDD/NOVALRI")

	quit

