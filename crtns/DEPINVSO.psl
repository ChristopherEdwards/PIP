DEPINVSO	
       /* -------------------  Revision History -----------------------------
	   11/26/05 - ALAGARSS - 18006
	   	      Modified the code to remove deprecated feature error.
	   	      Also modified the Class.new to get Record to aviod Unique
	   	      constraint error.
	   	      
	   08/14/00 - SHANL - 41513
		      Rewrote the coding above the comment "//Getting totals
	              for type" to make it to be efficient.
		      Fixed the error by changing the positions of "{s" to get 
		      the right totals for type, cost center and currency.
		                   
         
	   08/20/99 - TITOVE - 34554 
	   	      Various modifications to simplify the code, enhance 
		      processing speed and prevent infinite loops.
	 
         
	   05/13/99 - TITOVE - 33100 
	   	      Select only non-institution investment accounts.
	 

	   ORIG: KUCHEROVSKYA - Feb 15, 1999
	   DESC: This procedure will be executed during report running process 
		 to populate global ^INVSORT and calculate totals for the 
		 transaction accounts based on TYPE,CC,CRCD.

	*/  


	new RUNDT

	set RUNDT=%SystemDate

	if Db.isDefined("UTBLINVSRT","RUNDT") quit

	do Db.fastDelete("DEPINVSORT")
 
	/*       
	 Populating global ^INVSORT [DEPINVSORT] file definition with 
	 keys and data items value.
	*/

	new rs,CID,ICID
	type ResultSet rs
	set rs=Db.select("CID,ICID","DEP101")
	if rs.isEmpty() quit

	while rs.next() do {

		set CID=rs.getCol(1)
		set ICID=rs.getCol(2)

		/*
		 ET - 33100  Modification: only select the non-institution 
		 investment accounts.
		*/
		
		type RecordDEP dep=Db.getRecord("DEP","CID=:ICID")
		type RecordDEP dep0=Db.getRecord("DEP","CID=:CID")
		if dep.swpni'=1 quit
		if dep.bal'>0 quit

		type RecordDEP101 dep101=Db.getRecord("DEP101","CID=:CID,ICID=:ICID")
		type RecordDEPINVSORT depinv=Db.getRecord("DEPINVSORT","CRCD=:dep.crcd,CC=dep.cc,TYPE=:dep.type,CID=:CID,ITYPE=:dep101.itype,ICID=:ICID",1)
		if 'depinv.getMode() do {

			set depinv.crcd=dep.crcd
			set depinv.cc=dep.cc
			set depinv.type=dep0.type
			set depinv.cid=CID
			set depinv.itype=dep101.itype
			set depinv.icid=ICID
			set depinv.bal=dep.bal
			set depinv.pct=dep101.pct
			set depinv.iytd=dep.iytd
			set depinv.ipy=dep.ipy
			set depinv.bwy=dep.bwy
			set depinv.bwp=dep.bwp
			set depinv.daa=dep.daa
			set depinv.acr=dep.acr
			set depinv.dbi=dep.dbi
		
			do depinv.bypassSave()
			}
                        
        	}
 
	//Getting totals for type.
	new rs,TRTYPE,TRCC,TRCRCD
	type ResultSet rs=Db.select("DISTINCT TYPE,CC,CRCD","DEPINVSORT")
	if rs.isEmpty() quit
	while rs.next() do {
		set TRTYPE=rs.getCol(1)
		set TRCC=rs.getCol(2)
		set TRCRCD=rs.getCol(3)

		new rs,TRCID,TBAL,TBALCOL,TLNPROC,TINVBAL
 	        set (TBAL,TBALCOL,TLNPROC,TINVBAL)=0
		type ResultSet rs=Db.select("DISTINCT CID","DEPINVSORT","TYPE=:TRTYPE AND CC=:TRCC AND CRCD=:TRCRCD")
		if rs.isEmpty() quit
		while rs.next() do {
			set TRCID=rs.getCol(1)

			new dep
			type RecordDEP dep=Db.getRecord("DEP","TRCID")
			set TBAL=TBAL+dep.bal
			set TBALCOL=TBALCOL+dep.balcol
			set TLNPROC=TLNPROC+dep.swpile
			set TINVBAL=TINVBAL+dep.swpinvb
			}

		new invtype		
		type RecordDEPINVTYPE invtype=Db.getRecord("DEPINVTYPE","CRCD=:TRCRCD,CC=:TRCC,TYPE=:TRTYPE",1)
		do invtype.setAuditFlag()
		set invtype.type=TRTYPE
		set invtype.cc=TRCC
		set invtype.crcd=TRCRCD
		set invtype.tbal=TBAL
		set invtype.tbalcol=TBALCOL
		set invtype.tswpile=TLNPROC
		set invtype.tswpinvb=TINVBAL
		do invtype.save()
			
		}


        //Getting totals for cost center.
	new rs,TRCC,TRCRCD
	type ResultSet rs=Db.select("DISTINCT CC,CRCD","DEPINVSORT")
	if rs.isEmpty() quit
	while rs.next() do {
		set TRCC=rs.getCol(1)
		set TRCRCD=rs.getCol(2)
 
		new rs,TRCID,TBAL,TBALCOL,TLNPROC,TINVBAL
                set (TBAL,TBALCOL,TLNPROC,TINVBAL)=0
		type ResultSet rs=Db.select("DISTINCT CID","DEPINVSORT","CC=:TRCC and CRCD=:TRCRCD")
		if rs.isEmpty() quit
		while rs.next() do {
			set TRCID=rs.getCol(1)

			new dep
			type RecordDEP dep=Db.getRecord("DEP","TRCID")
			
			set TBAL=TBAL+dep.bal
			set TBALCOL=TBALCOL+dep.balcol
			set TLNPROC=TLNPROC+dep.swpile
			set TINVBAL=TINVBAL+dep.swpinvb
			}

		new invcc
		type RecordDEPINVCC invcc=Db.getRecord("DEPINVCC","CRCD=:TRCRCD,CC=:TRCC",1)
		do invcc.setAuditFlag()
		set invcc.cc=TRCC
		set invcc.crcd=TRCRCD
		set invcc.tbal=TBAL
		set invcc.tbalcol=TBALCOL
		set invcc.tswpile=TLNPROC
		set invcc.tswpinvb=TINVBAL
		do invcc.save()
			
		}
        
	//Getting totals for currency code.
	new rs,TRCRCD
	type ResultSet rs=Db.select("DISTINCT CRCD","DEPINVSORT")
	if rs.isEmpty() quit
	while rs.next() do {
		set TRCRCD=rs.getCol(1)
                
		new rs,TRCID,TBAL,TBALCOL,TLNPROC,TINVBAL
                set (TBAL,TBALCOL,TLNPROC,TINVBAL)=0
		type ResultSet rs=Db.select("DISTINCT CID","DEPINVSORT","CRCD=:TRCRCD")
		if rs.isEmpty() quit
		while rs.next() do {
			set TRCID=rs.getCol(1)
 
			new dep
			type RecordDEP dep=Db.getRecord("DEP","TRCID")
			set TBAL=TBAL+dep.bal
			set TBALCOL=TBALCOL+dep.balcol
			set TLNPROC=TLNPROC+dep.swpile
			set TINVBAL=TINVBAL+dep.swpinvb
			}

		new invcrcd
		type RecordDEPINVCRCD invcrcd=Db.getRecord("DEPINVCRCD","CRCD=:TRCRCD",1)
		do invcrcd.setAuditFlag()
		set invcrcd.crcd=TRCRCD
		set invcrcd.tbal=TBAL
		set invcrcd.tbalcol=TBALCOL
		set invcrcd.tswpile=TLNPROC
		set invcrcd.tswpinvb=TINVBAL
		do invcrcd.save()
                        
                }

        do Db.fastDelete("UTBLINVSRT")
        type RecordUTBLINVSRT utblinvsrt=Db.getRecord("UTBLINVSRT","RUNDT=:TJD",1)
        if utblinvsrt.getMode()=1 quit
        set utblinvsrt.rundt=RUNDT
        do utblinvsrt.save()
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "60285^33398^Sivakumar Alagarsamy^5464"	// Signature - LTD^TIME^USER^SIZE
