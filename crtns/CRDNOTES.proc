CRDNOTES	 	/*
   	 ORIG: GRAY - 01/10/2000
    	DESC: ATM Card Notes
    
    	---- Comments --------------------------------------------------------
 
    	---- Revision History ------------------------------------------------
    	 04/12/06 - SPR - 20667
    	 	    Added a call to INIT section in Public PUR section. 	

	 12/12/05 - SPR - 18555
	       	     Card Management - General DBI3 System Area Clean up.
	       	     		     - Issue with screen driver conversion 
	       	     		       to PSL addressed( Replica CR 13271).
	       	     
	----------------------------------------------------------------------	       	     
 	*/
	
	quit
	
Public PUR	//
	set %ProcessMode=4
	do INIT
	quit
	
INIT	//

	type public String OLNTB,VFMQ
	type Number %PAGE,%PG
	type String FILE
	
	set %PG=0,%PAGE=1,FILE="CIF"
	kill OLNTB,VFMQ
	
	do VPG
	
	quit
	

VPG     // Page control

	type public Number %PG,%PAGE 	
	type public String VFMQ
	type Boolean FINISH

	set FINISH=0

	for  do { quit:FINISH

		if %PG=0 do VPG00 if VFMQ="Q" set FINISH=1 quit
		if "DFQ"[VFMQ set FINISH=1 quit

		if %PG>0 do VPG01 if VFMQ="Q" set FINISH=1 quit
		if "DFQ"[VFMQ do VER set FINISH=1 quit
		set %PG=%PG+1
		}

	quit 
	
	
VPG00	// Set up

	type public Boolean ER
	type public String VFMQ
	type String %READ,%TAB()
	
	set %TAB("PURGE")=".PURGE1"
	
	if %ProcessMode=4 S %READ="@@%FN,,,PURGE/REQ"

	do ^UTLREAD if VFMQ="Q" set ER=1 quit
	
	quit
	
	
VPG01	// Screen
	
	type public String VFMQ
	if %ProcessMode=4 set VFMQ="F"
	
	quit
	
	
	
PURGE1	// Purge all expired notes
	type public Date PURGE
	do Db.delete("CRDNOT","EXP<:PURGE")
	
	quit
	
	
VER	//

	type public String VFMQ
	
	if VFMQ="Q" do END quit
	do FILE,END
	
	quit
	
	
FILE	// File data

	type public String X
	
	if %ProcessMode=4 do PURGE1 quit
	
	quit

	
Public HOT(HTYPE,HNUM)	// Check for Hot Card
	
	
	type Number HSTAT,MNUM
	type ResultSet rs=Db.select("MNUM","CRDMEM","CRDTYP=:HTYPE AND CRDNUM=:HNUM")

	if rs.isEmpty() quit "N"
	set HSTAT=0
	while rs.next() do { quit:HSTAT=1!(HSTAT=5)
		set MNUM=rs.getCol("MNUM")
		type RecordCRDMEM crdmem=Db.getRecord("CRDMEM","CRDTYP=:HTYPE,CRDNUM=:HNUM,MNUM=:MNUM")
		set HSTAT=crdmem.stat
		}
	
	if HSTAT=1!(HSTAT=5) quit "Y"
	
	quit "N"
	
	
END	//
	
	type public String ER,RM,VFMQ
	
	quit:ER!(%ProcessMode=4)
	if 'RM.isNull() quit
	
	// Notes not purged
	if VFMQ="Q" set RM=$$^MSG("2072")
	
	// Notes purged
	else  set RM=$$^MSG("2073")

	set ER="W"
	
	quit

vSIG()	quit "60367^21370^Renga SP^2289"	// Signature - LTD^TIME^USER^SIZE
