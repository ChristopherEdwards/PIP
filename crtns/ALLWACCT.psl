ALLWACCT		/*
	   ORIG: HAYMANP May 7, 1999
	   DESC: Linetags in this procedure will be called from the CIF and
	         RELCIF filers to determine if an account is allowable
	    	 according to residency processing rules.  If the account is
	         not allwable, an ER and RM will be set.  Also, if necessary,
	         the RESTYP of any related accounts will be updated.
	   
	  ----Revision History--------------------------------------------------
	   
	   07/02/99 - DOUGANM - 33890
		      Converted M code into PSL

	   05/28/99 - HAYMANP - 32050
	              Removed check on CUVAR("RESPROC") from section CUST.  New
	              %RESPROC used in CIF filer.  Added use of new macro
	              &&DelErrXBAD.  Also made a few efficiency changes.
	
	  ----------------------------------------------------------------------
	*/	

	quit

ACCT(XCID,XCRCD,XACN)	// Extrinsic, does verification and sets up RESTYP
	
	new CTYP,CURRFLG,INDFLG,NRSEC,PRMRES,rs,SECRES
	
	if XCRCD=%SystemCurrency set CURRFLG=0
	else  set CURRFLG=1
	
	// get primary owner's residency status
	set PRMRES=$$GETNR(XACN)
	
	set SECRES=2 set INDFLG=0
	
	// retrieve list of all secondary owners 
	type ResultSet rs=Db.select("ACN,ODL","RELCIF","CID=:XCID AND ACN<>:XACN")

	// scan secondary owners (if any) and set up SECRES and INDFLG
	if 'rs.isEmpty() do {
		new NR,NRIND,RESIND,XACN,XODL
		set (NRIND,RESIND,SECRES)=0
		while rs.next() do { quit:(SECRES&NRIND)
			set XACN=rs.getCol(1)
			set XODL=rs.getCol(2)
			set NR=$$GETNR(XACN)
			if NR set SECRES=1 if 'XODL set NRIND=1
			if 'NR,'XODL set RESIND=1
			}
		if SECRES set INDFLG=NRIND quit 
		set INDFLG=RESIND
		}
	
	// Retrieve allowed account type from UTBLAATYP
	if 'CURRFLG set CTYP=Db.getOneRow("LCTYP","UTBLAATYP","PRMRES,SECRES,INDFLG")
	if CURRFLG set CTYP=Db.getOneRow("FCTYP","UTBLAATYP","PRMRES,SECRES,INDFLG")
	
	/*
	No error necessary, valid account.  Remove XBAD and
	return RESTYPE as CTYP-1
	*/
	if CTYP do Runtime.delErrXBAD("ACN","RESPROC") quit:ER 0 quit CTYP-1
	
	// Res Processing acct parameter vals prevent insertion/update
	do Runtime.setErrXBAD("ACN","RESPROC") quit:ER 0
	
	quit 0
	

CUST(XACN)	// Called from CIF filer
	
	new rs,XCID
	
	// verify all customer's accounts

	type ResultSet rs=Db.select("CID","RELCIF","ACN=:XACN")
	if rs.isEmpty() quit
	while rs.next()  set XCID=rs.getRow()  do RELAT(XCID) quit:ER  

	quit 
	

RELAT(XCID)	// Called from RELCIF filer
	
	new DATA,RESTYP,XACN,XCLS,XCRCD
	
	set DATA=Db.getOneRow("CRCD,CLS,ACN","ACN","XCID")
	set XCRCD=$P(DATA,$C(9),1)
	set XCLS=$P(DATA,$C(9),2)
	set XACN=$P(DATA,$C(9),3)
	
	set RESTYP=$$ACCT(XCID,XCRCD,XACN) quit:ER 
	
	// update RESTYP on account
	if XCLS="D" do Db.update("DEP","RESTYP=:RESTYP","CID=:XCID","/NOJOURNAL")
	if XCLS="L" do Db.update("LN","RESTYP=:RESTYP","CID=:XCID","/NOJOURNAL")
	
	quit 
	

GETNR(XACN)	// Get Non-Residency Indicator
	
	new NR

	set NR=Db.getOneRow("NR","CIF","XACN")

	if NR="" quit 0

	quit NR
	
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43489^Sanchez SCM Administrator^2852"	// Signature - LTD^TIME^USER^SIZE
