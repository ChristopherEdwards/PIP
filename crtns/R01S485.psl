R01S485	// SCA541 - Combined Journal Report
	// Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 08/30/2007 14:59 - joynerd

	type public Number ER=0
	type public Number vbatchq
	type public String IO,RM,VRWOPT()
	type public String %CRCD,TJD
	type Number OLNTB
	type String %READ,RID,RN,%TAB,VFMQ
	type Number OPT
	type String VIN10="ALL"
	type String VIN11="ALL"
	type Date VIN2=TJD.get()
	type String VIN3="ALL"
	type String VIN4="ALL"
	type String VIN5="ALL"
	type String VIN6="ALL"
	type String VIN7="ALL"
	type String VIN8="ALL"
	type String VIN9="ALL"

	set RID="SCA541"
	set RN="Combined Journal Report"
	if IO.get()="" set IO=$I

	do INIT^%ZM()

	do VPREBQ quit:VFMQ.get()			// Pre-processor (before query)

	set %TAB("IO")=$$IO^SCATAB
	set %TAB("OPT")="|1|||||||L|Create Sort File|||||"
	set %TAB("VIN10")="|255||[SCA541]CC|[UTBLCCNTR]:NOVAL||D EXT^DBSQRY||T|Cost Center|||||"
	set %TAB("VIN11")="|255||[SCA541]GLSC|||D EXT^DBSQRY||T|G/L Set Code|||||"
	set %TAB("VIN2")="|10||[SCA541]TJD|[SCA541]TJD:DISTINCT:NOVAL||S TJD=X||D|Balancing Date|||||"
	set %TAB("VIN3")="|255||[SCA541]BRCD|[UTBLBRCD]:NOVAL||D EXT^DBSQRY||T|Branch Code|||||"
	set %TAB("VIN4")="|255||[SCA541]UID|[SCA541]UID:DISTINCT:NOVAL||D EXT^DBSQRY||T|User ID|||||"
	set %TAB("VIN5")="|255||[SCA541]JNL|[SCA541]JNL:DISTINCT:NOVAL||D EXT^DBSQRY||T|Source (DTJ or DMJ)|||||"
	set %TAB("VIN6")="|255||[SCA541]CID|[ACN]:NOVAL||D EXT^DBSQRY||T|Account Number|||||"
	set %TAB("VIN7")="|255||[SCA541]CRCD|[CRCD]:NOVAL||D EXT^DBSQRY||T|Currency Code|||||"
	set %TAB("VIN8")="|255||[SCA541]TAMT|||D EXT^DBSQRY||T|Transaction Amount|||||"
	set %TAB("VIN9")="|255||[SCA541]ETC|||D EXT^DBSQRY||T|Transaction Code|||||"

	set %READ="IO/REQ,OPT#1,VIN2#1,VIN3#0,VIN4#0,VIN5#0,VIN6#0,VIN7#0,VIN8#0,VIN9#0,VIN10#0,VIN11#0,"

	// Skip device prompt option
	if VRWOPT("NOOPEN").get() set %READ=%READ.piece(",",2,99)

	set VFMQ=""
	if %READ'="" do { quit:VFMQ.get()="Q"
		set OLNTB=30
		set %READ="@RN/CEN#1,,"_%READ
		do ^UTLREAD
		}

	if 'vbatchq.get() do V0
	quit

V0	// External report entry point

	type Boolean VHIT
	type public Number AUXPTR,ER,VTBLNAM
	type public String IO,IOPAR,IOSL,IOTYP,%MSKD,RM,VDISTKEY,VRWOPT()
	type public String %CRCD,TJD
	type public Date VIN2
	type public Number OPT
	type public String VIN3,VIN4,VIN5,VIN6,VIN7,VIN8,VIN9,VIN10,VIN11
	type Number vcrt,VD(),VFMQ,vh(),vI,vlc,VLC,VNEWHDR,VOFFLG,VPN,VR,VRG,vs(),VSEQ,VT()
	type String VWHERE
	type Literal String VSELECT
	type String %TIM,CONAM,RID,RN,STSEQ,VL,VLOF,VRF(),VSTATS(),vCOL,vHDG,vc1,vc10,vc11,vc12,vc13,vc14,vc2,vc3,vc4,vc5,vc6,vc7,vc8,vc9,vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vovc7,vrundate,vsysdate

	type RecordCUVAR cuvar=Db.getRecord("CUVAR")

	set CONAM=CUVAR.conam
	set ER=0,RID="SCA541",RN="Combined Journal Report"
	set VL=""

	use 0 if 'VRWOPT("NOOPEN").get() do { quit:ER
		if 'VRWOPT("IOPAR").get().isNull() set IOPAR = VRWOPT("IOPAR")
		else  if ((IOTYP.get()="RMS")!(IOTYP.get()="PNTQ")),('IOPAR.get().isLike("%/OCHSET=%")),$$VALID^%ZRTNS("UCIOENCD") do {
			// Accept warning if ^UCIOENCD does not exist
			#ACCEPT Date=07/26/06; Pgm=RussellDS; CR=22121; Group=MISMATCH
			type String CHRSET=$$^UCIOENCD("Report","SCA541","V0","*")
			if 'CHRSET.isNull() set IOPAR = IOPAR_"/OCHSET="_CHRSET
		}
		do OPEN^SCAIO
	}
	set vcrt=(IOTYP="TRM")
	if 'vcrt set IOSL=60				// Non-interactive
	else  do {					// Interactive
		do TERM^%ZUSE(IO,"WIDTH=133")
		write $$CLEARXY^%TRMVT
		write $$SCR132^%TRMVT			// Switch to 132 col mode
		}

	do INIT^%ZM()

	set vCOL="[SCA541]CID#1#12,[SCA541]DATETIME#15#10,[SCA541]CC#29#6,[SCA541]GLSC#37#4,[SCA541]ETC#55#12,[SCA541]ITC7#69#1,[SCA541]TAMT#73#12,[SCA541]CRCD#87#3,[SCA541]TSO#92#40"

	// Build WHERE clause to use for dynamic query
	do {
		type Number SEQ=1
		type String DQQRY(),FROM
		set DQQRY(SEQ)="[SCA541]TJD = "_$$addqts^DBSRWUTL(VIN2),SEQ=SEQ+1
		if VIN3.get()="" set VIN3="ALL"
		if VIN3'="ALL" set DQQRY(SEQ)="[SCA541]BRCD "_VIN3,SEQ=SEQ+1
		if VIN4.get()="" set VIN4="ALL"
		if VIN4'="ALL" set DQQRY(SEQ)="[SCA541]UID "_VIN4,SEQ=SEQ+1
		if VIN5.get()="" set VIN5="ALL"
		if VIN5'="ALL" set DQQRY(SEQ)="[SCA541]JNL "_VIN5,SEQ=SEQ+1
		if VIN6.get()="" set VIN6="ALL"
		if VIN6'="ALL" set DQQRY(SEQ)="[SCA541]CID "_VIN6,SEQ=SEQ+1
		if VIN7.get()="" set VIN7="ALL"
		if VIN7'="ALL" set DQQRY(SEQ)="[SCA541]CRCD "_VIN7,SEQ=SEQ+1
		if VIN8.get()="" set VIN8="ALL"
		if VIN8'="ALL" set DQQRY(SEQ)="[SCA541]TAMT "_VIN8,SEQ=SEQ+1
		if VIN9.get()="" set VIN9="ALL"
		if VIN9'="ALL" set DQQRY(SEQ)="[SCA541]ETC "_VIN9,SEQ=SEQ+1
		if VIN10.get()="" set VIN10="ALL"
		if VIN10'="ALL" set DQQRY(SEQ)="[SCA541]CC "_VIN10,SEQ=SEQ+1
		if VIN11.get()="" set VIN11="ALL"
		if VIN11'="ALL" set DQQRY(SEQ)="[SCA541]GLSC "_VIN11,SEQ=SEQ+1
		set FROM=$$DQJOIN^SQLCONV("SCA541") quit:ER
		set VWHERE=$$WHERE^SQLCONV(.DQQRY,"")
		}

	// Print Report Banner Page
	if cuvar.banner,'VRWOPT("NOBANNER").get(),IOTYP'="TRM",'AUXPTR.get() do {
		type String VBNRINFO()

		set VBNRINFO("PROMPTS",2)="WC1|"_"Balancing Date"_"|VIN2|"_$$DAT^%ZM(VIN2.get(),%MSKD)
		set VBNRINFO("PROMPTS",3)="WC2|"_"Branch Code"_"|VIN3|"_VIN3.get()
		set VBNRINFO("PROMPTS",4)="WC2|"_"User ID"_"|VIN4|"_VIN4.get()
		set VBNRINFO("PROMPTS",5)="WC2|"_"Source (DTJ or DMJ)"_"|VIN5|"_VIN5.get()
		set VBNRINFO("PROMPTS",6)="WC2|"_"Account Number"_"|VIN6|"_VIN6.get()
		set VBNRINFO("PROMPTS",7)="WC2|"_"Currency Code"_"|VIN7|"_VIN7.get()
		set VBNRINFO("PROMPTS",8)="WC2|"_"Transaction Amount"_"|VIN8|"_VIN8.get()
		set VBNRINFO("PROMPTS",9)="WC2|"_"Transaction Code"_"|VIN9|"_VIN9.get()
		set VBNRINFO("PROMPTS",10)="WC2|"_"Cost Center"_"|VIN10|"_VIN10.get()
		set VBNRINFO("PROMPTS",11)="WC2|"_"G/L Set Code"_"|VIN11|"_VIN11.get()


		do {
			type Number SEQ
			type String VALUE,VAR,X
			set X=VWHERE
			set SEQ=""
			for  set SEQ=VBNRINFO("PROMPTS",SEQ).order() quit:SEQ=""  do {
				set VAR=VBNRINFO("PROMPTS",SEQ).piece("|",3))
				set VALUE=VBNRINFO("PROMPTS",SEQ).piece("|",4,99)
				set X=$$replace^DBSRWUTL(X,":"_VAR,"'"_VALUE_"'")
				}
			set VBNRINFO("WHERE")=X
			}

		set VBNRINFO("DESC")="Combined Journal Report"
		set VBNRINFO("PGM")="R01S485"
		set VBNRINFO("RID")="SCA541"
		set VBNRINFO("TABLES")="SCA541"

		set VBNRINFO("ORDERBY",1)="[SYSDEV,SCA541]TJD"
		set VBNRINFO("ORDERBY",2)="[SYSDEV,SCA541]BRCD"
		set VBNRINFO("ORDERBY",3)="[SYSDEV,SCA541]UID"
		set VBNRINFO("ORDERBY",4)="[SYSDEV,SCA541]JNL"
		set VBNRINFO("ORDERBY",5)="[SYSDEV,SCA541]DATETIME"
		set VBNRINFO("ORDERBY",6)="[SYSDEV,SCA541]CID"
		set VBNRINFO("ORDERBY",7)="[SYSDEV,SCA541]TSEQ"

		set VBNRINFO("DOC",1)="This report sorts entries in the Daily Transaction Journal (DTJ) and the Daily"
		set VBNRINFO("DOC",2)="Miscellaneous Journal (DMJ) by transaction date, branch code, user ID, journal"
		set VBNRINFO("DOC",3)="ID, account number and transaction sequence.  It provides a means to combine"
		set VBNRINFO("DOC",4)="both the Daily Transaction Journal and the Daily Miscellaneous Journal into a"
		set VBNRINFO("DOC",5)="single report.  It is intended to be used as a tool in identifying out of"
		set VBNRINFO("DOC",6)="balance errors.  Because of the amount of sorting involved, it is highly"
		set VBNRINFO("DOC",7)="recommended that this report be run only when needed and not as part of a"
		set VBNRINFO("DOC",8)="daily report stream."

		do ^DBSRWBNR(IO,.VBNRINFO)		// Print banner
		}

	// Initialize variables
	set (vc1,vc2,vc3,vc4,vc5,vc6,vc7,vc8,vc9,vc10,vc11,vc12,vc13,vc14)=""
	set (VFMQ,vlc,VLC,VOFFLG,VPN,VRG)=0
	set VHIT = 0
	set VNEWHDR=1
	set VLOF=""
	set %TIM=$$TIM^%ZM
	set vrundate=%CurrentDate.toString(),vsysdate=%SystemDate.toString()

	do {
		type Number I,J,K
		for I=0:1:7 do {
			set (vh(I),VD(I))=0,vs(I)=1	// Group break flags
			set VT(I)=0			// Group count
			for J=1:1:0 do {
				for K=1:1:3 set VT(I,J,K)=""	// Initialize function stats
				}
			}
		}

	do Db.delete("TMPRPTBR","JOBNO=:%ProcessID")	// Report browser data
	if VDISTKEY.get()="" do { quit:VFMQ		// Report Pre-processor (after query)
		do VPREAQ
		if VFMQ set vh(0)=1 do VEXIT(0)
		}

	set vh(0)=0

	// Run report directly
	do VINILAST

	set VSELECT=""
	set VSELECT=VSELECT_"SCA541.TSEQ,SCA541.TJD,SCA541.BRCD,SCA541.UID,SCA5"
	set VSELECT=VSELECT_"41.JNL,SCA541.DATETIME,SCA541.CID,SCA541.CC,SCA541"
	set VSELECT=VSELECT_".GLSC,SCA541.ETC,SCA541.ITC7,SCA541.TAMT,SCA541.CR"
	set VSELECT=VSELECT_"CD,SCA541.TSO"

	#ACCEPT DATE=08/30/2007;PGM=Report Writer Generator;CR=20967
	type ResultSet rwrs=Db.select(VSELECT,"SCA541",VWHERE,"SCA541.TJD,SCA541.BRCD,SCA541.UID,SCA541.JNL,SCA541.DATETIME,SCA541.CID,SCA541.TSEQ","","DQMODE=1")
	if ER.get() use 0 write $$MSG^%TRMVT(RM.get(),"",1)	// Debug Mode
	if rwrs.isEmpty() do VEXIT(1) quit
	while rwrs.next() do { quit:VFMQ
	type Boolean VSKIPREC = 0
		type String V,VI
		set V=rwrs.getRow().toString()
		set VI=""
		do VGETDATA(V,VI)
		do VFPOST quit:(VFMQ ! VSKIPREC)  set VHIT = 1
		do VPRINT quit:VFMQ
		do VSAVLAST
		}
	do VEXIT('VHIT)

	quit


VINILAST	// Initialize last access key values
	type Public String vovc2,vovc3,vovc4,vovc5,vovc6,vovc7,vovc1
	set vovc2="",vovc3="",vovc4="",vovc5="",vovc6="",vovc7="",vovc1=""
	quit

VSAVLAST	// Save last access keys values
	type Public String vovc2,vc2,vovc3,vc3,vovc4,vc4,vovc5,vc5,vovc6,vc6,vovc7,vc7,vovc1,vc1
	set vovc2=vc2,vovc3=vc3,vovc4=vc4,vovc5=vc5,vovc6=vc6,vovc7=vc7,vovc1=vc1
	quit


VGETDATA(String V,String VI)	//
	type Public String vc1,vc2,vc3,vc4,vc5,vc6,vc7,vc8,vc9,vc10,vc11,vc12,vc13,vc14
	set vc1=V.piece($C(9),1)			// SCA541.TSEQ
	set vc2=V.piece($C(9),2)			// SCA541.TJD
	set vc3=V.piece($C(9),3)			// SCA541.BRCD
	set vc4=V.piece($C(9),4)			// SCA541.UID
	set vc5=V.piece($C(9),5)			// SCA541.JNL
	set vc6=V.piece($C(9),6)			// SCA541.DATETIME
	set vc7=V.piece($C(9),7)			// SCA541.CID
	set vc8=V.piece($C(9),8)			// SCA541.CC
	set vc9=V.piece($C(9),9)			// SCA541.GLSC
	set vc10=V.piece($C(9),10)			// SCA541.ETC
	set vc11=V.piece($C(9),11)			// SCA541.ITC7
	set vc12=V.piece($C(9),12)			// SCA541.TAMT
	set vc13=V.piece($C(9),13)			// SCA541.CRCD
	set vc14=V.piece($C(9),14)			// SCA541.TSO
	quit

	// User-defined pre/post-processor code

VFPOST	// FETCH post-processor

	type public String vc1
	/* ------------ Revision History ------------------------

	07/04/07 - SATYANAS - CR 27836
		   Removed the statement to set the value of STSEQ 
		   by extracting the 11th to 18th piece of STSEQ. 
	 	   Because TSEQ is holding the data of maximum size of 9.

	------------------------------------------------------ */

	type public Number STSEQ

	set STSEQ=vc1
	quit

VPREAQ	// Pre-processor (after query)

	/*---- Revision History --------------------------------------------

	08/07/07 - SATYANAS - CR 28485
		   Modified DTJ and DMJ sections to pass DATETIME as
		   parameter for Db.getRecord() method for SCA541 file.
	
	07/04/07 - SATYANAS - CR 27836
		   Modified the DTJ section to get the value of CC from 
		   DTJ.SUMM. Previouly CC value was getting from DTJ.CC
		   which doesn't hold the value of Cost Center, Product
		   Type and G/L Set Code.

	----------------------------------------------------------------- */

	type public Boolean OPT

	set OPT=$G(OPT)

	if 'OPT do {	
		type ResultSet rs=Db.select("TJD","SCA541","TJD=:%SystemDate") 
		if rs.isEmpty() set OPT=1
	
		if 'OPT do {
			type ResultSet rs=Db.select("TJD","SCA542","TJD=:%SystemDate") 
			if rs.isEmpty() set OPT=1
			}
		}


	if OPT do {

		do Db.delete("SCA541","TJD=:%SystemDate")

		//I18N=OFF
		do Db.delete("SCA542","TJD=:%SystemDate")

		do DTJ
		do DMJ

		}


	type ResultSet rssca541=Db.select("DISTINCT TJD","SCA541","TJD<:%SystemDate-7")
	while rssca541.next() do Db.fastDelete("SCA541",rssca541.getCol("TJD"))

	
	type ResultSet rssca542=Db.select("DISTINCT TJD","SCA542","TJD<:%SystemDate-7")
	while rssca542.next() do Db.fastDelete("SCA542",rssca542.getCol("TJD"))

	quit 


DTJ	//

	type String CC,CRCD,ER,GLSC

	type Number i

	type DbSet rs=Db.selectDbSet("DTJ","TJD=:%SystemDate")
	while rs.next() do {
		type RecordDTJ fDTJ=rs.getRecord("DTJ")
 
		set CC=fDTJ.summ
		set GLSC=$P(CC,"#",3)
		set CC=$P(CC,"#",1)
 
		set CRCD=fDTJ.crcd
 
 
		if CRCD="" set CRCD=%SystemCurrency
 
		// Detail data for report SCA541
 
		type RecordSCA541 fSCA541=Db.getRecord("SCA541","TJD=:%SystemDate,BRCD=:fDTJ.brcd,UID=:fDTJ.uid,JNL=""DTJ"",DATETIME=:fDTJ.datetime,CID=:fDTJ.cid,TSEQ=:fDTJ.tseq",1)
 
		set fSCA541.cc=CC
		set fSCA541.itc=fDTJ.itc
		set fSCA541.etc=fDTJ.etc
		 
		set fSCA541.tamt=fDTJ.tamt
		set fSCA541.tso=fDTJ.tso
		set fSCA541.crcd=CRCD
		set fSCA541.glsc=GLSC
		 
		do fSCA541.save()
		 
		set i=$E(fSCA541.itc)*2+$S($E(fSCA541.itc,7):4,1:0)
		set i=i+1
 
		do SAVE542(fDTJ.brcd,fDTJ.uid,CRCD,fDTJ.etc,fDTJ.tamt,i)
 
		}

	quit


DMJ	//

	type String CC,CRCD,ER,GLSC

	type Number i

	type DbSet rs=Db.selectDbSet("DMJ","TJD=:%SystemDate")
	while rs.next() do {
 
		type RecordDMJ fDMJ=rs.getRecord("DMJ")

		set CC=fDMJ.cc
		set GLSC=""
 
		set CRCD=fDMJ.crcd
 
		if CRCD="" set CRCD=%SystemCurrency
 
		// Detail data for report SCA541
 
		type RecordSCA541 fSCA541=Db.getRecord("SCA541","TJD=:%SystemDate,BRCD=:fDMJ.brcd,UID=:fDMJ.UID,JNL=""DMJ"",DATETIME=:fDMJ.datetime,CID=:fDMJ.cid,TSEQ=:fDMJ.tseq",1)
 
		set fSCA541.cc=CC
		set fSCA541.itc=fDMJ.itc
		set fSCA541.etc=fDMJ.etc
		set fSCA541.tamt=fDMJ.tamt
		set fSCA541.tso=fDMJ.tso
		set fSCA541.crcd=CRCD
		set fSCA541.glsc=GLSC
 
		do fSCA541.save()
 
		set i=$E(fSCA541.itc)*2+$S($E(fSCA541.itc,7):4,1:0)
		set i=i+1
 
		do SAVE542(fDMJ.brcd,fDMJ.uid,CRCD,fDMJ.etc,fDMJ.tamt,i)
 
		}
 
	quit


SAVE542(Number BRCD,String UID,String CRCD,String ETC,Number TAMT,Number i)	// Create SCA542 record

	type RecordSCA542 sca542=Db.getRecord("SCA542","TJD=:%SystemDate,BRCD=:BRCD,UID=:UID,CRCD=:CRCD,ETC=:ETC",1)
 
	if i=1 do {
		set sca542.pridrcnt=sca542.pridrcnt+1
		set sca542.pridramt=sca542.pridramt+TAMT
		}
 
	if i=3 do {
		set sca542.pricrcnt=sca542.pricrcnt+1
		set sca542.pricramt=sca542.pricramt+TAMT
		}
 
	if i=5 do {
		set sca542.sysdrcnt=sca542.sysdrcnt+1
		set sca542.sysdramt=sca542.sysdramt+TAMT
		}
 
	if i=7 do {
		set sca542.syscrcnt=sca542.syscrcnt+1
		set sca542.syscramt=sca542.syscramt+TAMT
		}
 
	do sca542.bypassSave()

	quit

PRE(Date TJD,Number OPT) ;Report pre-processor

	 set OPT=$G(OPT)

 	if Db.isDefined("SCA541B","TJD") set OPT=1
 	if Db.isDefined("SCA542B","TJD") set OPT=1
 
 if OPT do {

	do Db.delete("SCA541B","TJD=:%SystemDate")
	do Db.delete("SCA542B","TJD=:%SystemDate")	
 	do DTJ,DMJ
	type RecordSCA541B sca541b = Db.getRecord("SCA541B","TJD=:%SystemDate",1)
	set sca541b.dattim=$H
	type RecordSCA542B sca542b = Db.getRecord("SCA542B","TJD=:%SystemDate",1)
        set sca542b.dattim=$H	
	do sca541b.bypassSave()
	do sca542b.bypassSave()
	do DEL(TJD-7)
	}
 quit

DEL(Date JD) ;Delete data prior to JD
  
  do Db.delete("SCA541","TJD<:JD")
  do Db.delete("SCA541B","TJD<:JD")
  do Db.delete("SCA542","TJD<:JD")
  do Db.delete("SCA542B","TJD<:JD")

	quit

VPREBQ	// Pre-processor (before query)

	//Incoming=%SystemCurrency
	quit

VBRSAVE(Number LINE,String DATA)	// Save for report browser
	type RecordTMPRPTBR tmprptbr=Class.new("RecordTMPRPTBR")
	set tmprptbr.jobno=%ProcessID
	set tmprptbr.lineno=LINE
	set tmprptbr.pageno=0
	set tmprptbr.seq=0
	set tmprptbr.data=DATA
	do tmprptbr.bypassSave()
	quit

VEXIT(NOINFO)	// Exit from report
	type Public Number IOSL,vcrt,VFMQ,vh(),VLC,VPN,VRWOPT,VSTATS()
	type Public String IO,VTBLNAM
	type Number I,PN,vs(),z
	type String VL=""
	set vs(1)=0,vs(2)=0,vs(3)=0,vs(4)=0,vs(5)=0,vs(6)=0,vs(7)=0
	if 'VFMQ do VSUM
	if 'vh(0) do VHDG0
	if 'VFMQ do {
		// No information available to display
		if NOINFO=1 set VL=$$^MSG(4655) do VOM
		if vcrt set VL="" for z=VLC+1:1:IOSL do VOM

		if 'VTBLNAM.exists() do {
			set vs(2)=0
			}
		}

	if 'VFMQ,vcrt set PN=-1 do ^DBSRWBR(2)
	if 'VRWOPT("NOCLOSE").get() do CLOSE^SCAIO
	do Db.delete("TMPRPTBR","JOBNO=:%ProcessID")	// Report browser data

	quit

VPRINT	// Print section
	type Public Number VD(),VFMQ,VH0,vh(),VNEWHDR,VR,VRG,VRWOPT,VSEQ
	type Number vskp()

	if VRWOPT("NODTL").get() set vskp(1)=1,vskp(2)=1,vskp(3)=1,vskp(4)=1,vskp(5)=1,vskp(6)=1,vskp(7)=1	// Skip detail
	do VBREAK
	do VSUM quit:VFMQ

	if VH0.get() set vh(0)=0,VNEWHDR=1 kill VH0	// Page Break
	if 'vh(0) do VHDG0 quit:VFMQ
	do VHDG6 quit:VFMQ
	if 'vskp(7).get() do VDTL7 quit:VFMQ
	do VSTAT
	quit

VBREAK	//
	type Public Number VD(),vh(),VH0,vs(),VT()
	quit:'VT(7)
	type Public String vc2,vovc2,vc3,vovc3,vc4,vovc4,vc5,vovc5,vc6,vovc6,vc7,vovc7,vc1,vovc1
	type Number vb1,vb2,vb3,vb4,vb5,vb6,vb7
	set (vb1,vb2,vb3,vb4,vb5,vb6,vb7)=0
	if vb1!(vovc2'=vc2) set vs(2)=0,vh(2)=0,VD(1)=0,vb2=1,vb3=1,vb4=1,vb5=1,vb6=1,vb7=1,VH0=1
	if vb2!(+vovc3'=+vc3) set vs(3)=0,vh(3)=0,VD(2)=0,vb3=1,vb4=1,vb5=1,vb6=1,vb7=1,VH0=1
	if vb3!(vovc4'=vc4) set vs(4)=0,vh(4)=0,VD(3)=0,vb4=1,vb5=1,vb6=1,vb7=1,VH0=1
	if vb4!(vovc5'=vc5) set vs(5)=0,vh(5)=0,VD(4)=0,vb5=1,vb6=1,vb7=1,VH0=1
	if vb5!(+vovc6'=+vc6) set vs(6)=0,vh(6)=0,VD(5)=0,vb6=1,vb7=1,VH0=1
	if vb6!(+vovc7'=+vc7) set vs(7)=0,vh(7)=0,VD(6)=0,vb7=1
	quit

VSUM	// Report Group Summary
	type Public Number VFMQ,vs()
	if 'vs(7) set vs(7)=1 do stat^DBSRWUTL(7)
	if 'vs(6) set vs(6)=1 do stat^DBSRWUTL(6)
	if 'vs(5) set vs(5)=1 do stat^DBSRWUTL(5)
	if 'vs(4) set vs(4)=1 do stat^DBSRWUTL(4)
	if 'vs(3) set vs(3)=1 do stat^DBSRWUTL(3)
	if 'vs(2) set vs(2)=1 do stat^DBSRWUTL(2)
	quit

VSTAT	// Data field statistics
	type Public Number VRWOPT(),VT()
	type Public String VSTATS

	set VT(7)=VT(7)+1
	quit

VHDG6	// Group Header
	type public String %CRCD,%MSKD,%TIM,CONAM,ER,IOSL,OPT,RID,RN,STSEQ,TJD,V,VFMQ,VL,VLC,VNEWHDR,VO,VOFFLG,VPN,VRG,vc1,vc10,vc11,vc12,vc13,vc14,vc2,vc3,vc4,vc5,vc6,vc7,vc8,vc9,vcrt,verror,vh(),vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vovc7,vrundate,vsysdate

	quit:vh(6)  set vh(6)=1				// Print flag
	if VLC+4>IOSL do VHDG0 quit:VFMQ

	set VL="Balancing Date: "
	set VL=VL_$J("",16-VL.length())_$J($$DAT^%ZM(vc2),10)
	set VL=VL_$J("",29-VL.length())_"Branch:"
	set VL=VL_$J("",37-VL.length())_$J(vc3,6)
	set VL=VL_$J("",46-VL.length())_"User ID:"
	set VL=VL_$J("",55-VL.length())_$E(vc4,1,20)
	set VL=VL_$J("",78-VL.length())_"Source:"
	set VL=VL_$J("",86-VL.length())_$E(vc5,1,3)
	do VOM
	set VL="" do VOM
	set VL="     "_"Account   Date/Time  Cost Ctr  GLSC   Tran Seq   Tran Code    Pri   Tran Amount       Source"
	do VOM
	set VL="================================================================================================================================="
	do VOM
	quit

VDTL7	// Detail
	type public String %CRCD,%TIM,IOSL,OPT,STSEQ,TJD,V,VD(),VFMQ,VL,VLC,VO,VOFFLG,VPN,VRG,VT(),vc1,vc10,vc11,vc12,vc13,vc14,vc2,vc3,vc4,vc5,vc6,vc7,vc8,vc9,verror,vh(),vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vovc7,vrundate,vsysdate

	if VLC+1>IOSL do VHDG0 quit:VFMQ

	set VL=$J(vc7,12)
	set VL=VL_$J("",14-VL.length())_$J(vc6,10)
	set VL=VL_$J("",28-VL.length())_$J(vc8,6)
	set VL=VL_$J("",36-VL.length())_$E(vc9,1,4)
	do VP1 quit:VFMQ!verror.get()  set V=$J(STSEQ,8)
	set VL=VL_$J("",43-VL.length())_V
	set VL=VL_$J("",54-VL.length())_$E(vc10,1,12)
	set VL=VL_$J("",68-VL.length())_$S(vc11:"Y",1:"N")
	set VL=VL_$J("",72-VL.length())_$J($FN(vc12,",",2),12)
	set VL=VL_$J("",86-VL.length())_$E(vc13,1,3)
	set VL=VL_$J("",91-VL.length())_$E(vc14,1,40)
	do VOM
	quit


VHDG0	// Page Header
	type Public Number ER,IOSL,vcrt,verror,VFMQ,vh(),VLC,VNEWHDR,VPN,VRG,VRWOPT()
	type public String %CRCD,%MSKD,%TIM,CONAM,OPT,RID,RN,STSEQ,TJD,VL,vc1,vc10,vc11,vc12,vc13,vc14,vc2,vc3,vc4,vc5,vc6,vc7,vc8,vc9,vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vovc7,vrundate,vsysdate
	type Number PN,V,VO
	if VRWOPT("NOHDR").get() quit			// Skip page header
	set vh(0)=1,VRG=0
	if VL'="" do VOM
	if vcrt,VPN>0 do { quit:VFMQ!'VNEWHDR
		type Number PN,X
		set VL=""
		for X=VLC+1:1:IOSL do VOM
		set PN=VPN
		do ^DBSRWBR(2)
		set VLC=0
		quit:VFMQ
		if VNEWHDR write $$CLEARXY^%TRMVT
		else  set VLC=VLC+3,VPN=VPN+1
		}

	set ER=0,VPN=VPN+1,VLC=0

	set VL=$E($G(CONAM),1,45)
	set VL=VL_$J("",100-VL.length())_"Run Date:"
	set VL=VL_$J("",110-VL.length())_$E(vrundate,1,10)
	set VL=VL_$J("",123-VL.length())_$E(%TIM,1,8)
	do VOM
	set VL=RN_"  ("_RID_")"
	set VL=VL_$J("",102-VL.length())_"System:"
	set VL=VL_$J("",110-VL.length())_$E(vsysdate,1,10)
	set VL=VL_$J("",122-VL.length())_"Page:"
	set VL=VL_$J("",128-VL.length())_$J(VPN,3)
	do VOM
	set VL="" do VOM

	set VNEWHDR=0
	if vcrt set PN=VPN do ^DBSRWBR(2,1)		// Lock report page heading

	quit


VOM	// Output print line
	type Public Number AUXPTR,vcrt,vlc,VLC,VRG
	type Public String IO,VL

	use IO

	// Advance to a new page
	if 'VLC,'vcrt do {				// Non-CRT device (form feed)
		if 'AUXPTR.get() write $C(12),!
		else  write $$PRNTFF^%TRMVT,!
		set $Y=1
		}

	if vcrt<2 write VL,!				// Output line buffer
	if vcrt set vlc=vlc+1 do VBRSAVE(vlc,VL)	// Save in BROWSER buffer
	set VLC=VLC+1,VL=""				// Reset line buffer
	quit

	// Pre/post-processors

VP1	// Column pre-processor - Variable: STSEQ


	quit
