WPFT		//;PBS -  Agent Weighted Portfolio Maintenance Routine
	/*
	;Copyright(c)2000 Sanchez Computer Associates, Inc.  All Rights Reserved - 05/02/01 - GORDONT
	ORIG:  GORDONT
	DESC: Agent Weighted Portfolio Maintenance Routine

		This procedure provides means to add queries and weighing
		factors to weighted portfolios.
                The ability to modify the queries and weighing factors
                as well as to inquire and delete is also provided.
	 
           EXAMPLE:
           	D UPD^WPF
 

	 ---- Revision History ------------------------------------------------
	 
	 10/26/05 - SPR - CR17008
			Agent/Commission - General DBI3 system area cleanup.	
		  
	 ----------------------------------------------------------------------
	
	*/
	
	quit
	

NEW	
	do INIT(0) quit
	
	
UPD	 
	do INIT(1) quit
	
	
INQ	
	do INIT(2) quit
	
	
DEL	
	do INIT(3) quit
	

INIT(%ProcessMode)	//--------------------------------------------------------------------
	
	type public String VFMQ
	type Number MAX,%PAGE,%PG
	type String GTB(),ODES
	
	set %PG=0 
	set %PAGE=1
	set MAX=13
			
	kill VFMQ
	
	do VPG

	quit 
	

VPG     // Page control

	type public Number %PG,%PAGE 	
	type public String VFMQ
	type Boolean FINISH
	type String DES
	
	set DES=""
	set FINISH=0

	for  do { quit:FINISH

		if %PG=0 do VPG00 if VFMQ="Q" set FINISH=1 quit
		if "DFQ"[VFMQ set FINISH=1 quit

		if %PG>0 do VPG01 if VFMQ="Q" set FINISH=1 quit
		if "DFQ"[VFMQ do VER set FINISH=1 quit
		set %PG=%PG+1
		}

	quit 
	
	
VPG00 	// Set up screen for Weighted Portfolio Table

	type public Number CNT,MAX,%PAGE  
	type public String VFMQ
	type String I,IO,%NOPRMT,%READ,%TAB()
	 
	set %TAB("WPFT")="[UTBLWPFT]WPFT/HLP=[UTBLWPFT]WPFT/TBL=[UTBLWPFT]:NOVAL/XPP=D POSGTBL^WPFT"
	if %ProcessMode=2 set %TAB("IO")=$$IO^SCATAB($I)

	set %READ="@@%FN,,,WPFT/REQ" set %NOPRMT="F"
	if %ProcessMode=2 set %READ=%READ_",IO/REQ"
	
	do ^UTLREAD if VFMQ="Q" quit 
	
	if %ProcessMode=2,IO'=$I do OPEN^SCAIO
	
	// Call function to load weighted portfolio table
	do LOAD
	
        if (%ProcessMode=2)!(%ProcessMode=3)  do {
		set %PAGE=CNT\MAX
		if CNT#MAX set %PAGE=%PAGE+1
		}
		
	quit
        
        
NOTEXIST  // Check if exists in UTBLWPFTQ before modify?
	
	type ResultSet rs=Db.select("WPQRYNUM","UTBLWPFTQ","WPFT=:WPFT")
	
	// Modify Existing Records Only
	if rs.isEmpty(),%ProcessMode=1 do Runtime.setErrMSG("UTBLWPFTQ",8156)
 
        quit
        
	
VPG01 	// Screen Set Up for data entry
	
	type public Number GTB(),MAX,%PG
	type public String WPFT
	type Number %MODS,%REPEAT
	type String SID
	
	
	set %REPEAT=MAX	
	set %MODS=(MAX*(%PG-1))+1
	
	type RecordUTBLWPFT fUTBLWPF

	if %ProcessMode=0 set GTB(1)="1|||"

	set fUTBLWPF=Db.getRecord("UTBLWPFT","WPFT=:WPFT",1)
	set SID="UTBLWPFT"
	
	do DRV^USID(%ProcessMode,SID,.fUTBLWPF)
	
	quit 


POSGTBL	// Post processor for Weighted Portfolio Table prompt
	
	type public Number X
	type Number I()
	
	//  ~p1 already exists
        if '%ProcessMode=0 & (Db.isDefined("UTBLWPFT","X")) do Runtime.setErrMSG("UTBLWPFT",3019,X) quit 
	
	if '%ProcessMode=0 & '(Db.isDefined("UTBLWPFT","X")) set I(3)=""
	
	quit		

 
LOAD 	// Load Weighted Portfolio data
	
	type public String DES,GTB(),ODES,WPFT
	type public Number CNT
	type Number cnt,WPQRYNUM,WFCT
	type String WPQRYNAM
	
	set cnt=0
		
	type ResultSet rs=Db.select("WPQRYNAM,WPQRYNUM,WFCT","UTBLWPFTQ","WPFT=:WPFT")
	while rs.next()  do {
		set WPQRYNAM=rs.getCol("WPQRYNAM")
		set WPQRYNUM=rs.getCol("WPQRYNUM")
		set WFCT=rs.getCol("WFCT")
		set GTB(WPQRYNUM)=WPQRYNUM_"|"_WPQRYNAM_"|"_WFCT
		set cnt=cnt+1
		}
	
	if (%ProcessMode=2)!(%ProcessMode=3) set CNT=cnt
		
	type RecordUTBLWPFT utblwpft=Db.getRecord("UTBLWPFT","WPFT=:WPFT",1)
	set DES=utblwpft.des
	set ODES=DES	
	
	quit 
	
	
ERR 	
	type public Boolean ER
	type public String VFMQ
	
	set ER=1 do ^UTLERR
	set VFMQ="Q"
	
	quit 
	
	
VER 	
	type public Boolean ER
	type public String VFMQ
	
	if (%ProcessMode=2)!(%ProcessMode=4)!(VFMQ="Q") do END quit
	if %ProcessMode=3 do DELETE do END quit
	do FILE quit:ER
        do END quit	

		
FILE	// File data
	
	type public Boolean ER
	type public Number GTB(),WFCT,WPQRYNUM
	type public String DES,ODES,WPFT,WPQRYNAM
	type Number seq
	
	// Nothing to file if in inquiry mode
	if %ProcessMode=2 quit		

	/* 
	   First file the top level information and then file the individual
	   weighted portfolio queries.
	*/
	
	if DES'=ODES.get() do {
	
		type RecordUTBLWPFT utblwpft=Db.getRecord("UTBLWPFT","WPFT=:WPFT",1)
		set utblwpft.wpft=WPFT
		set utblwpft.des=DES
		do utblwpft.save()
		}

	
	// Loop through the user table and remove the records before the update
	if (%ProcessMode=1)!(%ProcessMode=3) do { quit:ER
		type ResultSet rs=Db.select("WPQRYNUM","UTBLWPFTQ","WPFT=:WPFT")
		for  quit:'rs.next()  do { quit:ER
			set WPQRYNUM=rs.getCol("WPQRYNUM")
			do Db.delete("UTBLWPFTQ","WPFT=:WPFT AND WPQRYNUM=:WPQRYNUM")	// 
			} // end for
		} // if

	/* 
	   If in delete mode, all records have been deleted at this point, so 
	   do not process insert loop
	*/
	set (seq,WPQRYNUM)=0
	if %ProcessMode'=3 do {
        	for  set seq=GTB(seq).order() quit:seq=""  do { quit:ER
			set WPQRYNAM=GTB(seq).piece("|",2)
			quit:WPQRYNAM=""

			set WPQRYNUM=WPQRYNUM+1
			set WFCT=GTB(seq).piece("|",3)

			type RecordUTBLWPFTQ wpftq=Db.getRecord("UTBLWPFTQ","WPFT=:WPFT,WPQRYNUM=:WPQRYNUM",1)
			set wpftq.wfct=WFCT
			set wpftq.wpft=WPFT
			set wpftq.wpqrynam=WPQRYNAM
			set wpftq.wpqrynum=WPQRYNUM
			do wpftq.save()	
			
			} // end for
		} // end do


	/* 
	   Regardless of process mode, recompile the Commission Portfolio 
	   routine
	*/
	do PFT^COMQRY quit:ER

	quit


DELETE	// Delete Weighted Portfolio and its detail table

	type public Boolean ER
	type public String WPFT,WPQRYNUM

	if %ProcessMode=3 do {
		set WPQRYNUM=""
        	type ResultSet rs=Db.select("WPFT,WPQRYNUM","UTBLWPFTQ","WPFT=:WPFT")
			if rs.isEmpty() quit
			while rs.next() do {
				set WPFT=rs.getCol("WPFT")
				set WPQRYNUM=rs.getCol("WPQRYNUM")
				do Db.delete("UTBLWPFTQ","WPFT=:WPFT AND WPQRYNUM=:WPQRYNUM")
				}
		}
	do Db.delete("UTBLWPFT","WPFT=:WPFT")
	
	do PFT^COMQRY quit:ER
			
	quit	
	
	
END 	//  Display return Messages
	
	
	type public String ER,VFMQ,WPFT
	
	quit:ER.get()!(%ProcessMode=2)!(%ProcessMode=4) 
	set WPFT=WPFT.get()
	
	if VFMQ="Q" do {
		// Weighted Portfolio table ~p1 not created
		if %ProcessMode=0 do Runtime.setErrMSG("UTBLWPFT",2593,WPFT) quit   
		//Weighted Portfolio table ~p1 not modified
		if %ProcessMode=1 do Runtime.setErrMSG("UTBLWPFT",2596,WPFT) quit 
		// Weighted Portfolio table ~p1 not deleted
		do Runtime.setErrMSG("UTBLWPFT",2595,WPFT)              
		}
	else  do {
		// Table ~p1 created
		if %ProcessMode=0 do Runtime.setErrMSG("UTBLWPFT",2590,WPFT) quit  
		// Table ~p1 modified
		if %ProcessMode=1 do Runtime.setErrMSG("UTBLWPFT",2592,WPFT) quit 
		// Weighted Portfolio table ~p1 deleted
		do Runtime.setErrMSG("UTBLWPFT",2591,WPFT)              
		}
	set ER="W"
	
	quit 
 #OPTION ResultClass ON
Public String vSIG()	quit "60207^38679^Renga SP^6595"	// Signature - LTD^TIME^USER^SIZE
