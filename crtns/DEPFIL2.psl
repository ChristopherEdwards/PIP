DEPFIL2 // DEP DATA-QWIK filer, part (4)
 // Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 06/01/2007 01:32 - lc7022

	quit		// Not called from top

VJOURNAL(RecordDEP dep)	//DEP Journal file entries

	type Public Date %EffectiveDate
	type Public String %TSRC,vpar,vx()
	type String TSRC,vdi,vdx()

	if %TSRC.get().isNull() set TSRC="O"
	else  set TSRC=%TSRC

	if %ProcessMode=0 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj7(.dep)	// Mode=I Tran=B EFD=N Seq=1 JRNID=DTJNAACN_I
				do vj8(.dep)	// Mode=I Tran=B EFD=N Seq=1 JRNID=DTJNA_I
				do vj12(.dep)	// Mode=I Tran=B EFD=N Seq=1 JRNID=HIST_I
				}
			}
		else  if TSRC="O" do {
			if EFD.get() do {
				do vj2(.dep)	// Mode=I Tran=O EFD=E Seq=1 JRNID=ACTIBPAY2
				}
			else  do {
				do vj2(.dep)	// Mode=I Tran=O EFD=N Seq=1 JRNID=ACTIBPAY2
				do vj7(.dep)	// Mode=I Tran=O EFD=N Seq=1 JRNID=DTJNAACN_I
				do vj8(.dep)	// Mode=I Tran=O EFD=N Seq=1 JRNID=DTJNA_I
				do vj12(.dep)	// Mode=I Tran=O EFD=N Seq=1 JRNID=HIST_I
				}
			}
		}
	else  if %ProcessMode=1 do {
		if TSRC="B" do {
			if EFD.get() do {
				do vj13(.dep)	// Mode=U Tran=B EFD=E Seq=1 JRNID=HIST_U
				quit:'vx.data()
				if vx("GCRCD").data() do vj9(.dep,"GCRCD")	// Mode=U Tran=B EFD=E Seq=1 JRNID=GCRCODE
				}
			else  do {
				do vj13(.dep)	// Mode=U Tran=B EFD=N Seq=1 JRNID=HIST_U
				quit:'vx.data()
				if vx("STAT").data() do vj5(.dep,"STAT")	// Mode=U Tran=B EFD=N Seq=1 JRNID=CMSRECCID
				if vx("GCRCD").data() do vj9(.dep,"GCRCD")	// Mode=U Tran=B EFD=N Seq=1 JRNID=GCRCODE
				if vx("CRCD").data() do vj6(.dep,"CRCD")	// Mode=U Tran=B EFD=N Seq=2 JRNID=CRCD_TO_U
				if vx("TYPE").data() do vj14(.dep,"TYPE")	// Mode=U Tran=B EFD=N Seq=2 JRNID=TYPE_FROM_U
				if vx("TYPE").data() do vj15(.dep,"TYPE")	// Mode=U Tran=B EFD=N Seq=2 JRNID=TYPE_TO_U
				if vx("GLSC").data() do vj10(.dep,"GLSC")	// Mode=U Tran=B EFD=N Seq=3 JRNID=GLSC_FROM_U
				if vx("GLSC").data() do vj11(.dep,"GLSC")	// Mode=U Tran=B EFD=N Seq=3 JRNID=GLSC_TO_U
				if vx("CC").data() do vj3(.dep,"CC")	// Mode=U Tran=B EFD=N Seq=4 JRNID=CC_FROM_U
				if vx("CC").data() do vj4(.dep,"CC")	// Mode=U Tran=B EFD=N Seq=4 JRNID=CC_TO_U
				}
			}
		else  if TSRC="O" do {
			if EFD.get() do {
				do vj13(.dep)	// Mode=U Tran=O EFD=E Seq=1 JRNID=HIST_U
				quit:'vx.data()
				if vx("ACTIBPAY").data() do vj1(.dep,"ACTIBPAY")	// Mode=U Tran=O EFD=E Seq=1 JRNID=ACTIBPAY
				if vx("GCRCD").data() do vj9(.dep,"GCRCD")	// Mode=U Tran=O EFD=E Seq=1 JRNID=GCRCODE
				}
			else  do {
				do vj13(.dep)	// Mode=U Tran=O EFD=N Seq=1 JRNID=HIST_U
				quit:'vx.data()
				if vx("ACTIBPAY").data() do vj1(.dep,"ACTIBPAY")	// Mode=U Tran=O EFD=N Seq=1 JRNID=ACTIBPAY
				if vx("STAT").data() do vj5(.dep,"STAT")	// Mode=U Tran=O EFD=N Seq=1 JRNID=CMSRECCID
				if vx("GCRCD").data() do vj9(.dep,"GCRCD")	// Mode=U Tran=O EFD=N Seq=1 JRNID=GCRCODE
				if vx("CRCD").data() do vj6(.dep,"CRCD")	// Mode=U Tran=O EFD=N Seq=2 JRNID=CRCD_TO_U
				if vx("TYPE").data() do vj14(.dep,"TYPE")	// Mode=U Tran=O EFD=N Seq=2 JRNID=TYPE_FROM_U
				if vx("TYPE").data() do vj15(.dep,"TYPE")	// Mode=U Tran=O EFD=N Seq=2 JRNID=TYPE_TO_U
				if vx("GLSC").data() do vj10(.dep,"GLSC")	// Mode=U Tran=O EFD=N Seq=3 JRNID=GLSC_FROM_U
				if vx("GLSC").data() do vj11(.dep,"GLSC")	// Mode=U Tran=O EFD=N Seq=3 JRNID=GLSC_TO_U
				if vx("CC").data() do vj3(.dep,"CC")	// Mode=U Tran=O EFD=N Seq=4 JRNID=CC_FROM_U
				if vx("CC").data() do vj4(.dep,"CC")	// Mode=U Tran=O EFD=N Seq=4 JRNID=CC_TO_U
				}
			}
		}

	quit


vj1(RecordDEP dep,String vdi)	// ACTIBPAY  Table ABPJNL  Activate for Bill Pay

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=dep.cid
	type RecordABPJNL abpjnl=Db.getRecord("ABPJNL","TJD=:v1,CID=:vlastkey",1)
	set abpjnl.actibpay=dep.actibpay

	do abpjnl.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj2(RecordDEP dep)	// ACTIBPAY2  Table ABPJNL  Activate for Bill Pay on Insert

	if +dep.actibpay=1
	else  quit

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=dep.cid
	type RecordABPJNL abpjnl=Db.getRecord("ABPJNL","TJD=:v1,CID=:vlastkey",1)
	set abpjnl.actibpay=dep.actibpay

	do abpjnl.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj3(RecordDEP dep,String vdi)	// CC_FROM_U  Table DAYENDXFR  Cost Center Change - From Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.aiacr=dep.aiacr
	set dayendxfr.cc=dep.cc.oldVal
	set dayendxfr.ccc=dep.cc.curVal
	set dayendxfr.ccrcd=dep.crcd
	set dayendxfr.cglsc=dep.glsc
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd
	set dayendxfr.ctype=dep.type
	set dayendxfr.glsc=dep.glsc
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.negacrun=dep.negacrun
	set dayendxfr.prn=dep.bal
	set dayendxfr.resint=dep.resint
	set dayendxfr.type=dep.type
	set dayendxfr.uncacr=dep.uncacr
	set dayendxfr.xflg=0

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj4(RecordDEP dep,String vdi)	// CC_TO_U  Table DAYENDXFR  Product Type Change - To Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.aiacr=dep.aiacr
	set dayendxfr.cc=dep.cc.curVal
	set dayendxfr.ccc=dep.cc.oldVal
	set dayendxfr.ccrcd=dep.crcd
	set dayendxfr.cglsc=dep.glsc
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd
	set dayendxfr.ctype=dep.type
	set dayendxfr.glsc=dep.glsc
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.negacrun=dep.negacrun
	set dayendxfr.prn=dep.bal
	set dayendxfr.resint=dep.resint
	set dayendxfr.type=dep.type
	set dayendxfr.uncacr=dep.uncacr
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj5(RecordDEP dep,String vdi)	// CMSRECCID  Table CMSRECCID  Adds CMSREC entry for mod. DEP records

	if +dep.carduf=1
	else  quit

							//// Save this line for Public datatyping, if needed
	type String vlastkey
	set vlastkey=Db.nextVal("CMSRECCID","")
	type RecordCMSRECCID cmsreccid=Db.getRecord("CMSRECCID","SEQ=:vlastkey",1)
	set cmsreccid.cid=dep.cid
	set cmsreccid.cmsflg=dep.cmsflg

	do cmsreccid.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj6(RecordDEP dep,String vdi)	// CRCD_TO_U  Table DAYENDXFR  Currency Code - To Account Info

	if dep.eurefd'=""
	else  quit

							//// Save this line for Public datatyping, if needed
	type String v1,vlastkey
	set v1=dep.eurefd
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.cc=dep.cc.oldVal
	set dayendxfr.ccc=dep.cc.oldVal
	set dayendxfr.ccrcd=dep.crcd.oldVal
	set dayendxfr.cglsc=dep.glsc.oldVal
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd.curVal
	set dayendxfr.ctype=dep.type.oldVal
	set dayendxfr.glsc=dep.glsc.oldVal
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.prn=dep.bal
	set dayendxfr.type=dep.type.oldVal
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj7(RecordDEP dep)	// DTJNAACN_I  Table DTJNAACN  New Account Insert Journal

	type Public String TJD
	type String v1,v2,v3,v4,v5,vlastkey
	set v1=TJD
	set v2=dep.acn
	set v3=dep.cls
	set v4=dep.grp
	set v5=dep.type
	set vlastkey=dep.cid
	type RecordDTJNAACN dtjnaacn=Db.getRecord("DTJNAACN","SJD=:v1,ACN=:v2,CLS=:v3,GRP=:v4,TYPE=:v5,CID=:vlastkey",1)

	do dtjnaacn.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj8(RecordDEP dep)	// DTJNA_I  Table DTJNA  Daily New Account Journal

	type Public String %IDENT,TJD
	type String v1,v2,v3,v4,vlastkey
	set v1=TJD
	set v2=dep.cls
	set v3=dep.grp
	set v4=dep.type
	set vlastkey=dep.cid
	type RecordDTJNA dtjna=Db.getRecord("DTJNA","TJD=:v1,CLS=:v2,GRP=:v3,TYP=:v4,CID=:vlastkey",1)
	set dtjna.ident=%IDENT

	do dtjna.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj9(RecordDEP dep,String vdi)	// GCRCODE  Table DTJFMDS  Daily Scoring File Maintenance Journal

	type Public String %UID,TJD
	type String v1,v2,vlastkey
	set v1=TJD
	set v2=dep.cid
	set vlastkey=Db.nextVal("DTJFMDS","TJD=:v1,CID=:v2")
	type RecordDTJFMDS dtjfmds=Db.getRecord("DTJFMDS","TJD=:v1,CID=:v2,MSEQ=:vlastkey",1)
	set dtjfmds.bal=dep.bal
	set dtjfmds.boo=dep.boo
	set dtjfmds.cngrs=dep.cngrs
	set dtjfmds.dtop=dep.odt
	set dtjfmds.dtpmnt=dep.gcrpmnt.oldVal
	set dtjfmds.gcrlbal=dep.gcrlbal
	set dtjfmds.gcrldbal=dep.gcrldbal
	set dtjfmds.newgcr=dep.gcrcd
	set dtjfmds.ngcrcov=dep.gcrcv
	set dtjfmds.ogcrcov=dep.gcrcv.oldVal
	set dtjfmds.oldgcr=dep.gcrcd.oldVal
	set dtjfmds.origopd=dep.origopd
	set dtjfmds.rnamt=dep.rnamt.oldVal
	set dtjfmds.todcnt=dep.todcnt
	set dtjfmds.type=dep.type
	set dtjfmds.uid=%UID

	do dtjfmds.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj10(RecordDEP dep,String vdi)	// GLSC_FROM_U  Table DAYENDXFR  GL Set Code Change - From Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.aiacr=dep.aiacr
	set dayendxfr.cc=dep.cc.oldVal
	set dayendxfr.ccc=dep.cc.oldVal
	set dayendxfr.ccrcd=dep.crcd
	set dayendxfr.cglsc=dep.glsc.curVal
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd
	set dayendxfr.ctype=dep.type
	set dayendxfr.glsc=dep.glsc.oldVal
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.negacrun=dep.negacrun
	set dayendxfr.prn=dep.bal
	set dayendxfr.resint=dep.resint
	set dayendxfr.type=dep.type
	set dayendxfr.uncacr=dep.uncacr
	set dayendxfr.xflg=0

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj11(RecordDEP dep,String vdi)	// GLSC_TO_U  Table DAYENDXFR  GL Set Code Change - To Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.aiacr=dep.aiacr
	set dayendxfr.cc=dep.cc.oldVal
	set dayendxfr.ccc=dep.cc.oldVal
	set dayendxfr.ccrcd=dep.crcd
	set dayendxfr.cglsc=dep.glsc.oldVal
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd
	set dayendxfr.ctype=dep.type
	set dayendxfr.glsc=dep.glsc.curVal
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.negacrun=dep.negacrun
	set dayendxfr.prn=dep.bal
	set dayendxfr.resint=dep.resint
	set dayendxfr.type=dep.type
	set dayendxfr.uncacr=dep.uncacr
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj12(RecordDEP dep)	// HIST_I  Table HIST  History Entry for New Account

	type Public String %IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=dep.cid
	set vlastkey=Db.nextVal("HIST","CID=:v1")
	type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
	set hist.brcd=dep.boo
	set hist.cdt=+$H
	set hist.ident=%IDENT
	set hist.tcmt=$$^MSG(6795)
	set hist.time=$P($H,",",2)
	set hist.tjd=TJD
	set hist.tlo=TLO
	set hist.uid=%UID

	do hist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj13(RecordDEP dep)	// HIST_U  Table HIST  History for File Maintenance

	type Public String vx()
	type String vdi
	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  if 'vx(vdi).piece("|",3) if vdi'="TLD" do {
		type Public String vx(),EFD,%IDENT,%UID,TJD,TLO,vfmtable
		type String v1,vlastkey

		type String vold,vnew,vfmtable

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)
		set vfmtable=vx(vdi).piece("|",11)

		set v1=dep.cid
		set vlastkey=Db.nextVal("HIST","CID=:v1")
		type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
		set hist.brcd=dep.boo
		set hist.cdt=+$H
		set hist.efd=$G(EFD)
		set hist.ident=%IDENT
		set hist.tcmt=$$TCMTFM^ACNFUNCS("","DEP",vdi,vold,vnew,$G(EFD),,vfmtable)
		set hist.time=$P($H,",",2)
		set hist.tjd=TJD
		set hist.tlo=TLO
		set hist.uid=%UID

		do hist.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit


vj14(RecordDEP dep,String vdi)	// TYPE_FROM_U  Table DAYENDXFR  Product Type Change - From Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.aiacr=dep.aiacr
	set dayendxfr.cc=dep.cc.oldVal
	set dayendxfr.ccc=dep.cc.oldVal
	set dayendxfr.ccrcd=dep.crcd
	set dayendxfr.cglsc=dep.glsc.oldVal
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd
	set dayendxfr.ctype=dep.type.curVal
	set dayendxfr.glsc=dep.glsc.oldVal
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.negacrun=dep.negacrun
	set dayendxfr.prn=dep.bal
	set dayendxfr.resint=dep.resint
	set dayendxfr.type=dep.type.oldVal
	set dayendxfr.uncacr=dep.uncacr
	set dayendxfr.xflg=0

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj15(RecordDEP dep,String vdi)	// TYPE_TO_U  Table DAYENDXFR  Product Type Change - To Account Info

	type Public String TJD
	type String v1,vlastkey
	set v1=TJD
	set vlastkey=Db.nextVal("DAYENDXFR","TJD=:v1")
	type RecordDAYENDXFR dayendxfr=Db.getRecord("DAYENDXFR","TJD=:v1,SEQ=:vlastkey",1)
	set dayendxfr.acr=dep.acr
	set dayendxfr.aiacr=dep.aiacr
	set dayendxfr.cc=dep.cc.oldVal
	set dayendxfr.ccc=dep.cc.oldVal
	set dayendxfr.ccrcd=dep.crcd
	set dayendxfr.cglsc=dep.glsc.oldVal
	set dayendxfr.cid=dep.cid
	set dayendxfr.crcd=dep.crcd
	set dayendxfr.ctype=dep.type.oldVal
	set dayendxfr.glsc=dep.glsc.oldVal
	set dayendxfr.intavlncr=dep.intavlncr
	set dayendxfr.negacr=dep.negacr
	set dayendxfr.negacrun=dep.negacrun
	set dayendxfr.prn=dep.bal
	set dayendxfr.resint=dep.resint
	set dayendxfr.type=dep.type.curVal
	set dayendxfr.uncacr=dep.uncacr
	set dayendxfr.xflg=1

	do dayendxfr.save("/NOVALFK/NOVALDD/NOVALRI")

	quit

