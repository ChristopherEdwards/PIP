PNLTYPRG		/*
	ORIG: MBUIM - 12/15/2000
	DESC: Penalty Event and Balance Tracking Purge
	
	---- Comments --------------------------------------------------------
	This procedure is used to delete entries in the Penalty Event and
	Balance Tracking Table (PNLTYEVENT) that are recorded prior to a
	user-defined date. When a user runs the Penalty Event and Balance 
	Tracking Purge Utility function (@PBPURG), the UTBLREAD screen will be
	displayed. When the user enters the date, the post processor will
	confirm that the date entered is prior to the current system date.
 	
	---- Revision History ------------------------------------------------
	
	01/13/05 - Yendapallis - CR 13283
		Removed VPG and VPG0 sections.
		Cleaned up the procedure to conform to PSL standards.
		
	----------------------------------------------------------------------
	*/
		
INIT	// Initialization

	type public String VFMQ
	type public Number ER
	type Number %PAGE,%PG,TOTCNT
	
	set %ProcessMode=4
	set %PAGE=1,%PG=0
	set TOTCNT=0
	
	do VPG00 if "DFQ"[$G(VFMQ)!$G(ER) do VER quit
	set %PG=%PG+1
	do VPG01 
	do VER 
	
	quit
	
VPG00	// Set up

	type public String PDT,VFMQ
	type String %READ, %TAB()
		
	set %TAB("PDT")="[PNLTYEVENT]PDT/XPP=D CHKDT^PNLTYPRG"
	if %ProcessMode=4 set %READ="@@%FN,,,PDT/REQ"
	
	do ^UTLREAD if VFMQ="Q" quit
	
	quit

VPG01	// Screen

	type public String VFMQ	

	if %ProcessMode=4 set VFMQ="F"

	quit

VER	//

	type public String VFMQ
	type public Number TOTCNT

	if (VFMQ="Q") quit
       
        do PURGE
	//Total records purged: ~p1
	do Runtime.setErrMSG("PNLTYEVENT","5732",TOTCNT)
    
        quit

CHKDT	// Check purge date

	type public String X

	//Date must be the same as or before the system date
	if X>%SystemDate do Runtime.setErrMSG("PNLTYEVENT",753)		

	quit

PURGE	/*
	Records from the PNLTYEVENT table where the processing date 
	(PNLTYEVENT.PDT) for that record is less than the date entered by the
	user, and PNLTYEVENT.PDT falls between the loan's LN.PBLSTDT and
	LN.PBNXTDT
	*/
				
	type ResultSet rs=Db.select("CID,PDT","PNLTYEVENT","PDT<:PDT")	
	
	if rs.isEmpty() quit	
	while rs.next() do {

		type String LSTDT,XCID,XPDT
		type public Number TOTCNT

		set XCID=rs.getCol(1)
		set XPDT=rs.getCol(2)	// PDT

		type RecordLN ln=Db.getRecord("LN","CID=:XCID",1)
		set LSTDT=ln.pblstdt
                
		if LSTDT="" quit

		if (XPDT<LSTDT) do {
			do Db.delete("PNLTYEVENT","CID=:XCID AND PDT=:XPDT")
			set TOTCNT=TOTCNT+1
			}
		}
	
	quit
	

ERR     // Log error and quit
 
        type public String ER = 1
 
        do ^UTLERR
 
        quit
 
	

vSIG()	quit "59939^59241^Vincent Arpa^2446"	// Signature - LTD^TIME^USER^SIZE
