public LNPLCO  //Charge-off/Recovery Summary
        
          /*     ORIG:  MILLER - 29 AUG 1990
          ---- Revision History ------------------------------------------------

	   07/31/06 - KELLYP - CR 22048
	   	      Modified VPG00 section to eliminate PRECEDENCE warning.
      
           10/04/05 - BHOLT - 17069
           	      Modified the Depricated method.
           		
           08/13/02 - SRIVASTAVAN - 49451
                      Converted to PSL.
                                 
          ---------------------------------------------------------------------
        */

	do INIT
	
	quit

INIT    //

	type public Number OLNTB, %O, %PG, %PAGE
	type public String VFMQ   
	
        set %PG = 0 
        set %PAGE = 1 
        set %ProcessMode = 2

        type RecordLNPL3A fLNPL3A
        type RecordLN LN
        type RecordHIST fHIST
        do VPG(.fLNPL3A, .LN, .fHIST)
        
        quit

VPG(RecordLNPL3A fLNPL3A, RecordLN LN, RecordHIST fHIST)  // Page control

	type public Boolean ER
	type public Number FINISH, %PG
	type public String VFMQ

        set FINISH = 0
        for  do { quit:FINISH
                if %PG = 0 do VPG00 if ER set FINISH = 1 quit
                if %PG > 0 do VPG01(.fLNPL3A, .LN, .fHIST)
                if "DFQ"[VFMQ do VER set FINISH = 1 quit
                set %PG = %PG + 1
                }
       quit

VPG00   // Set up

	type public Boolean ER
	type public Number ALP, CNT, I, IO, IOSL, J, %PAGE
    	type public String %TAB(), %READ, VFMQ
    	
    	type String VPG()

        set %TAB("CID") = ".CID3/HLP=[LN]CID/XPP=D PCID^LNPLCO"
        set %TAB("IO") = $$IO^SCATAB($I)
        
        set %READ = "@@%FN,,,CID/REQ,IO/REQ"
        do ^UTLREAD 
        if VFMQ = "Q" set ER = 1 quit

        if IO '= $I do OPEN^SCAIO quit:ER
        set ALP = IOSL - 14
        do EXEC
        set CNT = I 
        if CNT set %PAGE = (I\ALP)+(CNT#ALP)
        // Charge-off/Recovery Transaction Details
        for J = 1:1:%PAGE set VPG(J) = $$^MSG(7123)_"|LNPLCO"
        quit


VPG01(RecordLNPL3A fLNPL3A, RecordLN LN, RecordHIST fHIST) // Screen

	type public Number ALP, CID, CNT, %EXT, %MODS, %PG, %REPEAT
	type public String ET, PGM, SID

        set LN = Db.getRecord("LN", "CID = :CID")
        set %REPEAT = ALP 
        set %MODS = (%PG*ALP)-ALP+1

        if %REPEAT + %MODS > CNT set %REPEAT = CNT - %MODS + 1
        do DRV^USID(%ProcessMode, "LNPLCO", .fLNPL3A, .LN, .fHIST)
        quit

VER     //

	type public String VFMQ

        if %ProcessMode = 2!(%ProcessMode = 4)!(VFMQ = "Q") do END quit
        do END
        quit

END     //

	type public String %TAB()

        kill %TAB
        quit

PCID    //

	type public Boolean ER
	type public Number CID, CLS, %EXT, ZCLS 
	type public String ET, X

        if X = "" quit 
        set %EXT = 1 
        set (CLS, ZCLS) = "L"

        do ^UACN
        if 'Db.isDefined("ACN", "CID = :CID") do {
                set ER = 1
                set ET = "INVLDACN"
                do ^UTLERR
                }
        quit

EXEC    // Process HIST for account
        
        type public Number CID, COA, I, ITC, REC, TAMT, TSEQ, vsql
	type public String H
	
		
	set I = 0
        
        type DbSet rs = Db.selectDbSet("HIST", "CID = :CID", "CID DESC")
        while rs.next() do {

                type RecordHIST hist = rs.getRecord("HIST")

                set ITC = hist.itc
                set TAMT = hist.tamt
                if ITC.extract() '= 0, ITC.extract() '= 1 quit
                set COA = TAMT.piece("#", 10)
                set REC = TAMT.piece("#", 11)
                if COA = "", REC = "" quit
                // Show as negative if charge-off reduction
                if ITC.extract() = 0 set COA = -COA
        	set TSEQ = hist.tseq
        	
                do ARRAY(.hist)
        
                }
        quit

ARRAY(RecordHIST hist)  // Build HIST array for use by screens

	type public Number COA, HIST(), I, TSEQ, TSO, REC
	type public String H

        set I = I + 1
        // TJD
        set HIST(I).piece("|", 1) = hist.tjd
        
        // TSEQ
        set HIST(I).piece("|", 2) = TSEQ
        
        // COA
        set HIST(I).piece("|", 3) = COA
        
        // REC
        set HIST(I).piece("|", 4) =  REC
        
        // UID
        set HIST(I).piece("|", 5) = hist.uid
        set TSO = hist.tso
        if COA '= "" do {
                 set HIST(I).piece("|", 6) = (TSO.piece("RSEQ#", 2)).piece("~", 1) 
                 set HIST(I).piece("|", 7) = (TSO.piece("CORES#", 2)).piece("~", 1)
                 }
        if REC '= "" set HIST(I).piece("|", 7) = (TSO.piece("RECS#", 2)).piece("~", 1)
        quit

vSIG()	quit "60477^65454^Pat Kelly^4469"	// Signature - LTD^TIME^USER^SIZE
