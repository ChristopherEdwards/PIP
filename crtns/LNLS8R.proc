LNLS8R	//
	/*
	   ORIG:  NEAL -  3 JUN 1992

	---------Revision History------------------------------------------

	08/15/06 - KELLYP - CR 22638
		   Modified entire procedure to eliminate logic issues that
		   led to RDBSAVEFAIL errors (same CID processed more than
		   once).  Also modified to use LNLS8R instead of TMPRPT5
		   since the SCA225 report doesn't select on TMPRPT5 at all.

	12/01/05 - chhabris - CR18008
		   Removed parameters MIN and MAX for TRN section as it was
		   coming as null from the report SCA225. Also, removed the
		   revision history prior to 2004.

	07/28/05 - SkariahV- CR16679
	       	   Removed #WARN and #OPTIMIZE directives.
	              
	--------------------------------------------------------------------
	*/

	quit 


public TRN	// Transactions of accounts sold to investors MIN to MAX

	type public Boolean ER

	type String INCD,GRP,PL

	do Db.fastDelete("TMPRPT5","PID=:%ProcessID")
	do Db.fastDelete("LNLS8R","PID=:%ProcessID")

	type ResultSet rs=Db.select("DISTINCT INCD,PL","LNLS8",,"INCD,PL")
        while rs.next() do { 
		set INCD=rs.getCol("INCD")
		set PL=rs.getCol("PL")
                do PL
		}
	quit


PL	//

	type public Boolean ER
	type public String INCD,PL
	
	type Date BEG,END
	type String FRE

	type RecordLNLS2 lnls2=Db.getRecord("LNLS2","INCD=:INCD,PL=:PL",1)
	
	// Last history date equals last remittance or beginning of month
	set END=lnls2.remld 

	if END.isNull() set END=$$BOMJD^SCADAT(%SystemDate,1)

	// Frequency equals remittance frequency or monthly
	set FRE="-"_lnls2.remfre 
	if FRE="-" set FRE="-1MA1"

	set BEG=END.nextFreqDate(FRE)+1

	do GRP

	quit


GRP

	type public String INCD,PL

	type Boolean FLG

	type DbSet ds=Db.selectDbSet("LNLS8","INCD=:INCD AND PL=:PL","INCD,PL,GRP,CID")
        while ds.next() do {
                type RecordLNLS8 lnls8=ds.getRecord("LNLS8")
		
		set FLG=0

		type DbSet dshist=Db.selectDbSet("HIST","CID=:lnls8.cid AND TJD>=:BEG AND TJD<=:END","TSEQ DESC")
        	while dshist.next() do {  quit
                	type RecordHIST hist=dshist.getRecord("HIST")
                	
                	if hist.etc.isNull() quit

			type RecordLNLS8R lnls8r=Db.getRecord("LNLS8R","PID=:%ProcessID,INCD=:INCD,PL=:PL,CID=:lnls8.cid,PSEQ=:lnls8.pseq,TSEQ=:hist.tseq",1)
			
			if lnls8r.getMode() quit
			
			set lnls8r.dt=hist.tjd
			set lnls8r.itc=hist.itc
			set lnls8r.etc=hist.etc
			set lnls8r.tamt=hist.tamt
			set lnls8r.efddt=hist.efd

			do lnls8r.bypassSave()

                	// FLG indicates that at least one transaction exists for each account
                	set FLG=1
			}
		
		/*
		 At least one transaction must exist for each
		 account.  Create dummy. TSEQ=0 is nulled and
		 then null-suppressed on report.
		*/
		if 'FLG do {
			type RecordLNLS8R lnls8r=Db.getRecord("LNLS8R","PID=:%ProcessID,INCD=:INCD,PL=:PL,CID=:lnls8.cid,PSEQ=:lnls8.pseq,TSEQ=:0",1)
			
			if lnls8r.getMode() quit

			do lnls8r.bypassSave()
			}
		}
	quit

vSIG()	quit "60492^54149^Pat Kelly^2840"	// Signature - LTD^TIME^USER^SIZE
