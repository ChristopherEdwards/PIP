LNRPT	

	/*
	 LOAN DAYEND REPORT FRONT END

	   ORIG:  David Caliendo (5527) - 03/10/87
	
	  ---- Revision History ------------------------------------------------
	
	   03/20/06 - KinI - CR 20108
	   	      Modified LTYPE section to restore UTBLCRCDX processing.

	   01/26/04 - Erik Scheetz - CR7798
	   	      Modified result set in section SCA088 to collate 
	   	      through COL rather than LNCOLREV (obsoleted).
	   	      Collation remains the same due to index definition.
	
	   12/08/03 - Spier 7403
	   	      psl warning message cleanup
	   	      
	   01/13/03 - Spier - 51423
		      Corrected numerous errors reported by new compiler. Many
		      getoneRows converted to db.selecets.

	   02/18/02 - VETSENM - 47764
                      The logic to look up data for the queries of SCA066 was
                      added in sections SCA066 and LTYPE .
        
	   04/20/00 - TANY - 39446
                      Optimized performance by passing additional
                      parameter to ^SCADAT.
	
	   08/11/99 - MOTENJ - 31126 
	              Converted to PSL	

	   10/23/98 - HAYMANP - 30103
	              Removed references to obsoleted reports SCA210 and SCA211.
	
	   02/22/98 - SPIER - 26685
	              Converted to procedure code
	
	  ----------------------------------------------------------------------
	    Add report calls here.
	
	    Set POP = "LNPRT_"_KEY_"."_date in MMDD format.

	    Example : POP="LNPRT_keyname".0101" on January 1.
	
	
	*/

	type RecordCUVAR cuvar=Db.getRecord("CUVAR")
	#accept pgm=spier;date=12/8/03
	set %SystemDate=cuvar.tjd
	set %EffectiveDate=%SystemDate-1 
	set X=$$DAT^%ZM(%SystemDate,"MM/DD/YY")
	
	
	do SCA035                    // Payoff lockout exception report
	do SCA061                    // Payments to delinquent accounts
	do SCA094                    // Deferred interest exception report
	do SCA088                    // Collateral review report
	do SCA091                    // Participations purchased daily  receipts
	do SCA114                    // Participation payoff summary
	do SCA013                    // Payment change report
	do SCA014                    // Rate change report
	do SCA184                    // Collection Follow-Up Report
	do SCA018                    // Account Review Report
	do SCA199                    // Small balance waiver
	do SCA294                    // Anticipated nonaccrual report
	do SCA066                    // Student Loan Advance Summary
	
	quit 
	

SCA035	// Payoff lockout exception report
	// set error trap

	catch vERROR {
		do ZT
		}
	 
	set KEY="POLOE" do SET
	set %BLK="/,"_POP_","_%EffectiveDate 
	set VFMQ=0 kill POP
	set RID="SCA035" do ^URID

	if $L(PGM) do {
	  	type ResultSet rs=Db.select("DISTINCT EFD","LNPOLOE","EFD=:%EffectiveDate")
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}
	quit 
	
SCA061	// Payments to delinquent accounts
	// set error trap

 	 catch vERROR {
                do ZT
                }
	 
	set KEY="DELP" do SET
	set %BLK="/,"_POP_","_%EffectiveDate 
	set VFMQ=0 kill POP
	set RID="SCA061" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EFD","LNDELP","EFD=:%SystemDate")
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}
	quit 
	
SCA094	// Deferred interest exception report
	// set error trap

        catch vERROR {
		do ZT
		}
        	
	set KEY="DIEXC" do SET
	set %BLK="/,"_POP_","_%EffectiveDate 
	set VFMQ=0 kill POP
	set RID="SCA094" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EFD","LNDIDE","EFD=:%EffectiveDate")
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}
	quit 

	
SCA088	// Collateral review report
	// set error trap

	catch vERROR {
		do ZT
		}
 
	set KEY="COLREV" do SET
	set %BLK="/,"_POP_","_%SystemDate 
	set VFMQ=0 kill POP
	set RID="SCA088" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("COLRVND","COL","COLRVND=:%EffectiveDate")
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate,MIN(1),MAX(1)

	quit 
	
SCA091	// Participations purchased daily receipts
	// set error trap
 
        catch vERROR {
                do ZT
                } 

	set KEY="LNPP" do SET
	set %BLK="/,"_POP_","_%EffectiveDate 
	set VFMQ=0 kill POP
	set RID="SCA091" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EFD","LNPPD","EFD=:%EffectiveDate")
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate,v7

	quit 
	
SCA114	// Participation payoff summary
	// set error trap
 
        catch vERROR {
                do ZT
                }
 
	set KEY="LSPO" do SET
	set %BLK="/,"_POP_","_%EffectiveDate 
	set VFMQ=0 kill POP
	set RID="SCA114" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EFD","LNLS9","EFD=:%SystemDate")
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	quit 
	
SCA013	// Payment change report
	// set error trap
 
        catch vERROR {
                do ZT
                }
 
	set KEY="PMTC" do SET
	set %BLK="/,"_POP_","_%SystemDate 
	set VFMQ=0 kill POP
	set RID="SCA013" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT PCHND","LNPTCHG","PCHND=:%SystemDate") 
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	quit 
	
SCA014	// Rate change report
	// set error trap
 
        catch vERROR {
                do ZT
                }
 
	set KEY="INTC" do SET
	set %BLK="/,"_POP_","_%SystemDate 
	set VFMQ=0 kill POP
	set RID="SCA014" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT ICHND","LNVRCHG","ICHND=:%SystemDate") 
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	quit 
	
SCA184	// Collection Follow-Up Report
	// set error trap
 
        catch vERROR {
                do ZT
                }
 
	set KEY="LNOLC" do SET
	set %BLK="/,"_POP_","_%SystemDate 
	set VFMQ=0 kill POP
	set RID="SCA184" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EFD","DAYENDLNOLC","EFD=:%SystemDate") 
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	quit 
	
SCA018	// Account Review Report
	// set error trap
 
        catch vERROR {
                do ZT
                }
 
	set KEY="ARF" do SET
	set %BLK="/,"_POP_",L,ALL,ALL,ALL,"_%SystemDate 
	set VFMQ=0 kill POP
	set RID="SCA018" do ^URID

	/* 
	  This wasn't changed when we first changed arf to 2 index entries
	  arfacn and arfcif
 
	  I $L(PGM),$D(^DAYEND(TJD,"ARF")) S PGM="^"_PGM D @PGM
	
	*/

	  kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	  quit 
	
SCA199	// Small balance waiver
	// set error trap	
 
        catch vERROR {
                do ZT
                }
 
	set KEY="LSBW" do SET
	set %BLK="/,"_POP_","_%SystemDate 
	set VFMQ=0 kill POP
	set RID="SCA199" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EFD","DAYENDLSBW","EFD=:%SystemDate") 
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	quit 
	
SCA294	// Anticipated nonaccrual report
	// set error trap
 
        catch vERROR {
                do ZT
                }
 
	set KEY="LNNAO" do SET
	set EJD=Db.getOneRow("ANAOFF","CUVAR")
	set %BLK="/,"_POP_","_EJD_"," 
	set VFMQ=0 kill POP
	set RID="SCA294" do ^URID

	if $L(PGM) do {
	    	type ResultSet rs=Db.select("DISTINCT EJD","DAYENDLNNAO","EJD=:%SystemDate") 
		if 'rs.isEmpty() set PGM="^"_PGM do @PGM
		}

	kill RID,POP,%NOOPEN,%NOCLOSE,%EffectiveDate

	quit 
	
SET	// Set variables

	kill LN,A,%A,DEP,RN

	type RecordCUVAR cuvar=Db.getRecord("CUVAR")
	#accept pgm=spier;date=12/08/03
	set %SystemDate=cuvar.tjd
	set %EffectiveDate=%SystemDate-1 
	set X=$$DAT^%ZM(%SystemDate,"MM/DD/YY")
	set (IO,POP)="LNRPT_"_KEY_"."_$P(X,"/",1)_$P(X,"/",2)

	quit 
	
SCA066	// Student Loan Advance Summary
	// set error trap
 
        catch vERROR {
                do ZT
                }
	if '(($$MON^SCADAT(%SystemDate,1)#3=1)&($$DAY^SCADAT(%SystemDate,1)=2)) quit 
	set RID="SCA066" do ^URID 
	if PGM="" do { quit

		set ER=1
		set ET="INVLDRPT"  
		do ^UTLERR
		}
 
	set PROG="^"_PGM
    
	//collate through all loan types
	new CLS,GRP,VARB
        set CLS="L"
	type ResultSet lget=Db.select("DISTINCT GRP,TYPE","LN")
	if lget.isEmpty() quit
	while lget.next() do {
		set GRP=lget.getCol("GRP")
		set VARB=lget.getCol("TYPE")
		do LTYPE
		}
	quit	

 
LTYPE   //Process one loan type        
	
	type String CR(),KEY,TY()
	
        type ResultSet rs=Db.select("TYPE,IDPF","PRODDFTL","IDPF <> 1")
	type RecordPRODDFTL proddft=Db.getRecord("PRODDFTL","TYPE=:VARB")
	type RecordPRODCTL prodctl=Db.getRecord("PRODCTL","TYPE=:VARB")

	set TY(VARB)=prodctl.des_"|"_GRP
		
	type RecordUTBLCRCDX utblcrcdx=Db.getRecord("UTBLCRCDX","CRCD=:proddft.crcd",1)	
	
	set CR(VARB,proddft.crcd)=utblcrcdx.desc
	
	set KEY="SLADV"_VARB do SET
	set %BLK="/,"_POP_","_VARB_","_proddft.crcd,VFMQ=0 
	kill POP

	do @PROG 

	quit		

ZT	// Mumps error

	 catch vERROR {
 
                set %ZTHALT=0 do ZE^UTLERR      // Log Mumps error
 
                // Error in account, not processed
 
                set ET=$$^MSG("3511")
                do LOGERR
                }
 
	quit	
LOGERR	// Log error in exception file
	// Loan Reports

	do LOG^UTLEXC($T(+0),"*",$$^MSG("4229"),"",$G(%ZTSEQ),$G(ET),"")

	kill ET,%ZTSEQ

	quit 
	
	
 #OPTION ResultClass ON
Public String vSIG()	quit "60345^66702^Irina Kin^8972"	// Signature - LTD^TIME^USER^SIZE
