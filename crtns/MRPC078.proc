public MRPC078(String return,Number versn,Number CID,Date EFD,String ctl)
	/*
	Procedure ID: MRPC078
	DESC: Loan Payoff Status
	KEYWORDS: RPC

	ARGUMENTS:
		. return  Loan Payoff Status data	/TYP=T/REQ/MECH=REFNAM:W

		. versn	  ^MRPC078 version number   	/TYP=N/REQ/MECH=VAL
			  current version=1

		. CID	  Account Number	  	/TYP=N/REQ/MECH=VAL

		. EFD	  Payoff Effective Date		/TYP=D/NOREQ/MECH=VAL

		. ctl	  Control			/NOREQ/MECH=VAL

			  Position 1 -  0) Include payoff fees, and "I","P" fees
					1) Include only "I","P" fees (for RPOO)

			  Position 2 -  null) Not Applicable - bypass ^UANTIC
					0) Do not anticipate pending payments
					1) Anticipate pending payments	    

	RETURNS:
		. $$      Error Message	   		/TYP=T
			  Null= No Error

	RELATED:
		. $$^PBSMRPC - MRPC Service Class Driver

	EXAMPLE:
		S RM=$$^MRPC078(.VAL,1,CID,EFD,"01")

	---- Revision History ------------------------------------------------

	04/06/06 - KELLYP - CR 20520
		Changed all reference of the % variable to $C(9).  % wasn't 
		used consistently and was causing problems in $TR references.

	07/12/05 - KinI - 16566
		Replaced "data" variable with "lndata" since "data" is used 
		and being reset by EXECSP^%DBAPI which is called when running 
		Payoff Status report for the date in the past.
		Removed old revision history.
		   
	06/06/05 - ScottC - 15816
		Modify the set data code to remove quotes. It
		was literally passing in the table.column values in 
		the return string.
					
	----------------------------------------------------------------------
	*/

	type public Boolean ER
	type public String %MSKD, RM
	type String lndata, str, XLN09, XLN28
	type Number I, %NOLOCK, PROBAL
	
	set %NOLOCK=1
	set %ProcessMode=2

	// Version number of client message is not compatible with server
	if versn.get()'=1 quit $$ERRMSG^PBSUTL($$^MSG(2951))

	// Invalid account ~p1
	type RecordLN ln=Db.getRecord("LN","CID=:CID",1)
	if 'ln.getMode() quit $$ERRMSG^PBSUTL($$^MSG(1259,CID))

	// Default payoff effective date
	if EFD.get()="" set EFD=%SystemDate

	// Effective date may not be prior to ~p1
	if EFD<ln.odd quit $$ERRMSG^PBSUTL($$^MSG(878,$$DAT^%ZM(ln.odd,%MSKD.get())))

	// default control
	if ctl.get()="" set ctl="00"
	set str=""

	set lndata=ln.title1_$C(9)_ln.fsinv_$C(9)_ln.balcmp_$C(9)_ln.acr_$C(9)_ln.lchg_$C(9)
	set lndata=lndata_ln.mchg_$C(9)_ln.teb_$C(9)_ln.unapf_$C(9)_ln.ncoa
	set lndata=lndata_$C(9)_ln.paylkamt_$C(9)_ln.paylkfrm_$C(9)_ln.paylkto
	
	// Determine Other Payoff Charges
	do OPCHG^LNPO2(.ln)

	// Load Payoff (XLN09) and Anticpated Payoff (XLN28) data
	type String PO=""
		
	do EXT^LNPO1

	type RecordTTX ttx=Class.new("RecordTTX")

	do PAYOFF^LNPO2(.ln,ctl,.ttx) quit:ER $$ERRMSG^PBSUTL(RM.get())

	// PROBAL=BALCMP+APOP-APOPP
	set PROBAL=lndata.piece($C(9),3)+XLN28.piece("|",11)-XLN28.piece("|",6)

	// Create formatted output string
	// TITLE1,FSINV,BALCMP,ACR,LCHG,MCHG,TEB,UNAPF,NCOA,
	// PAYLKAMT,PAYLKFRM,PAYLKTO,<PROBAL>
	for I=3:1:10 set lndata.piece($C(9),I)=+lndata.piece($C(9),I)
	set str=lndata_$C(9)_PROBAL

	// Normalize (plus) the numeric values in XLN28
	for I=1:1:11 set XLN28.piece("|",I)=+XLN28.piece("|",I)
	
	// TEIA,APOACR,APOLC,APOMC,APOEACR,APOPP,APOIP,APOMCP,APOEB,APOEIP,APOP
	set str=str_$C(9)_XLN28.translate("|",$C(9))

	// POAM,POEA,POIA,POEP,PORB,POCHG,POMISC,POESCBAL,PONPT,POLCHG,POUNAPF
	set str=str_$C(9)_+XLN09.piece("|",1)_$C(9)_+XLN09.piece("|",2)_$C(9)_+XLN09.piece("|",4)
	set str=str_$C(9)_+XLN09.piece("|",5)_$C(9)_+XLN09.piece("|",6)_$C(9)_+XLN09.piece("|",7)
	set str=str_$C(9)_+XLN09.piece("|",16)_$C(9)_+XLN09.piece("|",17)_$C(9)_+XLN09.piece("|",18)
	set str=str_$C(9)_+XLN09.piece("|",19)_$C(9)_+XLN09.piece("|",20)

	set return=$$V2LV^MSG(str) 

	quit ""

vSIG()	quit "60362^42731^Pat Kelly^3549"	// Signature - LTD^TIME^USER^SIZE
