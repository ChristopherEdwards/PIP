CHKXMOD	//;PBS - CHK - V2.1 - CHECK REGISTER RECORD MODIFICATION
	/*
	       ORIG:  JLB  4/18/86
	       DESC:  CHECK REGISTER RECORD BUMP
	     OUTPUT:  %O=0,BR=BRANCH

	  ---- Revision History ------------------------------------------------
	11/04/05 - PUTTASWH CR17011
		   Modified VPGO1, FILE and XPP sections to replace the 
		   references of XCHKREG table with CHKREG1 table.
		   
	12/12/03 - Spier 7501
		Removed code from VINIT that referred to DDPCTRL. Since
		the code will execute only on the host, that was the only value
		that could be stored in the table. 

	04/15/2002 - TELIV - 49794
		Converted to PSL

	*/
	
	do CREATE
	quit

CREATE	// 
	set %ProcessMode=0 
	do VINIT

	quit	


VINIT	// init variables

	set XTLO=%UserStation if %UserStation["." set XTLO=$P(%UserStation,".",2)

	type RecordUTBLDEVICE utbldevice=Db.getRecord("UTBLDEVICE","NODE='HOST',KEY=:XTLO",1)
	if utbldevice.getMode()=0 set ER=1 set ET="INVLDDEV" do DSPBP^UTLERR quit	
	set BR=utbldevice.brcd

	set (%PG,%PAGE)=1 
	set ER=0
	kill VFMQ
	do VPG 

	quit

VPG	// Page control
	if %PG>0 do VPG01 

	do VPG0

	quit
	
VPG0 	//
	if ER do VEXIT quit

	if "DFQ"[VFMQ do VER quit

	do VPG

	quit	

VPG01	//
	//This function will modify a check number to a new unused check number.
	set TEXT(1)=$$^MSG(6720)
	
	//The original check number will then be valid for use.
	set TEXT(2)=$$^MSG(6719)

	//Please be sure that this is the actual situation.
	set TEXT(3)=$$^MSG(6718)

	set %TAB("TY")=".CHKTYP1/TBL=[UTBLCHKS]"
	set %TAB("OLD")=".OLD1/TBL=[CHKREG1]CKNO:DISTINCT:QU ""[CHKREG1]CTYPE=<<TY>>"""

	// Check number already exists
	set %TAB("NEW")=".NEW1/XPP=D XPP^CHKXMOD"

	kill OLNTB

	set %READ="@@%FN,,,@TEXT(1),@TEXT(2),@TEXT(3),,TY/REQ,OLD/REQ,NEW/REQ"
	do ^UTLREAD

	quit

VER	// verify and process

	if VFMQ="Q"!(ER) do VEXIT quit
	do FILE

	do VEXIT

	quit

VEXIT	//
	if "24"[%ProcessMode!(ER) quit

	// Check Register record not bumped
	if VFMQ="Q" set RM=$$^MSG(527)

	// Check Register record bumped
	else  set RM=$$^MSG(526)

	set ER="W"

	quit

FILE	// File data

	type public Number NEW,OLD
	type Number OGLNO
	type String OCNAM
	
	type ResultSet rs1=Db.select("CO,GL","CHKREG1","CKNO=:OLD AND CTYPE=:TY")
	if rs1.next() do {
		set OCNAM=rs1.getCol("CO")
		set OGLNO=rs1.getCol("GL")
		}	
	
	type RecordCHKREG1 chkreg1=Db.getRecord("CHKREG1","CO=:OCNAM,GL=:OGLNO,CKNO=:OLD",1)
		
	do chkreg1.setAuditFlag(1)
	set chkreg1.ckno=NEW
	
	do chkreg1.save()	
	
	quit


XPP	;
	quit:X="""" 
	
	type ResultSet rs=Db.select("CO,GL","CHKREG1","CKNO=:X AND CTYPE=:TY")
	if 'rs.isEmpty() set ER=1,RM=$$^MSG(529)	// Check Number already Exists	

	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "60228^23929^Hema Puttaswamy^2436"	// Signature - LTD^TIME^USER^SIZE
