LNLS3A 	/*
	 ORIG: 1366 - 06/18/2003
	 DESC: The procedure LNLS3A enables the transfer of Loan Sale Group
	       Account.

	---- Revision History -------------------------------------------------
	12/06/06 - chhabris - CR23308
		   Converted M routine to new PSL standard.
	-----------------------------------------------------------------------
	*/

	quit

UPD	//
	type public String %ProcessMode
	set %ProcessMode=1 do VPG
	quit

VPG	//
	type Boolean FINISH
	type public Number %PG,%PAGE
	type String VFMQ

	set %PG=0,%PAGE=1
	set FINISH=0

	for  do { quit:FINISH
                if %PG=0 do VPG00 if VFMQ="Q" set FINISH=1 quit

                if %PG>0 do VPG01

                if "DFQ"[VFMQ do VER set FINISH=1 quit

		set %PG=%PG+1
                }
        quit


VPG00	// Input Screen
	type public String ACN(),ET,LS(),%READ,%TAB,VFMQ
	type public Number CID
	type String INV(,,)

	type ResultSet rs = Db.select("CID","LNLS6")
	while rs.next() do {
		set LS(rs.getCol("CID")) = ""	
		}

	set %TAB("CID")=".CID1/TBL=LS("
	set %TAB("INCD")=".INCD1/TBL=INV(/XPR=D PINCD^LNLS3A(.INV)"
	set %TAB("PL")=".PL1/TBL=INV(INCD,"

	set %READ="@@%FN,,,CID/REQ,INCD/REQ,PL/REQ"
	do ^UTLREAD if VFMQ="Q" quit

	lock +ACN(CID):2 else  set ET="RECLOC" do ERR quit
	quit


VPG01	// Exception sequence screen

	type Number PSEQ
	type public Number PSEQ1
	type String GHDG,OGRP
	type public String GRP,INCD,INV(,,),OLNTB,PL,%READ,SQ,%TAB,VFMQ

	set OGRP=""

	type ResultSet rs = Db.select("GRP","LNLS6","INCD=:INCD AND PL=:PL")
	if rs.next() do {
		set OGRP = rs.getCol("GRP")	
		}

	type ResultSet rs1 = Db.select("PSEQ","LNLS6","CID=:CID AND INCD=:INCD AND GRP=:OGRP AND PL=:PL")
	if rs1.next() do {
		set PSEQ1=rs1.getCol("PSEQ")
		}
	set GHDG=""

	// Old Group: ~p1
	set GHDG =$$^MSG(5967,OGRP) 

	set %TAB("NGRP")=".NGRP1/XPP=D PNGRP^LNLS3A /TBL=[LNLS3]GRP:QU ""[LNLS3]INCD=<<INCD>> AND [LNLS3]PL=<<PL>>"""

	set OLNTB=07030

	set %READ="@GHDG,,NGRP/REQ"
	do ^UTLREAD if VFMQ="Q" quit

	quit


ERR	//
	type public Boolean ER
	type public String VFMQ

	set ER=1 do ^UTLERR
	set VFMQ="Q"
	quit


VER	//
	type public String VFMQ

	if VFMQ="Q" do END quit

	do FILE
	do END

	quit


FILE	// File data

	type public Number PSEQ1
	type public String ACN(),CID,NGRP

	type RecordLNLS6 fLNLS6

	set fLNLS6=Db.getRecord("LNLS6","CID=:CID,PSEQ=:PSEQ1",1)
	set fLNLS6.grp=NGRP

	do fLNLS6.bypassSave()

	quit


END	//lock

	type public String ER
	type Public Number CID
	type public String ACN(),RM,%TAB,VFMQ
	
	lock -ACN(CID)

	set CID = CID.get()
	set ER="W"

	// Account ~p1 not modified
	if VFMQ="Q" set RM=$$^MSG(135,CID)

	// Account ~p1 modified
	else  set RM=$$^MSG(122,CID)
	quit


PINCD(INV())	// Pre-processor - INCD

	type String GRP,INCD,PL
	type public Number CID

	type ResultSet rs = Db.select("INCD,PL,GRP","LNLS6","CID=:CID","INCD,PL,GRP")
	while rs.next() do {
		set INCD = rs.getCol("INCD")
		set PL = rs.getCol("PL")
		set GRP = rs.getCol("GRP")
		set INV(INCD,PL,GRP)=""	
		}
	quit


PNGRP	// Post processor - NGRP

	type public Boolean ER
	type public String OGRP,RM,X

	// Must transfer to different participation group	
	if X=OGRP do Runtime.setErrMSG("LNLS6",1844)

	quit

vSIG()	quit "60607^10386^Sanjay Chhabria^3001"	// Signature - LTD^TIME^USER^SIZE
