public DEALPURG	//Deal Purge and Restore Utilities
	/*
	  ORIG:     YANG - 01/27/93
	  DESC:     Deal Purge and Restore Utilities

	       This procedure searches through DEAL1 and DEALHIST records
	       for deals that have been marked as deleted or completed
	       within a period of time (which is the maximum existing time
	       after it was deleted or completed).  

	----Revision History---------------------------------------------------

	07/28/06 - KELLYP - CR 22048
		   Modified FINDREC section to eliminate PRECEDENCE warning.

	02/12/06 - KinI - CR 16664
	           Added setting of MAXDATE to 365 if it's not defined in
	           CUVAR (by column definition).	

	01/16/04 - Erik Scheetz - CR7798
		   Modified FINDREC section to collate through DEAL1 table
		   rather than DLINDX2.  DLINDX2 table is being obsoleted.
	
	10/18/02 - GRAY - 49794
		   Removed all code associated with global output to an RMS
		   file and restoring.

	06/12/02 - VETSENM - 49794
		   Converted to PSL.            		
	-----------------------------------------------------------------------
	*/

	do MAIN
	
	quit
	
MAIN	//

	set VFMQ=0
	set %READ="@@%FN"

	do ^UTLREAD

	if "Q"[VFMQ quit

	do FINDREC

	quit

FINDREC	//

	/* 
	Find all deals with status of 6 (completed) or 8 (deleted);
	and have been in the system for more than the maximum days allowed.
	Purge these deals from the ^DEAL1 and ^DEALHIST globals.
	Purged records are written to SCAU$SPOOL directory.
	*/

	type Number COUNT,MAXDATE
	type Date DATE
	type String NO="" 

	set COUNT=0

	type RecordCUVAR cuvar=Db.getRecord("CUVAR")
	set MAXDATE=cuvar.dealpurg
	if MAXDATE.isNull() set MAXDATE=365
	
	type ResultSet rs=Db.select("NOINT,VDT","DEAL1","STATUS=6 OR STATUS=8","STATUS ASC")
	while rs.next() do {
		set NO=rs.getCol("NOINT")
		set DATE=rs.getCol("VDT")
		if DATE<(%SystemDate-MAXDATE) do {
			set COUNT=COUNT+1

			do Db.delete("DEAL1","NOINT=:NO")
			do Db.fastDelete("DEALMSG","NOINT=:NO")
			do Db.delete("DEALHIST","NOINT=:NO")
			}
		}
	
	// ~p1 records have been purged
	set ER="W" set RM=$$^MSG(7601,COUNT)

	quit
	
	
 #OPTION ResultClass ON
Public String vSIG()	quit "60477^65445^Pat Kelly^1964"	// Signature - LTD^TIME^USER^SIZE
