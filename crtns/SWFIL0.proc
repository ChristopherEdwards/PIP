SWFIL0 // SWIFT DATA-QWIK filer, part (2)
 // Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 01/31/2007 11:24 - shetyes

	quit		// Not called from top

VJOURNAL(RecordSWIFT swift)	//SWIFT Journal file entries

	type Public Date %EffectiveDate
	type Public String %TSRC,vpar,vx()
	type String TSRC,vdi,vdx()

	if %TSRC.get().isNull() set TSRC="O"
	else  set TSRC=%TSRC

	if %ProcessMode=3 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj1(.swift)	// Mode=D Tran=B EFD=N Seq=1 JRNID=SWAUD_D
				do vj4(.swift)	// Mode=D Tran=B EFD=N Seq=1 JRNID=SWHIST_D
				}
			}
		else  if TSRC="O" do {
			if 'EFD.get() do {
				do vj1(.swift)	// Mode=D Tran=O EFD=N Seq=1 JRNID=SWAUD_D
				do vj4(.swift)	// Mode=D Tran=O EFD=N Seq=1 JRNID=SWHIST_D
				}
			}
		}
	else  if %ProcessMode=0 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj2(.swift)	// Mode=I Tran=B EFD=N Seq=1 JRNID=SWAUD_I
				do vj5(.swift)	// Mode=I Tran=B EFD=N Seq=1 JRNID=SWHIST_I
				}
			}
		else  if TSRC="O" do {
			if 'EFD.get() do {
				do vj2(.swift)	// Mode=I Tran=O EFD=N Seq=1 JRNID=SWAUD_I
				do vj5(.swift)	// Mode=I Tran=O EFD=N Seq=1 JRNID=SWHIST_I
				}
			}
		}
	else  if %ProcessMode=1 do {
		if TSRC="B" do {
			if 'EFD.get() do {
				do vj3(.swift)	// Mode=U Tran=B EFD=N Seq=1 JRNID=SWAUD_U
				do vj6(.swift)	// Mode=U Tran=B EFD=N Seq=1 JRNID=SWHIST_U
				}
			}
		else  if TSRC="O" do {
			if 'EFD.get() do {
				do vj3(.swift)	// Mode=U Tran=O EFD=N Seq=1 JRNID=SWAUD_U
				do vj6(.swift)	// Mode=U Tran=O EFD=N Seq=1 JRNID=SWHIST_U
				}
			}
		}

	quit


vj1(RecordSWIFT swift)	// SWAUD_D  Table SWAUD  SWIFT Audit (Delete)

	type Public String %UID,TJD,TLO
	type String v1,v2,v3,vlastkey
	set v1=TJD
	set v2=swift.trrefno
	set v3=swift.msg
	set vlastkey=Db.nextVal("SWAUD","TJD=:v1,TRREFNO=:v2,MSG=:v3")
	type RecordSWAUD swaud=Db.getRecord("SWAUD","TJD=:v1,TRREFNO=:v2,MSG=:v3,ASEQ=:vlastkey",1)
	set swaud.cdt=+$H
	set swaud.swdirect=swift.swdirect
	set swaud.tcmt=$$^MSG(8286,swift.msg,TJD)
	set swaud.time=$P($H,",",2)
	set swaud.tlo=TLO
	set swaud.uid=%UID

	do swaud.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj2(RecordSWIFT swift)	// SWAUD_I  Table SWAUD  SWIFT Audit (Insert)

	type Public String %UID,TJD,TLO
	type String v1,v2,v3,vlastkey
	set v1=TJD
	set v2=swift.trrefno
	set v3=swift.msg
	set vlastkey=Db.nextVal("SWAUD","TJD=:v1,TRREFNO=:v2,MSG=:v3")
	type RecordSWAUD swaud=Db.getRecord("SWAUD","TJD=:v1,TRREFNO=:v2,MSG=:v3,ASEQ=:vlastkey",1)
	set swaud.cdt=+$H
	set swaud.swdirect=swift.swdirect
	set swaud.tcmt=$$^MSG(8288,swift.msg,TJD)
	set swaud.time=$P($H,",",2)
	set swaud.tlo=TLO
	set swaud.uid=%UID

	do swaud.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj3(RecordSWIFT swift)	// SWAUD_U  Table SWAUD  SWIFT Audit (Update)

	type Public String vx()
	type String vdi

	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  do {
		type Public String vx(),EFD,%UID,TJD,TLO
		type String v1,v2,v3,vlastkey

		type String vold,vnew

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)

		set v1=TJD
		set v2=swift.trrefno
		set v3=swift.msg
		set vlastkey=Db.nextVal("SWAUD","TJD=:v1,TRREFNO=:v2,MSG=:v3")
		type RecordSWAUD swaud=Db.getRecord("SWAUD","TJD=:v1,TRREFNO=:v2,MSG=:v3,ASEQ=:vlastkey",1)
		set swaud.cdt=+$H
		set swaud.swdirect=swift.swdirect
		set swaud.tcmt=$$TCMTFM^ACNFUNCS("","SWIFT",vdi,vold,vnew,$G(EFD))
		set swaud.time=$P($H,",",2)
		set swaud.tlo=TLO
		set swaud.uid=%UID

		do swaud.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit


vj4(RecordSWIFT swift)	// SWHIST_D  Table SWHIST  SWIFT Message History (Delete)

	type Public String %UID,TJD,TLO
	type String v1,v2,vlastkey
	set v1=swift.trrefno
	set v2=swift.msg
	set vlastkey=Db.nextVal("SWHIST","TRREFNO=:v1,MSG=:v2")
	type RecordSWHIST swhist=Db.getRecord("SWHIST","TRREFNO=:v1,MSG=:v2,SEQ=:vlastkey",1)
	set swhist.cdt=+$H
	set swhist.swdirect=swift.swdirect
	set swhist.tcmt=$$^MSG(8286,swift.msg,TJD)
	set swhist.time=$P($H,",",2)
	set swhist.tjd=TJD
	set swhist.tlo=TLO
	set swhist.uid=%UID

	do swhist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj5(RecordSWIFT swift)	// SWHIST_I  Table SWHIST  SWIFT Message History (Insert)

	type Public String %UID,TJD,TLO
	type String v1,v2,vlastkey
	set v1=swift.trrefno
	set v2=swift.msg
	set vlastkey=Db.nextVal("SWHIST","TRREFNO=:v1,MSG=:v2")
	type RecordSWHIST swhist=Db.getRecord("SWHIST","TRREFNO=:v1,MSG=:v2,SEQ=:vlastkey",1)
	set swhist.cdt=+$H
	set swhist.swdirect=swift.swdirect
	set swhist.tcmt=$$^MSG(8288,swift.msg,TJD)
	set swhist.time=$P($H,",",2)
	set swhist.tjd=TJD
	set swhist.tlo=TLO
	set swhist.uid=%UID

	do swhist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj6(RecordSWIFT swift)	// SWHIST_U  Table SWHIST  SWIFT Message History (Update)

	type Public String vx()
	type String vdi

	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  do {
		type Public String vx(),EFD,%UID,TJD,TLO
		type String v1,v2,vlastkey

		type String vold,vnew

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)

		set v1=swift.trrefno
		set v2=swift.msg
		set vlastkey=Db.nextVal("SWHIST","TRREFNO=:v1,MSG=:v2")
		type RecordSWHIST swhist=Db.getRecord("SWHIST","TRREFNO=:v1,MSG=:v2,SEQ=:vlastkey",1)
		set swhist.cdt=+$H
		set swhist.swdirect=swift.swdirect
		set swhist.tcmt=$$TCMTFM^ACNFUNCS("","SWIFT",vdi,vold,vnew,$G(EFD))
		set swhist.time=$P($H,",",2)
		set swhist.tjd=TJD
		set swhist.tlo=TLO
		set swhist.uid=%UID

		do swhist.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit

