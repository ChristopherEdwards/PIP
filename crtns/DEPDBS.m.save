DEPDBS	;
	;
	; **** Routine compiled from DATA-QWIK Procedure DEPDBS ****
	;
	; 09/18/2006 15:15 - kini
	;
	;
	Q 
	;
CALC(CID,EFD,MDT)	;
	;
	N dep,vop1,vop2,vop3,vop4,vop5 S vop1=CID,dep=$$vDb6(CID,.vop2)
	 S vop4=$G(^ACN(vop1,57))
	 S vop3=$G(^ACN(vop1,53))
	 S vop5=$G(^ACN(vop1,452))
	I '$G(vop2) Q 
	;
	I $P(vop4,$C(124),9)="" S IRN="" Q 
	;
	S IRN=$$RSCH^URSCH($P(vop4,$C(124),9),$P(vop3,$C(124),3),EFD,MDT,$P(vop5,$C(124),1),$P(vop5,$C(124),2))
	;
	Q 
	;
C(dep,ttx,trn,DWA,DSWA)	;
	;
	; Skip if error correct or reversal
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $E(($P(vobj(trn,0),$C(124),1)),6)!$E(($P(vobj(trn,0),$C(124),1)),12) Q 
	;
	N AIACR,BAL,BWF,BALCL,CRCD,CUMDEP,DBWA,DEFINADJ,DNINT,DPINT,DRINT
	N INTAVLNC,IPL,IRN,NEGACR,NEGACRUN,RESINT,STAT,UNCACR
	;
	S DWA=$get(DWA)
	S DSWA=$get(DSWA)
	;
	D CLSINI(.dep,.trn)
	;
	; For discount CDs, the closeout amount is always the ledger balance
	 S:'$D(vobj(dep,53)) vobj(dep,53)=$G(^ACN(vobj(dep,-3),53))
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	I $P(vobj(dep,53),$C(124),22) S DFT("AMT")=$P(vobj(dep,51),$C(124),1) Q 
	;
	I 'DEFINADJ S (DPINT,DNINT,DRINT,DBWA)=0
	E  D EXT^DEPIADJ(.dep,,.DPINT,.DNINT,.DRINT,.DBWA) Q:ER 
	;
	S BALCL=BAL+INTAVLNC+DPINT-DNINT-DRINT-DBWA
	;
	D CLOSE(.dep,.trn,BALCL,.DWA,.DSWA)
	;
	Q 
	;
CWIP(dep,ttx,trn,EFD,DWA,DSWA)	;
	;
	; Skip if error correct or reversal
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $E(($P(vobj(trn,0),$C(124),1)),6)!$E(($P(vobj(trn,0),$C(124),1)),12) Q 
	;
	N ADJ,ADJW,AIACR,BALCL,BAL,BWA,DBWA,BWF,CRCD,CUMDEP,CUMINT,DNINT
	N DEFINADJ,DPINT,DRINT,INT,INTAVLNC,IPL,IRN,NEGACR,NEGACRUN
	N PCTAXAMT,PEN,RESINT,STAT,UNCACR
	;
	S DWA=$get(DWA)
	S DSWA=$get(DSWA)
	;
	D CLSINI(.dep,.trn)
	;
	N cpdep S cpdep=$$vReCp1(dep)
	;
	I '($D(ttx)#2) K vobj(+$G(ttx)) S ttx=$$vDbNew1("","","","")
	;
	I (EFD&(TJD-EFD)) D CWIPEFD(.cpdep,.trn) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	D PCTAX(.cpdep,.ttx) K:ER vobj(+$G(cpdep)) Q:ER 
	I PCTAXAMT=0 D ^UMAT(.cpdep,.ttx)
	;
	S NEGACR=$$^SCARND(NEGACR,0,vobj(dep,-3))
	S NEGADJ=$$^SCARND(NEGADJ,0,vobj(dep,-3))
	S NEGACRUN=$$^SCARND(NEGACRUN,0,vobj(dep,-3))
	S UNCACR=$$^SCARND(UNCACR,0,vobj(dep,-3))
	S AIACR=$$^SCARND(AIACR,0,vobj(dep,-3))
	;
	; No closeouts w/int for Low balance accounts with negative accrual
	 S:'$D(vobj(dep,49)) vobj(dep,49)=$G(^ACN(vobj(dep,-3),49))
	D CHECKLB($P(vobj(dep,49),$C(124),12),NEGACR,NEGACRUN,UNCACR) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	I 'DEFINADJ S (DPINT,DNINT,DRINT,DBWA)=0
	E  D DEFINT(.cpdep,.ttx,.DPINT,.DNINT,.DRINT,.DBWA) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	; Cumulative interest adjustment
	 S:'$D(vobj(dep,464)) vobj(dep,464)=$G(^ACN(vobj(dep,-3),464))
	I '$P(vobj(dep,464),$C(124),1) S CUMINT=0
	E  D CUMDEP(.cpdep,INT,IPL) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	S BALCL=+BAL+INT+INTAVLNC+ADJ-PEN-BWA-NEGACR-NEGACRUN-RESINT-PCTAXAMT
	S BALCL=BALCL+DPINT-DNINT-DRINT-DBWA-UNCACR+AIACR+CUMINT
	I EFD,TJD-EFD S BALCL=BALCL-NEGADJ
	;
	D CLOSE(.cpdep,.trn,BALCL,.DWA,.DSWA)
	;
	K vobj(+$G(cpdep)) Q 
	;
CWP(dep,ttx,trn,EFD,DWA,DSWA)	;
	;
	; Skip if error correct or reversal
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $E(($P(vobj(trn,0),$C(124),1)),6)!$E(($P(vobj(trn,0),$C(124),1)),12) Q 
	;
	N AIACR,ADJ,BAL,BWA,BWF,BALCL,CRCD,CUMDEP,DBWA,DEFINADJ,DNINT,DPINT
	N DRINT,INTAVLNC,IPL,IRN,INT,NEGACR,NEGACRUN,PEN,RESINT
	N STAT,UNCACR
	;
	S DWA=$get(DWA)
	S DSWA=$get(DSWA)
	I '($D(ttx)#2) K vobj(+$G(ttx)) S ttx=$$vDbNew1("","","","")
	;
	D CLSINI(.dep,.trn)
	;
	; Returns: ADJ,BWA,INT,PEN
	D ^UMAT(.dep,.ttx)
	;
	I 'DEFINADJ S (DPINT,DNINT,DRINT,DBWA)=0
	E  D DEFINT(.dep,.ttx,.DPINT,.DNINT,.DRINT,.DBWA) Q:ER 
	;
	S BALCL=+BAL-PEN+ADJ+INTAVLNC+DPINT-DNINT-DRINT-DBWA
	;
	D CLOSE(.dep,.trn,BALCL,.DWA,.DSWA)
	;
	Q 
	;
CWI(dep,ttx,trn,DWA,DSWA)	;
	;
	; Skip if error correct or reversal
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $E(($P(vobj(trn,0),$C(124),1)),6)!$E(($P(vobj(trn,0),$C(124),1)),12) Q 
	;
	N ADJ,ADJW,AIACR,BALCL,BAL,BWA,CTL,BWF,CRCD,CUMDEP,CUMINT,DBWA,DNINT
	N DEFINADJ,DPINT,DRINT,INT,INTAVLNC,IPL,IRN,NEGACR,NEGACRUN
	N PCTAXAMT,PEN,RESINT,STAT,UNCACR
	;
	S DWA=$get(DWA)
	S DSWA=$get(DSWA)
	I '($D(ttx)#2) K vobj(+$G(ttx)) S ttx=$$vDbNew1("","","","")
	;
	D CLSINI(.dep,.trn)
	;
	S CTL=10
	;
	N cpdep S cpdep=$$vReCp2(dep)
	;
	I (EFD&(TJD-EFD)) D CWIPEFD(.cpdep,.trn) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	;Premature Tax Amt
	D PCTAX(.cpdep,.ttx) K:ER vobj(+$G(cpdep)) Q:ER 
	;Returns: ADJ,BWA,INT,PEN
	I PCTAXAMT=0 D ^UMAT(.cpdep,.ttx)
	;
	S NEGACR=$$^SCARND(NEGACR,0,vobj(cpdep,-3))
	S NEGADJ=$$^SCARND(NEGADJ,0,vobj(cpdep,-3))
	S NEGACRUN=$$^SCARND(NEGACRUN,0,vobj(cpdep,-3))
	S UNCACR=$$^SCARND(UNCACR,0,vobj(cpdep,-3))
	S AIACR=$$^SCARND(AIACR,0,vobj(cpdep,-3))
	;
	; No closeouts w/int for Low balance accounts with negative accrual
	 S:'$D(vobj(dep,49)) vobj(dep,49)=$G(^ACN(vobj(dep,-3),49))
	D CHECKLB($P(vobj(dep,49),$C(124),12),NEGACR,NEGACRUN,UNCACR) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	I 'DEFINADJ S (DPINT,DNINT,DRINT,DBWA)=0
	E  D DEFINT(.cpdep,.ttx,.DPINT,.DNINT,.DRINT,.DBWA) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	;Cumulative interest adjustment
	 S:'$D(vobj(dep,464)) vobj(dep,464)=$G(^ACN(vobj(dep,-3),464))
	I '$P(vobj(dep,464),$C(124),1) S CUMINT=0
	E  D CUMDEP(.cpdep,INT,IPL) K:ER vobj(+$G(cpdep)) Q:ER 
	;
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	S BALCL=+$P(vobj(dep,51),$C(124),1)+INT+$P(vobj(dep,51),$C(124),18)-BWA+ADJ-NEGACR-NEGACRUN-$P(vobj(dep,54),$C(124),41)
	S BALCL=BALCL+DPINT-DNINT-DRINT-DBWA-UNCACR+AIACR+CUMINT
	I EFD,TJD-EFD S BALCL=BALCL-NEGADJ
	;
	D CLOSE(.cpdep,.trn,BALCL,.DWA,.DSWA)
	;
	K vobj(+$G(cpdep)) Q 
	;
CWIPEFD(dep,trn)	;
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	;
	 S:'$D(vobj(dep,57)) vobj(dep,57)=$G(^ACN(vobj(dep,-3),57))
	I $P(vobj(dep,57),$C(124),6)="" D  Q:ER 
	.	 S:'$D(vobj(dep,60)) vobj(dep,60)=$G(^ACN(vobj(dep,-3),60))
	.	I $P(vobj(dep,60),$C(124),2)=""!($P(vobj(dep,57),$C(124),5)="") Q 
	. S vobj(dep,-100,57)="",$P(vobj(dep,57),$C(124),6)=$$vdatFre(($P(vobj(dep,57),$C(124),5)),"-"_$P(vobj(dep,60),$C(124),2),,"") Q:ER 
	.	Q 
	;
	; Closeout effective in prior int/div posting period
	I EFD<($P(vobj(dep,57),$C(124),6)+1) D SETERR^DBSEXECU("TTX","MSG",557) Q 
	;
	; Closeout effective prior to date last renewed
	 S:'$D(vobj(dep,53)) vobj(dep,53)=$G(^ACN(vobj(dep,-3),53))
	I EFD<$P(vobj(dep,53),$C(124),4) D SETERR^DBSEXECU("TTX","MSG",558) Q 
	;
	; Closeout effective prior to history cutoff date
	 S:'$D(vobj(dep,52)) vobj(dep,52)=$G(^ACN(vobj(dep,-3),52))
	I EFD'>$P(vobj(dep,52),$C(124),19) D SETERR^DBSEXECU("TTX","MSG",559) Q 
	;
	N ttxtmp S ttxtmp=$$vDbNew1("","","","")
	;
	S $P(vobj(ttxtmp),$C(124),1)=vobj(dep,-3)
	S $P(vobj(ttxtmp),$C(124),2)=$P(vobj(trn,0),$C(124),1)
	S $P(vobj(ttxtmp),$C(124),3)=vobj(trn,-3)
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	S $P(vobj(ttxtmp),$C(124),4)=$P(vobj(dep,51),$C(124),1)*DIR
	S $P(vobj(ttxtmp),$C(124),5)=EFD
	I %MCP S $P(vobj(ttxtmp),$C(124),17)=$P(vobj(dep,50),$C(124),12)
	;
	; Process colseout
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	D CWIP2(.dep,.ttxtmp,$P(vobj(dep,51),$C(124),1),$P(vobj(dep,54),$C(124),1),NEGACR,NEGACRUN,$P(vobj(dep,54),$C(124),41),UNCACR)
	;
	; Segments in use flag
	 S:'$D(vobj(dep,57)) vobj(dep,57)=$G(^ACN(vobj(dep,-3),57))
	I $P(vobj(dep,57),$C(124),48) D  K vobj(+$G(ttxtmp)) Q 
	.	S ADJACR=$get(ADJACR)
	.	S ADJAWT=$get(ADJAWT)
	.	S (ADJINT,PEN,NEGADJ)=""
	.	Q 
	;
	S ADJINT=$get(ADJINT)
	S ADJACR=$get(ADJACR)
	S ADJAWT=$get(ADJAWT)
	S PEN=$get(PEN)
	S NEGADJ=$get(NEGADJ)
	;
	K vobj(+$G(ttxtmp)) Q 
	;
CWIP2(dep,ttxtmp,OBAL,ACR,NEGACR,NEGACRUN,RESINT,UNCACR)	;
	;
	N BAL,MINACR
	;
	 S:'$D(vobj(dep,57)) vobj(dep,57)=$G(^ACN(vobj(dep,-3),57))
	I $P(vobj(dep,57),$C(124),48) D  Q 
	.	N RSPAR
	.	S RSPAR("CLOSE")=1
	.	S RSPAR("EXSKIP")=1
	.	D EXTERN^RECALSEG(.dep,.ttxtmp,.RSPAR)
	.	Q 
	;
	; Future-dated closeout
	I EFD>TJD D  Q 
	.	N DLR,ETC,ORIGACR,ORIGAWT,ORIGNADJ,ORIGNUNA
	.	;
	.	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	.	S ORIGACR=$P(vobj(dep,54),$C(124),1)
	.	 S:'$D(vobj(dep,450)) vobj(dep,450)=$G(^ACN(vobj(dep,-3),450))
	.	S ORIGAWT=$P(vobj(dep,450),$C(124),5)
	.	S ORIGNADJ=$P(vobj(dep,54),$C(124),18)
	.	S ORIGNUNA=$P(vobj(dep,54),$C(124),43)
	.	;
	.	; protect DLR
	.	 S:'$D(vobj(dep,53)) vobj(dep,53)=$G(^ACN(vobj(dep,-3),53))
	.	S DLR=$P(vobj(dep,53),$C(124),4)
	. N vo1 D EXEC^UANTIC(.dep,.ttxtmp,.vo1,EFD,"00",,,,.vo2) K vobj(+$G(vo1))
	.	; Date Last Renewed
	.	 S:'$D(vobj(dep,53)) vobj(dep,53)=$G(^ACN(vobj(dep,-3),53))
	. S vobj(dep,-100,53)="",$P(vobj(dep,53),$C(124),4)=DLR
	.	;
	.	; Positive Accrued Int/Div
	.	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	.	S ADJACR=$P(vobj(dep,54),$C(124),1)-ORIGACR
	.	; Accrued Withholding Tax
	.	 S:'$D(vobj(dep,450)) vobj(dep,450)=$G(^ACN(vobj(dep,-3),450))
	.	S ADJAWT=$P(vobj(dep,450),$C(124),5)-ORIGAWT
	.	; Negative Accrued
	.	S NEGADJ=$P(vobj(dep,54),$C(124),18)-ORIGNADJ
	.	; Negative Accrued Interest Unauthorized
	.	S NEGADJ=NEGADJ+($P(vobj(dep,54),$C(124),43)-ORIGNUNA)
	.	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	.	S PRIN=$P(vobj(dep,51),$C(124),1)
	.	Q 
	;
	I OBAL>0 S BAL=0
	E  S BAL=OBAL
	;
	S MINACR=""
	;
	; Make dep.bal look as if balance already gone to zero for recalc
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	S vobj(dep,-100,51)="",$P(vobj(dep,51),$C(124),1)=0
	;
	D ENT^RECALC(.dep,.ttxtmp)
	;
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	S vobj(dep,-100,51)="",$P(vobj(dep,51),$C(124),1)=OBAL
	;
	Q 
	;
CLSINI(dep,trn)	;
	 S:'$D(vobj(dep,444)) vobj(dep,444)=$G(^ACN(vobj(dep,-3),444))
	 S:'$D(vobj(dep,428)) vobj(dep,428)=$G(^ACN(vobj(dep,-3),428))
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	 S:'$D(vobj(dep,464)) vobj(dep,464)=$G(^ACN(vobj(dep,-3),464))
	 S:'$D(vobj(dep,432)) vobj(dep,432)=$G(^ACN(vobj(dep,-3),432))
	 S:'$D(vobj(dep,57)) vobj(dep,57)=$G(^ACN(vobj(dep,-3),57))
	 S:'$D(vobj(dep,436)) vobj(dep,436)=$G(^ACN(vobj(dep,-3),436))
	 S:'$D(vobj(dep,49)) vobj(dep,49)=$G(^ACN(vobj(dep,-3),49))
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	;
	; Cannot close lead account used in account analysis
	Q:$$CHKLEAD(vobj(dep,-3),$P(vobj(dep,444),$C(124),1)) 
	;
	; Available interest accrual
	S AIACR=$P(vobj(dep,428),$C(124),20)
	; Ledger balance
	S (BAL,PRIN)=$P(vobj(dep,51),$C(124),1)
	; Backup Withholding
	S BWF=$P(vobj(dep,54),$C(124),15)
	; Currency Code
	S CRCD=$P(vobj(dep,50),$C(124),12)
	; Cumulative Interest
	S CUMDEP=$P(vobj(dep,464),$C(124),1)
	; Defer Posting Int Adjustments
	S DEFINADJ=$P(vobj(dep,432),$C(124),6)
	; Interest Paid Not Credited
	S INTAVLNC=$P(vobj(dep,51),$C(124),18)
	; Nominal Int/Div Rate
	S IRN=$P(vobj(dep,57),$C(124),1)
	; Int/Div Paid - Life
	S IPL=$P(vobj(dep,54),$C(124),8)
	; Negative accrual
	S NEGACR=$P(vobj(dep,54),$C(124),18)
	; Negative interest adjustment
	S NEGADJ=$get(NEGADJ)
	; Negative accrued unauthorized
	S NEGACRUN=$P(vobj(dep,54),$C(124),43)
	; Residual Interest
	S RESINT=$P(vobj(dep,54),$C(124),41)
	; Account Status
	S STAT=$P(vobj(dep,51),$C(124),21)
	; Uncollected accrued
	S UNCACR=$P(vobj(dep,436),$C(124),10)
	;
	; Determine whether we should be working with a debit balance closeout.
	I $P(vobj(dep,49),$C(124),24)-$E(($P(vobj(trn,0),$C(124),1)),1) S DIR=-1
	E  S DIR=1
	;
	Q 
	;
CLOSE(dep,trn,BALCL,DWA,DSWA)	;
	;
	N DFTAMT,DIR,FEEAMT,FEEACT,STTAX
	;
	S (FEEAMT,FEEACT)=0
	;
	; Determine whether we should be working with a debit balance closeout.
	 S:'$D(vobj(dep,49)) vobj(dep,49)=$G(^ACN(vobj(dep,-3),49))
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $P(vobj(dep,49),$C(124),24)-$E(($P(vobj(trn,0),$C(124),1)),1) S DIR=-1
	E  S DIR=1
	;
	D FEES(.dep,.trn,.FEEAMT,.FEEACT,.DWA,.DSWA)
	;
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	I $P(vobj(dep,51),$C(124),13) D  Q:ER 
	.	N ACN,CID,RPASEQ,STTAX,TAMT
	.	S TAMT=BALCL-FEEACT-FEEAMT
	.	;
	.	 S:'$D(vobj(dep,99)) vobj(dep,99)=$G(^ACN(vobj(dep,-3),99))
	.	S ACN=$P(vobj(dep,99),$C(124),1)
	.	; Retirement Plan Account Sequence Number
	.	S RPASEQ=$P(vobj(dep,51),$C(124),34)
	.	S CID=vobj(dep,-3)
	.	;
	.	F STTAX=0:1:1 D CLOSE^IRAWH(.dep)
	.	Q 
	;
	; Closeout default amount
	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	S DFTAMT=$$^SCARND(BALCL-DWA-DSWA-FEEACT-FEEAMT-$P(vobj(dep,54),$C(124),5),0,vobj(dep,-3))
	;
	; Closeout amount is negative
	I DFTAMT<0,DIR>0 D SETERR^DBSEXECU("TTX","MSG",555) Q 
	;
	; Closeout amount is not negative
	I DFTAMT>0,DIR<0 D SETERR^DBSEXECU("TTX","MSG",556) Q 
	;
	S DFT("AMT")=DFTAMT*DIR
	;
	Q 
	;
CHKLEAD(CID,ANLTYP)	;
	S ER=0
	;
	I ANLTYP=1 D
	.	;
	.	N rs,vos1,vos2,vos3,vos4,vos5 S rs=$$vOpen1()
	.	; Cannot close the lead account used in account analysis
	.	I ''$G(vos1) D SETERR^DBSEXECU("DEP","MSG",4357) Q:ER 
	.	Q 
	;
	Q ER
	;
IP(dep)	;
	 S:'$D(vobj(dep,49)) vobj(dep,49)=$G(^ACN(vobj(dep,-3),49))
	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	;
	N DA
	;
	I $P(vobj(dep,49),$C(124),37)=2 D
	.	; credit
	.	I ITC S DA=$P(vobj(dep,54),$C(124),1)
	.	; debit
	.	E  S DA=$P(vobj(dep,54),$C(124),18)
	.	Q 
	E  S DA=($P(vobj(dep,54),$C(124),1)-$P(vobj(dep,54),$C(124),18)-$P(vobj(dep,54),$C(124),43))
	;
	S DFT("AMT")=$$^SCARND(DA,0,vobj(dep,-3))
	;
	Q 
	;
STMGRP(dep)	;
	 S:'$D(vobj(dep,62)) vobj(dep,62)=$G(^ACN(vobj(dep,-3),62))
	I X S I(3)=""
	; Statement Flag
	I X="",'$P(vobj(dep,62),$C(124),5) Q 
	;
	; Not a statement account
	I '$P(vobj(dep,62),$C(124),5) D SETERR^DBSEXECU("DEP","MSG",2024) Q 
	;
	; If defined in product, DO NOT require a statement group
	;
	N proddftd,vop1,vop2 S vop1=TYPE,proddftd=$$vDb7(TYPE)
	 S vop2=$G(^UTBLDFTD(vop1,431))
	I $P(vop2,$C(124),1) Q 
	;
	; Statement group required
	I 'X D SETERR^DBSEXECU("PRODDFTD","MSG",2537) Q 
	;
	N cmbgrp,vop3 S cmbgrp=$$vDb8(ACN,X,.vop3)
	;
	; New statement grp
	I '$G(vop3) Q 
	;
	; Restricted Statement Group
	I '$P(cmbgrp,$C(124),5) Q 
	;
	; No accounts in restricted group
	N rs,vos1,vos2,vos3,vos4 S rs=$$vOpen2()
	I '$G(vos1) Q 
	;
	; Restricted statement group.  Only one account allowed.
	D SETERR^DBSEXECU("PRODDFTD","MSG",2406)
	;
	Q 
	;
NOTEFD(NOTMIN,NOTICE,NOTNBC,NOTDAT)	;
	;
	I $get(NOTDAT)="" Q ""
	I $get(NOTNBC)'="" Q $$NBD^UNBD(NOTDAT+1,NOTMIN,0,NOTNBC)
	;
	Q $S(NOTDAT:NOTDAT+NOTMIN,1:"")
	;
NOTEXP(NOTMAX,NOTNBC,NOTEFD)	;
	;
	I $get(NOTEFD)="" Q ""
	I $get(NOTNBC)'="" Q $$NBD^UNBD(NOTEFD+1,NOTMAX,0,NOTNBC)
	;
	Q $S(NOTEFD:NOTEFD+NOTMAX,1:"")
	;
FEES(dep,trn,FEEAMT,FEEACT,DWA,DSWA)	;
	N AIACR,BAL,BWF,CRCD,CRT,CUMDEP,DEFINADJ,INTAVLNC,IPL,IRN
	N NEGACR,NEGADJ,NEGACRUN,RESINT,STAT,UNCACR
	;
	D CLSINI(.dep,.trn)
	;
	S FEEAMT=0
	S FEEACT=0
	;
	; Substract service charges
	; direct transaction fee
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $E(($P(vobj(trn,0),$C(124),23)),10) S FEEAMT=$$
FEE10(.dep,.trn,.FEEAMT) Q:$get(ER) 
	; closeout service fees
	 S:'$D(vobj(trn,0)) vobj(trn,0)=$G(^TRN(vobj(trn,-3),0))
	I $P(vobj(dep,50),$C(124),15)'="",$E(($P(vobj(trn,0),$C(124),23)),9) S FEEACT=$$FEE9(.dep,.FEEACT)
	;
	Q 
	;
FEE9(dep,FEEACT)	;
	;
	; New this variable bacause BCHFEEUTL may reset it.
	N FEEAMT
	;
	; Get FEEACT
	D EXTERN^BCHFEEUT(.dep,"11",$S(EFD:EFD,1:TJD)) Q:$get(ER) 
	;
	; Add Federal and State Withholding to FEEACT
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	I FEEACT,$P(vobj(dep,51),$C(124),13) S FEEACT=FEEACT+$$RPACRT^IRAWH(.dep,113,FEEACT)+$$RPACRTS^IRAWH(.dep,113,FEEACT)
	;
	; Calculate CPMF charges on Service Fees.
	I FEEACT S FEEACT=FEEACT+$$CTFCALC(.dep,FEEACT)
	;
	Q 
	;
FEE10(dep,trn,FEEAMT)	;
	N MAXDLY,PGM,TAMT
	;
	; Fee not taken from closing account
	 S:'$D(vobj(dep,62)) vobj(dep,62)=$G(^ACN(vobj(dep,-3),62))
	I $P(vobj(dep,62),$C(124),14)'="" Q FEEAMT
	;
	; Fee plan not on transaction
	 S:'$D(vobj(trn,4)) vobj(trn,4)=$G(^TRN(vobj(trn,-3),4))
	I $P(vobj(trn,4),$C(124),1)="" Q FEEAMT
	;
	; Feeplan does not contain direct transaction fees
	I $P(vobj(trn,4),$C(124),3)="" Q FEEAMT
	;
	S MAXDLY=""
	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	S TAMT=BALCL-DWA-DSWA-$P(vobj(dep,54),$C(124),5)
	;
	; Find correct posting program get program from ^FEEPGM
	S PGM=$$FEEPGM^UFID($P(vobj(trn,4),$C(124),1),$S(EFD:EFD,1:TJD))
	;
	; Service fee plan ~p1 not compiled
	I PGM="" D SETERR^DBSEXECU("FEEPLN","MSG",2481,$P(vobj(trn,4),$C(124),1)) Q FEEAMT
	;set PGM="^"_PGM_"(.dep,3,trn.feegrp"_",1,1,"_TAMT_")"
	; Irina's patch
	S FEEGRP=$P(vobj(trn,4),$C(124),3)
	S PGM="^"_PGM_"(.dep,3,FEEGRP,1,1,"_TAMT_")"
	D @PGM Q:ER FEEAMT
	;
	; Fee amount not adjusted
	I (FEEAMT>TAMT),$P(vobj(dep,62),$C(124),12) S FEEAMT=$$FEEOPT^SRVTRN2(.dep,.trn,TAMT)
	;
	; Add Federal and State withholding to fee amount
	 S:'$D(vobj(dep,51)) vobj(dep,51)=$G(^ACN(vobj(dep,-3),51))
	I FEEAMT,$P(vobj(dep,51),$C(124),13) S FEEAMT=FEEAMT+$$RPACRT^IRAWH(.dep,113,FEEAMT)+$$RPACRTS^IRAWH(.dep,113,FEEAMT)
	;
	; Calculate CPMF charges on Service Fees.
	I FEEAMT S FEEAMT=FEEAMT+$$CTFCALC(.dep,FEEAMT)
	;
	Q FEEAMT
	;
PV(ODT,FV,IACM,IRN,DAYS,CMP)	;
	;
	N OLDBAL,HIGH,LOW,ACR,X,BAL
	;
	S CMP=$get(CMP)
	S ACR=""
	S OLDBAL=""
	S HIGH=FV
	S LOW=0
	S BAL=""
	;
	F  D  I +BAL=FV!(BAL-OLDBAL=0) Q 
	.	S OLDBAL=BAL
	.	S ACR=""
	.	S X=(HIGH-LOW)/2
	.	S PV=HIGH-X
	.	S PV=$$^SCARND(PV,0,,,2)
	.	S BAL=PV
	.	;
	.	I CMP F I=1:1:DAYS S ACR=$$IACM(IACM,DAYS,IRN) S BAL=BAL+ACR
	.	I 'CMP F I=1:1:DAYS S ACR=$$IACM(IACM,DAYS,IRN)+ACR
	.	I 'CMP S BAL=BAL+ACR
	.	S BAL=$$^SCARND(BAL,0,,,2)
	.	I BAL>FV S HIGH=PV
	.	I BAL<FV S LOW=PV
	.	Q 
	;
	Q PV
	;
IACM(IACM,DAYS,IRN)	; Interest accrual calculation method
	N ACR,DY
	;
	S DY=$$DY^UIC(IACM,ODT+DAYS-1)
	I IACM="00" S ACR=BAL*IRN/100/365
	I IACM="01" S ACR=BAL*IRN/100*360/DY/DY
	I IACM="10" S ACR=BAL*IRN/100/360
	I IACM=11 S ACR=BAL*IRN/100/DY
	;
	Q ACR
	;
CLOSAMT1(dep,ttx)	;
	;
	N DFT,DWA,DSWA,ETC
	;
	S (DWA,DSWA)=0
	S ETC=$P(vobj(ttx),$C(124),3)
	;
	N trn S trn=$$vDb4(ETC)
	;
	I 'CINT,'CPEN D C(.dep,.ttx,.trn,.DWA,.DSWA)
	I 'CINT,CPEN D CWP(.dep,.ttx,.trn,EFD,.DWA,.DSWA)
	I CINT,'CPEN D CWI(.dep,.ttx,.trn,.DWA,.DSWA)
	I CINT,CPEN D CWIP(.dep,.ttx,.trn,EFD,.DWA,.DSWA)
	;
	; Add State and Federal w/h amounts to closeout amount
	K vobj(+$G(trn)) Q DFT("AMT")+DWA+DSWA
	;
CHECKLB(IRCB,NEGACR,NEGACRUN,UNCACR)	;
	I IRCB'=5 Q 
	;
	N TNEGACR
	;
	S TNEGACR=NEGACR+NEGACRUN+UNCACR
	; Cannot process with negative accrual ~p1
	I TNEGACR D SETERR^DBSEXECU("DEP","MSG",471,TNEGACR)
	;
	Q 
	;
DEFINT(dep,ttx,DPINT,DNINT,DRINT,DBWA)	;
	; Consider deferred interest
	;
	N BRCD
	 S:'$D(vobj(dep,52)) vobj(dep,52)=$G(^ACN(vobj(dep,-3),52))
	S BRCD=$P(vobj(dep,52),$C(124),1)
	D EXT^DEPIADJ(.dep,,.DPINT,.DNINT,.DRINT,.DBWA) Q:ER 
	;
	Q 
	;
CUMDEP(dep,INT,IPL)	;
	;
	S CUMINT=$$CURRACR^UACRIND(.dep,EFD,IRN) Q:ER 
	S CUMINT=$$^SCARND(CUMINT,0,vobj(dep,-3)) Q:ER 
	;
	; Total cumulative int minus current accrual and int paid life
	S CUMINT=CUMINT-(INT+IPL)
	;
	Q 
	;
PCTAX(dep,ttx)	;
	;
	S PCTAXAMT=0
	;
	I EFD="" S EFD=TJD
	;
	 S:'$D(vobj(dep,466)) vobj(dep,466)=$G(^ACN(vobj(dep,-3),466))
	 S:'$D(vobj(dep,52)) vobj(dep,52)=$G(^ACN(vobj(dep,-3),52))
	I $P(vobj(dep,466),$C(124),8)>0,(EFD-$P(vobj(dep,52),$C(124),2)'>$P(vobj(dep,466),$C(124),8)) D
	.	 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	.	S PCTAXAMT=$$PRECLOUT^IOFTAX(vobj(dep,-3),EFD-$P(vobj(dep,52),$C(124),2),$P(vobj(dep,54),$C(124),1),$P(vobj(dep,466),$C(124),8))
	.	I PCTAXAMT>0 D
	..		N SAVACR
	..		S SAVACR=$P(vobj(dep,54),$C(124),1)
	..	 S vobj(dep,-100,54)="",$P(vobj(dep,54),$C(124),1)=$P(vobj(dep,54),$C(124),1)-PCTAXAMT
	..		D ^UMAT(.dep,.ttx)
	..		 S:'$D(vobj(dep,54)) vobj(dep,54)=$G(^ACN(vobj(dep,-3),54))
	..	 S vobj(dep,-100,54)="",$P(vobj(dep,54),$C(124),1)=SAVACR
	..		S INT=SAVACR
	..		Q 
	.	Q 
	Q 
	;
ADDRESS	;
	N LINE
	;
	S CO(4)=""
	S CO(5)=""
	S CO(6)=""
	;
	S LINE="Malvern"_", "_"PA"_"  "_"US"_"  "_19355
	;
	; Institution Name
	S CO(1)="MODEL BANK"
	; Customer Address 1
	S CO(2)="2 West Liberty Blvd"
	I CO(2)="" S CO(2)=LINE S CO(3)="" Q 
	;
	; Customer Address Line 2
	S CO(3)="Suite 300"
	I CO(3)="" S CO(3)=LINE S CO(4)="" Q 
	;
	; Customer Address Line 3
	S CO(4)=""
	I CO(4)="" S CO(4)=LINE S CO(5)="" Q 
	;
	S CO(5)=LINE
	S CO(6)=""
	;
	Q 
	;
CTFCALC(dep,FEEAMT)	;
	; Used if PCF10 or PCF9 flags are turned on.
	;
	N CID,CTFAMT,TMPETC,TYPE
	;
	; No CTF plans linked to the account
	S CID=vobj(dep,-3)
	N rs,vos1,vos2,vos3 S rs=$$vOpen3()
	I '$G(vos1) Q 0
	;
	S CTFAMT=0
	;
	S TYPE=$P(vobj(dep,50),$C(124),1)
	N prodctl,vop1,vop2,vop3 S vop1=TYPE,prodctl=$$vDb9(TYPE,.vop2)
	 S vop3=$G(^UTBLCTL(vop1,14))
	;
	I $G(vop2) S CTFAMT=$$CTFINQ^CTFCALC(CID,$S($P(vop3,$C(124),20):$P(vop3,$C(124),20),1:$P(vop3,$C(124),1)),FEEAMT)
	;
	Q CTFAMT
	;
vSIG()	;
	Q "60526^54939^kini^26079" ; Signature - LTD^TIME^USER^SIZE
	;
vdatFre(object,p1,p2,p3)	; Date.Next Frequency
	;
	;  #OPTIMIZE FUNCTIONS OFF
	I (object="")!(p1="") Q ""
	I ($get(p3)="") S p3=0
	N x S x=$get(SVFRE(p1,object,p3))
	I (x="") Q $$NJD^UFRE(object,p1,.p2,p3)
	S p2=$piece(x,"|",2) Q $piece(x,"|",1)
	;  #OPTIMIZE FUNCTIONS,OBJECTS ON
	;
vDb4(v1)	;	vobj()=Db.getRecord(TRN,,0)
	;
	N vOid
	S vOid=$O(vobj(""),-1)+1,vobj(vOid,-1)="RecordTRN"
	I '$D(^TRN(v1))
	I $T K vobj(vOid) S $ZS="-1,"_$ZPOS_",%PSL-E-RECNOFL" X $ZT
	S vobj(vOid,-2)=1
	S vobj(vOid,-3)=v1
	Q vOid
	;
vDb6(v1,v2out)	;	voXN = Db.getRecord(DEP,,1,-2)
	;
	N dep
	S dep=$G(^ACN(v1,50))
	I '($P(dep,$C(124),2)="D")
	;
	S v2out='$T
	Q dep
	;
vDb7(v1)	;	voXN = Db.getRecord(PRODDFTD,,1)
	;
	N proddftd
	S proddftd=$G(^UTBLDFTD(v1,50))
	I proddftd="",'$D(^UTBLDFTD(v1,50))
	;
	Q proddftd
	;
vDb8(v1,v2,v2out)	;	voXN = Db.getRecord(CMBGRP,,1,-2)
	;
	N cmbgrp
	S cmbgrp=$G(^CIF(v1,110,v2))
	I cmbgrp="",'$D(^CIF(v1,110,v2))
	;
	S v2out='$T
	Q cmbgrp
	;
vDb9(v1,v2out)	;	voXN = Db.getRecord(PRODCTL,,1,-2)
	;
	N prodctl
	S prodctl=$G(^UTBLCTL(v1,50))
	I prodctl="",'$D(^UTBLCTL(v1,50))
	;
	S v2out='$T
	Q prodctl
	;
vDbNew1(v1,v2,v3,v4)	;	vobj()=Class.new(TTX)
	;
	N vOid
	 S vOid=$O(vobj(""),-1)+1,vobj(vOid,-1)="RecordTTX",vobj(vOid,-2)=0,vobj(vOid)=""
	S vobj(vOid,-3)=v1
	S vobj(vOid,-4)=v2
	S vobj(vOid,-5)=v3
	S vobj(vOid,-6)=v4
	Q vOid
	;
vOpen1()	;	ANLCID FROM DEP WHERE ANLCID=:CID AND STAT<>4
	;
	;
	S vos1=2
	D vL1a1
	Q ""
	;
vL1a0	S vos1=0 Q
vL1a1	S vos2=$G(CID) I vos2="",'$D(CID) G vL1a0
	S vos3=""
vL1a3	S vos3=$O(^XREF("ANLLINK",vos2,vos3),1) I vos3="" G vL1a0
	S vos4=$G(^ACN(vos3,50))
	S vos5=$G(^ACN(vos3,51))
	I '($P(vos4,"|",2)="D") G vL1a3
	I '(+$P(vos5,"|",21)'=4) G vL1a3
	Q
	;
vFetch1()	;
	;
	;
	I vos1=1 D vL1a3
	I vos1=2 S vos1=1
	;
	I vos1=0 Q 0
	;
	S rs=vos2
	;
	Q 1
	;
vOpen2()	;	CID FROM CMBSTM WHERE ACN=:ACN AND STMGRP=:X
	;
	;
	S vos1=2
	D vL2a1
	Q ""
	;
vL2a0	S vos1=0 Q
vL2a1	S vos2=$G(ACN) I vos2="" G vL2a0
	S vos3=$G(X) I vos3="" G vL2a0
	S vos4=""
vL2a4	S vos4=$O(^CIF(vos2,110,vos3,vos4),1) I vos4="" G vL2a0
	Q
	;
vFetch2()	;
	;
	;
	I vos1=1 D vL2a4
	I vos1=2 S vos1=1
	;
	I vos1=0 Q 0
	;
	S rs=vos4
	;
	Q 1
	;
vOpen3()	;	CTFPLN FROM CTFPLNCID WHERE CID=:CID
	;
	;
	S vos1=2
	D vL3a1
	Q ""
	;
vL3a0	S vos1=0 Q
vL3a1	S vos2=$G(CID) I vos2="" G vL3a0
	S vos3=""
vL3a3	S vos3=$O(^ACN(vos2,"123",vos3),1) I vos3="" G vL3a0
	Q
	;
vFetch3()	;
	;
	;
	I vos1=1 D vL3a3
	I vos1=2 S vos1=1
	;
	I vos1=0 Q 0
	;
	S rs=vos3
	;
	Q 1
	;
vReCp1(v1)	;	RecordDEP.copy: DEP
	;
	N vNod,vOid
	I $G(vobj(v1,-2)) D
	.	F vNod=1,49,50,51,52,53,54,55,57,60,61,62,63,65,66,67,68,70,90,98,99,100,103,104,105,106,107,108,111,114,115,210,300,400,402,425,426,427,428,429,430,431,432,434,435,436,437,438,439,440,442,444,446,447,448,450,452,454,456,458,460,462,464,466,468,500,901 S:'$D(vobj(v1,vNod)) vobj(v1,vNod)=$G(^ACN(vobj(v1,-3),vNod))
	S vOid=$$copy^UCGMR(v1)
	Q vOid
	;
vReCp2(v1)	;	RecordDEP.copy: DEP
	;
	N vNod,vOid
	I $G(vobj(v1,-2)) D
	.	F vNod=1,49,50,51,52,53,54,55,57,60,61,62,63,65,66,67,68,70,90,98,99,100,103,104,105,106,107,108,111,114,115,210,300,400,402,425,426,427,428,429,430,431,432,434,435,436,437,438,439,440,442,444,446,447,448,450,452,454,456,458,460,462,464,466,468,500,901 S:'$D(vobj(v1,vNod)) vobj(v1,vNod)=$G(^ACN(vobj(v1,-3),vNod))
	S vOid=$$copy^UCGMR(v1)
	Q vOid
