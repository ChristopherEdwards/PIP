COMCNV	  /*
ORIG: ARPAV - 11/09/2000
DESC: Commission Plan Query Execution

---- Comments --------------------------------------------------------

	Description:

	This routine is a conversion routine to accompany the 
	fix applied to commission processing, ARQ 40835.  In this fix,
	a new query is defined for each commission plan.  This procedure will
	loop through all commission plans defaulted to the account level 
	and verify that each passes this new query.  If it does not, then
	the plan will be removed from the account level.

---- Revision History ------------------------------------------------

	11/09/00 - ARPAV - 40835
		   Created

----------------------------------------------------------------------
 */
 
 //  Loop through all account level commission plans and re-evaluate
 //   the plans according to the initial query.

 new CID

 set CID=""
 for  set CID=Db.nextKey("ACN","CID")  quit:CID=""  do {
 	new CPLAN,AGENT
 	set CPLAN=""
 	for  set CPLAN=Db.nextKey("COMPLNCID","CID,CPLAN")  quit:CPLAN=""  do CPLAN
	}
 quit
 
 //----------------------------------------------------------------------------
CPLAN  // Check commission plans
 //----------------------------------------------------------------------------
 
 // For each commission plan, check to see if it account level and applied.
 new DATA,INTQUERY,query

 
 set INTQUERY=Db.getOneRow("INTQUERY","UTBLCOMPLN","CPLAN")
 set query=INTQUERY
 if (Db.isDefined("UTBLCOMPLN","CPLAN")),($$CHECKCID^COMCALC()) quit      //  if account passes query, don't delete
 
 // at this point, query failed so remove the plan from the account
 do Db.fastDelete("COMPLNCID","CID,CPLAN")

 quit

vSIG()	quit "59886^43499^Sanchez SCM Administrator^1599"	// Signature - LTD^TIME^USER^SIZE
