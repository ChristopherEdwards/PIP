public LNCPS
	/*
		Commitment Master Payment Schedule  inquiry
	
	---- Revision History ------------------------------------------------
	
	07/31/06 - KELLYP - CR 22048
		   Modified VPG00 section to eliminate PRECEDENCE warning.
	
	08/24/05 - KUMARB - 16684
		   Converted to PSL
	----------------------------------------------------------------------
	*/
	do INIT
	quit
	
INIT	//
	type Number %PAGE,%PG,CID
	type String FPA(),VFMQ
	set %PG=0,%PAGE=1,%ProcessMode=2
	do VPG
	quit
	
VPG	// Page control
	type public Number %PG
	do VPG00
	quit	
	
VPG00	// Set up
	type public Boolean ER
	type public Number %PAGE,%PG
	type public String FPA(),RM,VFMQ
	type Number ALP,CNT,IOSL,LCID
	type String %READ,%TAB(),IO
	
	set %TAB("CID")=".CCL3/XPP=D PPCID^LNCPS"
	set %TAB("IO")=$$IO^SCATAB($I)
	
	set %READ="@@%FN,,,CID/REQ,IO/REQ"
	do ^UTLREAD if VFMQ="Q" quit

	if IO'=$I do OPEN^SCAIO quit:ER
	set ALP=IOSL-10
	set LCID="" do EXEC
	
	set CNT=FPA("").order(-1)
	if CNT do { quit
		set %PAGE=(CNT\ALP)+(CNT#ALP)
		set %PG=%PG+1
		do VPG01
		}
	// No principal payments scheduled
	set RM=$$^MSG(1975)
	set VFMQ="Q",ER="W"
	quit
	
VPG01	// Screen
	type public Number CID
	type String SID
	type RecordLN ln=Db.getRecord("LN","CID=:CID")
	
	set SID="LNCPS" do DRV^USID(%ProcessMode,SID,.ln)
	quit
	
PPCID	// Post processor - commitment number prompt
	type public Boolean ER
	type public String RM,X
	type String %EXT,CLS,ZCLS
	if X="" quit
	set %EXT=1,(CLS,ZCLS)="L" do ^UACN quit:ER
	
	type RecordLN ln=Db.getRecord("LN","CID=:X",1)
	if ln.cpf quit
	// Not a commitment account
	do Runtime.setErrMSG("LN",2015)
	quit
	
EXEC	// Collate through accounts within commitment and combine payments
	type public String FPA()
	type Number DST
	type String PE,TP(,)
	
	set (DST,FPA)=0
	
	type DbSet ds=Db.selectDbSet("LN","CCL=:CID")
	if ds.isEmpty() do EXEC2 quit
	
	while ds.next() do {
		type RecordLN ln=ds.getRecord("LN")
		if ln.stat=4 quit    // Ignore closed accounts
		if ln.dist1fre'="*" quit  // Ignore non pmt sch accounts
	
		// Determine which distribution contains "P"rincipal
		type RecordLNBIL0 lnbil0=Db.getRecord("LNBIL0","CID=:ln.cid")
		set PE=$$BIL0^BILFUNCS(.lnbil0,"P")
		set DST=PE.piece("#",4)
		
		set FPA=0
		do EXEC1(.ln)
		}
	quit
	
EXEC1(RecordLN ln)	// Payment schedule level
	type public Number DST
	type public String FPA(),TP(,)
	
	type DbSet dsps=Db.selectDbSet("LNPS1","CID=:ln.cid","PDD ASC")
	while dsps.next() do {
		type RecordLNPS1 lnps1=dsps.getRecord("LNPS1")
		
		if DST=2,'lnps1.d2f quit
		if DST=3,'lnps1.d3f quit
		if DST=4,'lnps1.d4f quit
		
		set TP(lnps1.pdd,ln.cid)=(+lnps1.fpc)_"|"_ln.type
		}
	quit
	
EXEC2	//
	type public String FPA(),TP(,)
	type Date D
	type Number C,S,T
	type String A,B
	
	set (D,S,T)=""
	for  set D=TP(D).order() quit:D.isNull()  do {
		set C=""
		for  set C=TP(D,C).order() quit:C.isNull()  do {
			set S=S+1
			set T=T+TP(D,C)
			set A=$J($$FN^SCARND(+TP(D,C),",",C.get()),16)
			set B=$J($$FN^SCARND(T,",",C.get()),16)
			set FPA(S)=D_"|"_C_"|"_A_"|"_B_"|"_TP(D,C).piece("|",2)
			}
		}
	quit

vSIG()	quit "60477^65450^Pat Kelly^2905"	// Signature - LTD^TIME^USER^SIZE
