TRNSD   /*
               ORIG:  9/1/98 - Claude Jeruchim
               DESC:  Supports function TRNSD01.
                      This allows the user to maintain transaction set support
                      data.
 
          ---- Revision History -----------------------------------------------
	   01/31/06 - ARPAVC - 19156
	   	      Releasing procedure in V70.
	   	      
           09/27/02 - DATTAR - 49451
                      Converted to PSL
 
           03/18/02 - JERUCHIMC - 49527
                      Define local array from disk, and set up UX
                      array before filing.
 
         ----------------------------------------------------------------------
        */
 

        set %ProcessMode=1
        set %READ="@@%FN,,,ETC/REQ"
        set %NOPRMT="N"
        set %TAB("ETC")="[TRNSD]ETC"
        do INIT
        quit
 

INIT    //
 
        new VFMQ,OLNTB
 
        set %PG=0
        set %PAGE=1
 
        do VPG
 
        quit
 
VPG     // Page control
 
        new FINISH
        set FINISH=0
        for  do { quit:FINISH
                if %PG=0 do VPG00 if ER set FINISH=1 quit
 
                if %PG>0 do VPG01
 
                if "DFQ"[VFMQ do VER set FINISH=1 quit
 
                set %PG=%PG+1
                }
        quit
 
VPG00   // Set up
 
        new OLNTB
 
        do ^UTLREAD
 
        if VFMQ="Q" set ER=1 quit
 
        quit


VPG01   // Setup/Maintenance/Inquiry Screen
 
        new DEFAULT,DESC,PRI,REQD
 
        set %ProcessMode=1
        set MAX=8
 
        // Loop through the TRNSD file to create the array TNRND
        set SEQ=""
        set CNT=0
 
	type DbSet rs=Db.selectDbSet("TRNSD","ETC=:ETC")
        while rs.next() do {
                type RecordTRNSD fTRNSD=rs.getRecord("TRNSD")
                set SEQ=fTRNSD.seq
                set CNT=CNT+1
                if fTRNSD.supdata>999 set CUST=fTRNSD.supdata set STAN=""
                if fTRNSD.supdata<1000 set CUST="" set STAN=fTRNSD.supdata
		  set TRNSD(CNT)=STAN_"|"_CUST_"|"_fTRNSD.des_"|"_0_"|"_fTRNSD.default_"|"_fTRNSD.reqd
                }
 
        if CNT>(MAX-1) set %PAGE=CNT\MAX+1
        else  set %PAGE=1
 
        set %REPEAT=MAX
        set %MODS=(MAX*(%PG-1))+1
 
        do DRV^USID(%ProcessMode,"TRNSD")
 
        quit
 
 
VER     // Verification
 
        if %ProcessMode=2!(%ProcessMode=4)!(VFMQ="Q") do END quit
 
        do FILE
 
        do END
 
        quit

END     // End of processing
 
        if $G(ER)!(%ProcessMode=2)!(%ProcessMode=4) set ER="W" quit
      if VFMQ'="Q" do {
 
                //Support data field deleted
                if (%ProcessMode=3) set RM=$$^MSG(3621)
 
                //Support data field created
                if (%ProcessMode=0) set RM=$$^MSG(3620)
 
                //Support data field modified
                if (%ProcessMode=1) set RM=$$^MSG(3619)
                }
 
        //Support data field not modified
        else  set RM=$$^MSG(3622)
 
        set ER="W"
 
        quit


FILE    // File data
 
        set CNT=""
 
        // If no errors were encountered, file each record.
        for  set CNT=$O(TRNSD(CNT)) quit:CNT=""  do {
                set REC=TRNSD(CNT)
                if $TR(REC,"|")="" quit
                new CUST,DESC,DELREC,STAN,SUPDATA
                set STAN=$P(REC,"|",1)
                set CUST=$P(REC,"|",2)
                set DESC=$P(REC,"|",3)
                set DELREC=$P(REC,"|",4)
                set DEFAULT=$P(REC,"|",5)
                set REQD=$P(REC,"|",6)
                set SEQ=CNT
 
                if DELREC=1 do { quit
                        do Db.delete("TRNSD","ETC=:ETC AND SEQ=:SEQ")
                        set %ProcessMode=3
                        }
 
                if STAN="",CUST'="" set SUPDATA=CUST
                if STAN'="",CUST="" set SUPDATA=STAN
                if STAN="",CUST="" quit

 		type RecordTRNSD fTRNSD=Db.getRecord("TRNSD","ETC=:ETC,SEQ=:SEQ",1)
                do fTRNSD.setAuditFlag(1)
 
                if fTRNSD.getMode()=0 set %ProcessMode=1
                else  set %ProcessMode=0 


                if DELREC=1 set %ProcessMode=3
 
                // Support Data Sequence Number
                if SUPDATA'=fTRNSD.supdata set fTRNSD.supdata=SUPDATA
 
                // Description
                if DESC'=fTRNSD.des set fTRNSD.des=DESC
 
                // Default Value
                if DEFAULT'=fTRNSD.default set fTRNSD.default=DEFAULT
 
                // Required Field
                if REQD'=fTRNSD.reqd set fTRNSD.reqd=REQD
 
                do fTRNSD.save()
 
                }
        quit

vSIG()	quit "60296^48179^Vincent Arpa^4415"	// Signature - LTD^TIME^USER^SIZE
