LFNDUSD	
	/*
	ORIG: kini - 04/05/2005
	DESC: Find amount of funds used per acct type

	---- Comments --------------------------------------------------------

	This procedure summarizes the amount of funds used per loan account 
	types for those product types that have Maximum Funding Limit defined
	in PRODCTL table. It saves the Totals in the HTBLLTYPE, Credit limits 
	by product type table.
	To execute the process, run @FNDUSD, Recalculate Funds Used Amounts 
	function.

	This replaces LFNDUSD.m routine.
	
	---- Revision History ------------------------------------------------

	04/05/05 - KinI - 14385
		Created the procedure. Replaced the message at the end to
		more clearly reflect the process completion results.
		
	*/

	type public String ER

	type Number %PAGE, %PG
	type String %READ, %TAB(), TYPE, VFMQ

	set %PG = 1 
	set %PAGE = 1
	
	set TYPE = "ALL"

	set %TAB("TYPE") = ".QI1/TBL=[PRODDFTL]/HLP=[SYSDEV,PRODDFTL]TYPE/XPP=D EXT^DBSQRY"

	set %READ = "@@%FN,,,TYPE/REQ"

	do ^UTLREAD 
	
	if VFMQ = "Q" set ER=1 quit

	do EXEC 	

	set VFMQ = "Q"

	quit


EXEC

	type public String ER , TYPE

	type String DQQRY(), WHERE
	type Boolean FLG = 0
	
	if '(TYPE.get().isNull()) , (TYPE '= "ALL") set DQQRY(1) = "[PRODDFTL]TYPE "_TYPE

	set WHERE = $$WHERE^SQLCONV(.DQQRY(), "PRODDFTL")
	
	type Public Cache %CACHE()
	
	#ACCEPT Date=04/05/05; PGM=Irina Kin; CR=14385
	type DbSet ds = Db.selectDbSet("PRODDFTL", WHERE, "TYPE ASC")
	
	while ds.next() do {

		type RecordPRODDFTL proddftl = ds.getRecord("PRODDFTL")

		set TYPE = proddftl.type
		
		type RecordPRODCTL prodctl = %CACHE("PRODCTL").getRecord("PRODCTL","TYPE=:TYPE")		
	
		if 'prodctl.maxfnd quit
		
		type Number CRLMT, IUN, X
		type String FUND()

		type ResultSet rs = Db.select("CRLMT,IUN","LN","TYPE=:TYPE")
		while rs.next() do {
			
			set CRLMT = rs.getCol("CRLMT")
			set IUN = rs.getCol("IUN")	// Interest - Unearned

			set X = CRLMT
			// Subtract interest if add-on
			if (proddftl.iam '< 10) , (proddftl.iam '> 14) set X = X - IUN 
			set FUND(TYPE) = FUND(TYPE).get() + X
			}
		
		if FUND(TYPE).data() do {
			type RecordHTBLLTYPE htblltype = Db.getRecord("HTBLLTYPE","TYPE=:TYPE",1)
	
			set htblltype.crlmt = FUND(TYPE)
			do htblltype.save()
	
			set FLG = 1
			
			// Credit limit total for type ~p1 is ~p2
			write !,$$^MSG(5430,TYPE,FUND(TYPE))
			}
		}
	
	// Totals not accumulated
	if FLG = 0 do Runtime.setErrMSG("LN",8267) quit:ER	

	quit
		
	
 #OPTION ResultClass ON
Public String vSIG()	quit "60024^40970^Irina Kin^2325"	// Signature - LTD^TIME^USER^SIZE
