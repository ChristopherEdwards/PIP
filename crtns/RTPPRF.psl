RTPPRF	  	/*
	ORIG: appleyam - 10/19/2006
	DESC: Teller Proof

	---- Comments --------------------------------------------------------

	---- Revision History ------------------------------------------------

	   08/13/07 - APPLEYARDM - CR 28731
	   	   Modified section CASH SQL select where clause to specify that
	   	   the starting date must be less than the current date.  This change 
	   	   is needed to ensure that the begining cash amount is always
	   	   the previous day's ending cash amount.
	   
	   1/11/07 - chhabris - CR24810
		   Retrofit from ICGWeb01_Dev_Profile view for Profile Direct
		   Enhancements.
		   
	   10/19/06 - APPLEYARDM - CR 23686
	   Restored portions of routine for Direct Teller

  	*/
 	quit

public DTL(BRCD,UID,DATE,CRCD)

	type String RESULT,TAB,X
	type Number CR,DR,END,SCSH,START,SUB

	set (SCSH,START,END,CR,DR)=0
	set TAB=$C(9)
	do CSH(.SCSH,BRCD,UID,DATE,CRCD)
	set START=START+SCSH

	if $$CASH^RTPCSH(DATE,BRCD,UID,CRCD)=1 do {
		type ResultSet rs=Db.select("ECTOT","TPCASH","BRCD=:BRCD AND UID=:UID AND TPD=:DATE AND CRCD=:CRCD")
		if rs.next() set END=END+rs.getCol("ECTOT")
		else  set END=END+SCSH
		}

	set X=$$CASH^TTXSUM(BRCD,UID,DATE,CRCD)
	set DR=X.piece("|",1)
	set CR=X.piece("|",2)
	set SUB=START+DR-CR
	set RESULT=DR_TAB_CR_TAB_START_TAB_END_TAB_SUB

	quit RESULT


private CSH(SCSH,BRCD,UID,DATE,CRCD)
	//Collate to find prior day's ending cash (today's starting cash)

	type Boolean Q
	type Date X

	set X=DATE
	set SCSH=0,Q=0
	
	type ResultSet rs1
	 
	set rs1=Db.select("TPD","TPCTRL","BRCD=:BRCD AND UID=:UID AND TPD<:DATE","TPD DESC")
	while rs1.next() quit:Q  do {
		set X=rs1.getCol("TPD")
		if $$CASH^RTPCSH(X,BRCD,UID,CRCD)=1 do {
			type RecordTPCASH tpcash
			set tpcash=Db.getRecord("TPCASH","BRCD=:BRCD,UID=:UID,CRCD=:CRCD,TPD=:X")
			set SCSH=tpcash.ectot
			set Q=1
			}
		} 
	
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "60855^55913^Mike Appleyard^1781"	// Signature - LTD^TIME^USER^SIZE
