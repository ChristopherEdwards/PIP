MAXTRUTL
	/*
 	 PROCEDURE ID:	MAXTRUTL
 	     Original:	GOLPIRAD
		 Date:	06/20/1996
 	         Desc:	Maximum Transaction Amount Utlities
 
 	---- Revision History ------------------------------------------------

	10/28/2002 - Vitaliy Antonov - 43583
		Converted To PSL.

	02/01/02 - MORSE - ARQ #44700
		Modified MAXTR section so we do not assume CRCD is the
		screen base if piece 17 of the TR array is not set.  We
		were previously doing so and this is not always true.
		The condition happened in a multi-currency environment
		when the screen base is different than the system
		currency and the first transaction on the screen is
		in the system currency.

	04/10/97 - SMITHC - 24288
		Modified MAXTR section to set CRCD to the system base
		CRCD if it is not defined on the transaction.
	*/
	quit

MAXTR(RecordTTX ttx,UCLS,CMAX)
	/* Determine if userclass transaction limits are exceeded

	Inputs:
		. ttx	Transaction to check		/TYP=RecordTTX/REQ

		. UCLS	User class to check for auth.	/TYP=T/MECH=VAL/REQ

		. CMAX	Local array of entries from UTBLMXUCLS1 and
			UTBLMXUCLS2 for the given userclass
							/TYP=T/MECH=REFARR/REQ

	Returns:
		. $$	Value of limit exceeded		/TYP=N
			("" = does not exceed limits)
	*/

	new CRCD,MAXAMT,RETAMT,TMPETC
	
	set CRCD=ttx.crcd
	if CRCD="" set CRCD=%SystemCurrency
	
	set RETAMT=""

	set TMPETC=ttx.etc

	type Public Cache %CACHE()
	type RecordTRN trn=%CACHE("TRN").getRecord("TRN",":ETC")

	// Try to quit ASAP
	if '$D(CMAX(CRCD)) quit RETAMT

	// First check at the trancode group level for this userclass
	set MAXAMT=$P($G(CMAX(CRCD,trn.grp)),"|",1,2)
	if MAXAMT'="" do { quit:RETAMT RETAMT
		if ('ttx.itc1),(ttx.tamt>$P(MAXAMT,"|",1)) set RETAMT=$P(MAXAMT,"|",1)
		if (ttx.itc1),(ttx.tamt>$P(MAXAMT,"|",2)) set RETAMT=$P(MAXAMT,"|",2)
		}
	
	// Now check at the userclass level for this userclass
	set MAXAMT=$P($G(CMAX(CRCD)),"|",1,2)
	if MAXAMT'="" do {
		if ('ttx.itc1),(ttx.tamt>$P(MAXAMT,"|",1)) set RETAMT=$P(MAXAMT,"|",1)
		if (ttx.itc1),(ttx.tamt>$P(MAXAMT,"|",2)) set RETAMT=$P(MAXAMT,"|",2)
		}

	quit RETAMT

	
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43576^Sanchez SCM Administrator^1993"	// Signature - LTD^TIME^USER^SIZE
