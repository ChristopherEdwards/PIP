RELUPD	//Public;Relationship code maintenace utility
	/*
	   ORIG: CHIANG - 06/19/95
	   DESC: Relationship code maintenace utility

	   KEYWORDS:

	   INPUTS:

	   RETURNS:
		. ER Error indicator  /TYP=N
		. RM    Error message  /TYP=T

	   RELATED:
		. DBSDEUTL - General purpose data entry utility
	  -----------------------------------------------------------------------
	   Access data entry utility

          ---- Revision History -------------------------------------------------
 
           04/10/02 - KRISHNAG - ARQ # 49794
                      Converted to PSL
	*/

	do ^DBSDEUTL(1,"RELCODE","D PROC^RELUPD")

	quit

PROC	// Processor entry point from DBSDEUTL utility

	/*
	   Compare data buffer (vbuf) against database (^UTBL("VREL",REL,ROLE))
	   and set up the proper history buffer (vhis) and status buffer (vsts)
	   to be used by the DBSINS utility.

	*/

	new frm,i,mseq,rec,seq
	set rec="" set seq=1 set frm="RELCODE"

	// Scan buffer
	for  set rec=$O(vbuf(frm,rec)) quit:rec=""  do {		

		// Record deleted
		if $G(vbuf(frm,rec,"DESC"))="" quit			

		// Same record
		if rec=seq set seq=seq+1 quit				

		// Pack data
		set di="" for  set di=$O(vbuf(frm,rec,di)) quit:di=""  do {		

			if $G(vbuf(frm,seq,"DESC"))="",$D(vhis(frm,seq,"DESC"))
			else  if $D(vbuf(frm,seq,di)) set vhis(frm,seq,di)=vbuf(frm,seq,di)

			set vbuf(frm,seq,di)=vbuf(frm,rec,di)

			// New ROLE code
			set vbuf(frm,seq,"ROLE")=seq		
			}

		// Modified status
		set vsts(frm,REL_"|"_seq)=1_"|"_seq
		set seq=seq+1
		}

	// Total buffer entries
	set mseq=$O(vbuf(frm,""),-1)                        

	// Extra entry on file?
	for i=seq:1:mseq do {

		// Deleted
		if Db.isDefined("RELCODE","REL=:REL,ROLE=:i") set vsts("RELCODE",REL_"|"_i)=3_"|"_i
	
		kill vbuf(frm,i)
		}

	quit

vSIG()	quit "59886^43600^Sanchez SCM Administrator^1650"	// Signature - LTD^TIME^USER^SIZE
