RCIFFIL0 // RELCIF DATA-QWIK filer, part (2)
 // Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 01/31/2007 11:23 - shetyes

	quit		// Not called from top

VJOURNAL(RecordRELCIF relcif)	//RELCIF Journal file entries

	type Public Date %EffectiveDate
	type Public String %TSRC,vpar,vx()
	type String TSRC,vdi,vdx()

	if %TSRC.get().isNull() set TSRC="O"
	else  set TSRC=%TSRC

	if %ProcessMode=3 do {
		if TSRC="B" do {
			do vj1(.relcif)	// Mode=D Tran=B EFD=N,E Seq=1 JRNID=HISTFM_DELETE
			}
		else  if TSRC="O" do {
			do vj1(.relcif)	// Mode=D Tran=O EFD=N,E Seq=1 JRNID=HISTFM_DELETE
			}
		}
	else  if %ProcessMode=0 do {
		if TSRC="B" do {
			do vj2(.relcif)	// Mode=I Tran=B EFD=N,E Seq=1 JRNID=HISTFM_INSERT
			}
		else  if TSRC="O" do {
			do vj2(.relcif)	// Mode=I Tran=O EFD=N,E Seq=1 JRNID=HISTFM_INSERT
			}
		}
	else  if %ProcessMode=1 do {
		if TSRC="B" do {
			do vj3(.relcif)	// Mode=U Tran=B EFD=N,E Seq=1 JRNID=HISTFM_UPDATE
			}
		else  if TSRC="O" do {
			do vj3(.relcif)	// Mode=U Tran=O EFD=N,E Seq=1 JRNID=HISTFM_UPDATE
			}
		}

	quit


vj1(RecordRELCIF relcif)	// HISTFM_DELETE  Table HIST  History on account for delete of a cif

	type Public String EFD,%IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=relcif.cid
	set vlastkey=Db.nextVal("HIST","CID=:v1")
	type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
	set hist.cdt=+$H
	set hist.efd=$G(EFD)
	set hist.ident=%IDENT
	set hist.tcmt=$$TCMTFM^ACNFUNCS(relcif.cid,"REL","ROLE"_$$ACNKLHIS^REL(relcif.acn,relcif.cid),$$ACNKLHIS^REL(relcif.acn,relcif.cid),"",$G(EFD),"CIF "_relcif.acn)
	set hist.time=$P($H,",",2)
	set hist.tjd=TJD
	set hist.tlo=TLO
	set hist.uid=%UID

	do hist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj2(RecordRELCIF relcif)	// HISTFM_INSERT  Table HIST  History on account for inserts

	type Public String EFD,%IDENT,%UID,TJD,TLO
	type String v1,vlastkey
	set v1=relcif.cid
	set vlastkey=Db.nextVal("HIST","CID=:v1")
	type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
	set hist.cdt=+$H
	set hist.efd=$G(EFD)
	set hist.ident=%IDENT
	set hist.tcmt=$$TCMTFM^ACNFUNCS(relcif.acn_","_relcif.cid,"REL","ROLE","",relcif.role,$G(EFD),"CIF "_relcif.acn)
	set hist.time=$P($H,",",2)
	set hist.tjd=TJD
	set hist.tlo=TLO
	set hist.uid=%UID

	do hist.save("/NOVALFK/NOVALDD/NOVALRI")

	quit


vj3(RecordRELCIF relcif)	// HISTFM_UPDATE  Table HIST  History on account for updates

	type Public String vx()
	type String vdi

	set vdi="" for  set vdi=vx(vdi).order() quit:vdi=""  do {
		type Public String vx(),EFD,%IDENT,%UID,TJD,TLO,vfmtable
		type String v1,vlastkey

		type String vold,vnew,vfmtable

		set vold=vx(vdi).piece("|",1)
		set vnew=vx(vdi).piece("|",2)
		set vfmtable=vx(vdi).piece("|",11)

		set v1=relcif.cid
		set vlastkey=Db.nextVal("HIST","CID=:v1")
		type RecordHIST hist=Db.getRecord("HIST","CID=:v1,TSEQ=:vlastkey",1)
		set hist.cdt=+$H
		set hist.efd=$G(EFD)
		set hist.ident=%IDENT
		set hist.tcmt=$$TCMTFM^ACNFUNCS(relcif.acn_","_relcif.cid,"RELCIF",vdi,vold,vnew,$G(EFD),"CIF "_relcif.acn,vfmtable)
		set hist.time=$P($H,",",2)
		set hist.tjd=TJD
		set hist.tlo=TLO
		set hist.uid=%UID

		do hist.save("/NOVALFK/NOVALDD/NOVALRI")
		}

	quit

