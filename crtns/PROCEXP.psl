PROCEXP		/* Private; EXPOSUD
	  
	   Copyright(c)1997 Sanchez Computer Associates, Inc.  All Rights Reserved - 09/06/97 18:42:51 - REEDD
	   ORIG: REEDD - 09/25/97
	
	   Revision History

	02/25/00 - BECKERW - 35821
		TOTCOMEXP and TOTOUTEXP need to rounded to the precision
		indicated by the currency code.  It was causing decimal
		format errors.  Added rounding function when inserting or
		updating EXPCNTRY.

	   02/02/00 - CHOK - 31126
		      Fix PSL code

	   08/03/99 - CHOK - 33890
		      Converted procedure code to PSL

	*/

	new rs,ZTJD
	set ZTJD=%SystemDate
	type ResultSet rs=Db.select("ACN,COMEXP,OUTEXP,CRCD","EXPOS","MDT<:ZTJD")
	
	if rs.isEmpty() quit
	while rs.next() do { 
		set ACN=rs.getCol(1)
		set COMEXP=rs.getCol(2)
		set OUTEXP=rs.getCol(3)
		set CRCD=rs.getCol(4)
		if CRCD'=%SystemCurrency do {
			do EXC^CRCDUTL(%SystemCurrency,CRCD,COMEXP,0,2,11,,,1)
			set COMEXP=$G(EXCAMT)
			do EXC^CRCDUTL(%SystemCurrency,CRCD,OUTEXP,0,2,11,,,1)
			set OUTEXP=$G(EXCAMT)
			}
	
		set CODES=Db.getOneRow("PCNTRY,SIC,GOVT","CIF","ACN")
		set PCNTRY=$P(CODES,$C(9),1)
		set SIC=$P(CODES,$C(9),2)
		set GOVT=$P(CODES,$C(9),3)
		if PCNTRY'="" do {
			set X=Db.getOneRow("TOTCOMEXP,TOTOUTEXP","EXPCNTRY","PCNTRY")
			set TOTCOMEXP=$P(X,$C(9),1)
			set TOTCOMEXP=TOTCOMEXP-COMEXP
			set TOTOUTEXP=$P(X,$C(9),2)
			set TOTOUTEXP=TOTOUTEXP-OUTEXP
			set TOTCOMEXP=$$^SCARND(TOTCOMEXP,0,"",CRCD)   //WVB - 35821
			set TOTOUTEXP=$$^SCARND(TOTOUTEXP,0,"",CRCD)   //WVB - 35821
			do Db.update("EXPCNTRY","TOTCOMEXP=:TOTCOMEXP,TOTOUTEXP=:TOTOUTEXP","CNTRY=:PCNTRY")
			}
			
		if SIC'="" do {
			set X=Db.getOneRow("TOTCOMEXP,TOTOUTEXP","EXPIND","SIC")
			set TOTCOMEXP=$P(X,$C(9),1)
			set TOTCOMEXP=TOTCOMEXP-COMEXP
			set TOTOUTEXP=$P(X,$C(9),2)
			set TOTOUTEXP=TOTOUTEXP-OUTEXP
			set TOTCOMEXP=$$^SCARND(TOTCOMEXP,0,"",CRCD)   //WVB - 35821
			set TOTOUTEXP=$$^SCARND(TOTOUTEXP,0,"",CRCD)   //WVB - 35821
			do Db.update("EXPIND","TOTCOMEXP=:TOTCOMEXP,TOTOUTEXP=:TOTOUTEXP","IND=:SIC")
			}
	
		if GOVT'="" do {
			set X=Db.getOneRow("TOTCOMEXP,TOTOUTEXP","EXPCNSOV","PCNTRY")
			set TOTCOMEXP=$P(X,$C(9),1)
			set TOTCOMEXP=TOTCOMEXP-COMEXP
			set TOTOUTEXP=$P(X,$C(9),2)
			set TOTOUTEXP=TOTOUTEXP-OUTEXP
			set TOTCOMEXP=$$^SCARND(TOTCOMEXP,0,"",CRCD)   //WVB - 35821
			set TOTOUTEXP=$$^SCARND(TOTOUTEXP,0,"",CRCD)   //WVB - 35821
			do Db.update("EXPCNSOV","TOTCOMEXP=:TOTCOMEXP,TOTOUTEXP=:TOTOUTEXP","CNTRY=:PCNTRY")
			}
		do Db.delete("EXPOS","ACN=:ACN")
		}
	quit 
	
 #OPTION ResultClass ON
Public String vSIG()	quit "59886^43517^Sanchez SCM Administrator^2386"	// Signature - LTD^TIME^USER^SIZE
