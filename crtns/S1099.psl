S1099	//	Separate 1099 Reporting
  	/*
		ORIG: swarnalp (17293) - 12/26/2005

		---- Revision History ------------------------------------------------

 	*/
 	
UPD	//
	do INIT(1)
	quit
	
INQ	//
	do INIT(2)
	quit

INIT(%ProcessMode)	// init variables

	type Number %PG,OLNTB
	type String VFMQ

	type RecordDEP fDEP
	type RecordRELCIF fRELCIF
		
	set %PG=0
	do VPG(.fDEP,.fRELCIF)
	quit

VPG(RecordDEP fDEP,RecordRELCIF fRELCIF)	// Page control

	type public Number %PG,ER
	type public String VFMQ

	type Boolean FINISH=0

        for  do { quit:FINISH
                if %PG=0 do VPG00 if ER set FINISH=1 quit

                if %PG>0 do VPG01(.fDEP,.fRELCIF))

                if "DFQ"[VFMQ do VER(.fRELCIF) set FINISH=1 quit

                set %PG=%PG+1
                }
        quit
        
VPG00	// Set-up

	type public Number ER
	type public String VFMQ
		
	type String %NOPRMT,%READ,%TAB()
	
	set %TAB("CID")=".CID1/HLP=[DEP]CID/XPP=D POSCID^S1099"
	if %ProcessMode=2 set %TAB("IO")=$$IO^SCATAB($I)

	set %READ="@@%FN,,,CID/REQ",%NOPRMT="N"
	if %ProcessMode=2 set %READ=%READ_",IO/REQ"
	do ^UTLREAD if VFMQ="Q" set ER=1
	quit

VPG01(RecordDEP fDEP,RecordRELCIF fRELCIF)	// Actual notice information

	type public Number ACN,CID,ER
	type public String IO,VFMQ
	
	if %ProcessMode=2,IO'=$I do OPEN^SCAIO if ER set VFMQ="Q" quit
	set fDEP=Db.getRecord("DEP","CID=:CID",1)
	if 'fDEP.getMode() set VFMQ="Q" quit
	set fRELCIF=Db.getRecord("RELCIF","ACN=:ACN,CID=:CID",1)
	do DRV^USID(%ProcessMode,"S1099",.fDEP,.fRELCIF)
	quit

ERR	//

	type public Number ER
	type public String VFMQ
	
	set ER=1
 	do ^UTLERR
	set VFMQ="Q"
	quit

VER(RecordRELCIF fRELCIF)	// Verify and process

	type public Number ER
	type public String VFMQ
		
	if ER!(%ProcessMode=2)!(VFMQ="Q") do END quit
	do FILE(.fRELCIF)
	do END
	quit

FILE(RecordRELCIF fRELCIF)

	if %ProcessMode=1 do fRELCIF.save()
	quit

END	//

	type public Number ER,CID
	type public String RM,VFMQ
	
	if ER!(%ProcessMode=2)!(%ProcessMode=4) quit
	
	// Account ~p1 not modified
	if VFMQ="Q" set RM=$$^MSG(135,CID)
	// Account ~p1 modified
	else  set RM=$$^MSG(122,CID)
	set ER="W"
	quit

POSCID	//

	type public String X,ER,RM
	type public Number %EXT,ACN,CIF
	
	quit:X=""  set %EXT=1 do ^UACN quit:ER  quit:X=""
	
	type RecordACN acn=Db.getRecord("ACN","CID=:X",1)
	if 'acn.getMode() quit
	
	set ACN=acn.acn
	// Account in use
	lock +ACN(X):2 else  set ER=1,RM=$$^MSG(63) quit

	// CIF in use
	lock +CIF(ACN):2 else  set ER=1,RM=$$^MSG(548)
	quit
 	
 #OPTION ResultClass ON
Public String vSIG()	quit "60269^19927^P.R. Swarnalatha^2339"	// Signature - LTD^TIME^USER^SIZE
