public F0100132(RecordDEP dep,FEECAT,FEETYP,FEECNT,NOTFSN,TAMT)	// 09/13/2006 03:33 PM - 2111
	// Plan:  ZDRM3; for date:  01/03/2002; Desc:  Test
  /*
	ORIG: RUSSELL - 12/22/2001
	DESC: Deposit service fee template
	PROCEDURE ID:  SRVCMP1

---- Comments -----------------------------------------------------------------
	
	This procedure is never run independently.  It is used as a template
	by SRVCMP for the compilation of fee plans.

	Called at tag ENT by service fee program (^SRVFEE).  Called from
	the top for transaction processing, overdraft protection, and
	various inquiries.

	Makes use of FSN^BCHFEEUT and FILE^BCHFEEUT as private functions
	that contain code that does not need to be in the template.

	Note:  The arguments are used when the F* fee routine is generated.

 	ARGUMENTS:

		. dep		Deposit object		/TYP=RecordDEP/REQ/MECH=REF
		. FEECAT	Fee category		/TYP=T/REQ/MECH=VAL
		. FEETYP	Fee type		/TYP=T/REQ/MECH=VAL
		. FEECNT	Fee count		/TYP=T/NOREQ/MECH=VAL
		. NOTFSN	Do not update files	/TYP=T/NOREQ/MECH=VAL
		. TAMT		Transaction amount	/TYP=T/NOREQ/MECH=VAL

	RETURNS:
	
		. CHGOPT	Charge option		/TYP=N
		. FEEAMT	Fee amount		/TYP=$
		. MAXDLY	Maximum daily amount	/TYP=$
		. TR16		Fee info for TTXODC	/TYP=T

	---- Revision History -------------------------------------------------
	08/23/05 - RussellDS - CR16911
		   PSL clean-up to reduce warnings when fee plans are
		   compiled.
		   
		   Removed old revision history.
	*/

	
	/* The following lines are to avoid errors on mass recompiles of
	   procedures and will be removed by SRVCMP
	*/

	type Boolean ONLINE
	type Date SCND, UPNDT
	type Number ANLSYS, PLTP

	set ANLSYS=dep.anlsys
	set SCND=dep.scnd
	set UPNDT=dep.upndt
	set ONLINE=1
	
	do EXEC(.dep)
	
	quit
	

EXEC(RecordDEP dep)	// Process fee type FEETYP

	type public Boolean ER, NOTFSN, ONLINE
	type public Date SCND, UPNDT
	type public Number CHGOPT, FEECAT, FEECNT, MAXDLY, PLTP

	type Boolean HIT
	type Number CNT
	type String CRCD
	
	set FEECNT=$G(FEECNT)
	set NOTFSN=$G(NOTFSN)
	
	do PLAN(.dep)
	
	// Added this code to set the SCND equal to the UPNDT if the 
	// process is a usage credit and not a service fee.
	if $D(ONLINE),PLTP set SCND=UPNDT
	
	set (ER,MAXDLY)="",HIT=0
	
	if FEECAT=1 set HIT=$$FEECAT1(.dep)		// Miscellaneous fees
	else  if FEECAT=2 set HIT=$$FEECAT2(.dep)	// Event related fees
	else  if FEECAT=3 set HIT=$$FEECAT3(.dep)	// Transaction fees
	else  if FEECAT=4 set HIT=$$FEECAT4(.dep)	// Services fees

	/* Do not do FSN if no FEECNT, as FEECNT will be set to 0 for DLY fees
	   if none of the queries is true. This is the only fee type that
	   allows counter updates based on queries.

	   Note that FSN^BCHFEEUT depends on a variety of variables that are
	   defined in this routine.
	*/
	if 'ER,HIT,$D(ONLINE),$G(CHGOPT),FEECNT do FSN^BCHFEEUT
	quit
	

PLAN(RecordDEP dep)	// Plan Information - Get CRCD if convert flag is on.
	type public String CRCD
	type public Number PLTP
	set PLTP=0
	//tagplan
	quit
	

FEECAT1(RecordDEP dep)	// Miscellaneous fees (1000-1999)
	type public String FEETYP
	//tag1
	quit 0							// no hits
	

FEECAT2(RecordDEP dep)	// Event related fees (2000-2999)
	type public String FEETYP
	//tag2
	quit 0							// no hits
	

FEECAT3(RecordDEP dep)	// Transaction fees (3000-3999)
	type public String FEETYP
	if FEETYP="ZDRM" do 3000(.dep) quit 1
	//tag3
	quit 0							// no hits
	

FEECAT4(RecordDEP dep)	// Services (4000-4999)
	type public String FEETYP
	//tag4
	quit 0							// no hits


	// Type of Fee
3000(RecordDEP dep)	// Fee type:  ZDRM - Test
	type public Boolean ONLINE
	type public Number CHGOPT, CID, FEEAMT, FEECNT, MAXDLY, TAMT
	type public String CRCD
	set CHGOPT=1
	set MAXDLY=0,FEEAMT=(5*FEECNT)
	quit
	//tagtyp
	

	// Query modifiers
	//tagqry
	

	// Fee schedules
	//tagsch
	

	// Fee table lookup
	//tagtbl
	


public ENT(RecordDEP dep,FEEBAL,SRVSUM,SCND)	 
	/* Entry point from service fee driver (^SRVFEE)

	ARGUMENTS:
		. dep		Deposit object			/TYP=RecordDEP
								/REQ/MECH=REF

		. FEEBAL	Balance used to compute fees	/TYP=N/REQ
								/MECH=VAL
	
		. SRVSUM()	Service fee summary data	/TYP=N/COND
								/MECH=REFARR:R

		. SCND		Service charge next date	/TYPE=D/NOREQ
								/MECH=VAL
	
	INPUTS:
		. CTL		Control flag			/TYP=N/REQ
				Position 1 = 0 => no updates,
				  inquiry only
				Position 2
				  0 => update directly
				  1 => update FSN for ^DEPCL
				    Note:  no longer used since FSN array
				    no longer used.  Perform update here
				    and caller will rollback if needed
				Position 3 = 1 => adjustment
	  			  from EFD transaction, set up
				  FEER and FEET.  Used by
				  OL^BCHFEEUT for effective
				  dated transactions.

		. FEEPLN	Service fee plan for this	/TYP=T/REQ
				account				/MECH=REF

		. FEEPLN()	Service fee plan information	/TYP=T/REQ
				from SRVSUM			/MECH=REFARR:R
	
		. TRNGRP()	Transaction code groups		/TYP=T/COND
								/MECH=REFARR:R
	RETURNS:
		. FEE()		FEE(1) = direct charge		/TYP=ARRAY
				FEE(2) = charge at SCND
				FEE(3) = offset with earnings

		. FEE3A		Sum of FEECAT=3,CHGOPT=2 fees	/TYP=$

		. FEER		Restated transaction fees
				charged at analysis if
				CTL byte 3 is on.

		. FEET		Original transaction fees
				charged at analysis if
				CTL byte 3 is on.	
	*/
	
	type public Number FEE(), FEE3A, FEER, FEET
	type public String CTL, FEEPLN(), TRNGRP()
	
	type Boolean NOTFSN, ONNLINE
	type Number CHGOPT, FEEAMT, FEECAT, FEECNT, I, MAXDLY
	type String FEETYP, SCH
	
	kill FEE
	for I=1,2,3 set FEE(I)=0
	set FEE3A=0
	
	if $E(CTL,3) set (FEET,FEER)=0
	
	set FEECAT=1 D SRV(.dep)
	set FEECAT=2 D SRV(.dep)
	set FEECAT=3 D TRN(.dep), TRN2(.dep)
	set FEECAT=4 D PLN(.dep)
	quit


SRV(RecordDEP dep)	// Category 1 and 2 fees

	type public Number FEE(), FEECAT

	type ResultSet srvdrs=Db.select("FEETYP,SRVCSTD,SRVCNTA,SRVCSTA,SRVADJ,SRVTAMT","SRVD","CID=:CID AND PLTP=:PLTP AND SCND=:SCND AND FEECAT=:FEECAT")
	quit:srvdrs.isEmpty()
	
	while srvdrs.next() do {
		
		type Boolean QUIT
		type Number FEEAMT, FEECNT, SRVADJ, SRVCNTA, SRVCSTA, TAMT
		type String FEETYP, SCH
		
		set FEEAMT=0
		set FEETYP=srvdrs.getCol(1)
		set SRVCNTA=srvdrs.getCol(3)
		set SRVCSTA=srvdrs.getCol(4)
		set SRVADJ=srvdrs.getCol(5)
		set FEECNT=SRVCNTA+SRVADJ
		set TAMT=srvdrs.getCol(6)			// SRVTAMT
		set FEE(1)=FEE(1)+srvdrs.getCol(2)		// SRVCSTD

		set QUIT=0
		// Special handling for certain event related fees
		if FEECAT=2 do {
			if FEETYP="CRD",FEECNT set QUIT=$$CARDS(.dep)
			else  if FEETYP="STP",FEECNT set QUIT=$$STOPS(.dep)
			else  if FEETYP="DLY" set QUIT=$$DAILY(.dep,SRVADJ,SRVCNTA,SRVCSTA)
		}
		if QUIT quit		

		if FEECNT do EXEC(.dep)
		do FILE^BCHFEEUT
	}
	quit

CARDS(RecordDEP dep)	// Card fees

	type public Number FEEAMT, FEECNT

	type Number TOTFEES
	type String CARDTYPE
	
	set TOTFEES=0
	type ResultSet crdrs=Db.select("CARDTYPE,FEECNT","SRVCRD","CID=:CID AND PLTP=:PLTP AND SCND=:SCND AND FEECNT<>0")
	while crdrs.next() do {
		set CARDTYPE=crdrs.getCol(1)
		set FEECNT=crdrs.getCol(2)
		do EXEC(.dep)
		set TOTFEES=TOTFEES+FEEAMT
	}

	set FEEAMT=TOTFEES
	do FILE^BCHFEEUT
	quit 1

STOPS(RecordDEP dep)	// Stop fees

	type public Number FEEAMT, FEECNT
	
	type Number STPTYP, TOTFEES

	set TOTFEES=0
	type ResultSet stoprs=Db.select("SEQ,COUNT","SRVDTL","CID=:CID AND PLTP=:PLTP AND SCND=:SCND AND FEECAT=:FEECAT AND FEETYP='STP' AND COUNT<>0")
	if 'stoprs.isEmpty() do {	
		while stoprs.next() do {
			set STPTYP=stoprs.getCol(1)
			set FEECNT=stoprs.getCol(2)	// SRVCNTD
			do EXEC(.dep)
			set TOTFEES=TOTFEES+FEEAMT
		}
	}
	set FEEAMT=TOTFEES
	do FILE^BCHFEEUT
	quit 1

DAILY(RecordDEP dep,ADJ,CNTACCUM,CSTACCUM)	// Daily Fee Processing

	type public Number FEEAMT, FEECNT

	set FEECNT=ADJ
	do EXEC(.dep)			// Will return FEEAMT
	set FEEAMT=CSTACCUM+FEEAMT
	set FEECNT=CNTACCUM+ADJ
	do FILE^BCHFEEUT
	quit 1

	
TRN(RecordDEP dep)	// Category 3 fees - part 1

	type public Date SCND
	type public Number CID, FEE(), FEEAMT, FEECNT, FEET, PLTP
	type public String CTL, FEECAT, FEEPLN(,,), SRVSUM(,)

	type String FEETYP
	
	set FEETYP=""
	for  set FEETYP=$O(FEEPLN(FEEPLN,FEECAT,FEETYP)) quit:FEETYP=""  do {
		
		type Number SRVCSTA, SRVCSTD, TAMT
		type String SCH, X
		
		set FEEAMT=0
		set X=$G(SRVSUM(FEECAT,FEETYP))
		set FEECNT=$P(X,"|",1)
		set TAMT=$P(X,"|",2)
		
		type RecordSRVD srvd=Db.getRecord("SRVD","CID=:CID,PLTP=:PLTP,SCND=:SCND,FEECAT=:FEECAT,FEETYP=:FEETYP", 1)

		set SRVCSTA=srvd.srvcsta
		set SRVCSTD=srvd.srvcstd

		if $E(CTL,3) set FEET=FEET+SRVCSTA
		set FEE(1)=FEE(1)+SRVCSTD
		do EXEC(.dep)
		if FEECNT do FILE^BCHFEEUT
		// Restated fee for this fee type is being ec/reversed, so
		// do updates
		if $E(CTL,3),SRVCSTA,'FEECNT do FILE^BCHFEEUT
	}
	quit
	

TRN2(RecordDEP dep)	/* Category 3 fees - part 2
	Accumulate direct transaction fees that are included in the feeplan
	and direct transaction fees not in the account feeplan.
	*/
	
	type public Number FEE(), FEEAMT, FEECAT, FEECNT, FEETYP
	type public String FEEPLN(,,)

	type ResultSet srvdrs=Db.select("FEETYP,SRVCSTD,SRVCNTA,SRVADJ,SRVTAMT","SRVD","CID=:CID AND PLTP=:PLTP AND SCND=:SCND AND FEECAT=:FEECAT")
	
	while srvdrs.next() do {
		
		type Number TAMT
		
		set FEETYP=srvdrs.getCol(1)
		quit:$D(FEEPLN(FEEPLN,FEECAT,FEETYP))
		set FEEAMT=0
		set FEECNT=srvdrs.getCol(3)+srvdrs.getCol(4)	// SRVCNTA, SRVADJ
		set TAMT=srvdrs.getCol(5)			// SRVTAMT
		set FEE(1)=FEE(1)+srvdrs.getCol(2)		// SRVCSTD
		if FEECNT do EXEC(.dep),FILE^BCHFEEUT
	}
	quit

	
PLN(RecordDEP dep)	// Category 4 fees

	type public Number FEEAMT, FEECAT, FEECNT
	type public String FEEPLN(,,)

	type String FEETYP

	set FEETYP=""
	for  set FEETYP=$O(FEEPLN(FEEPLN,FEECAT,FEETYP)) quit:FEETYP=""  do {

		type String SCH
		
		set FEEAMT=0
		set FEECNT=1
		do EXEC(.dep)
		if FEEAMT do FILE^BCHFEEUT
	}
	quit
