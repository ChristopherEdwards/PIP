CNVCHECK		/*
	 ORIG: VARGAJ - 05/15/07
	 DESC: The conversion routine to move the old records of the CHECK
	 	table to the new structure.

	---- Comments --------------------------------------------------------
	
	---- Revision History ------------------------------------------------



	*/

	type String CHKNUMS()
	
	do SYSVAR^SCADRV0()
	
	do Db.fastDelete("CHECK")
	
	do GETCHECKNUM(.CHKNUMS)
	
	do CNV(.CHKNUMS)
	
	quit
	

	
CNV(String CHECKNUMS())
	
	type DbSet ds = Db.selectDbSet("TMPCHECKCNV")
	
	while ds.next() do {
		type RecordTMPCHECKCNV checkcnv = ds.getRecord("TMPCHECKCNV")
		type RecordCHECK check = Class.new("RecordCHECK")
		
		if 'CHECKNUMS(checkcnv.chknum) do { quit
			throw Class.new("Error","No Check Number generated for " _ checkcnv.chknum) 
		}
		
		set check.chks = checkcnv.chks
		set check.cid = checkcnv.cid
		set check.chknum = CHECKNUMS(checkcnv.chknum)
		set check.chksts = checkcnv.chksts
		set check.issd = checkcnv.issd
		set check.acn = checkcnv.acn
		set check.brcd = checkcnv.brcd
		set check.gchecknum = checkcnv.chknum
		set check.%uid = "batch"
		set check.scd = %SystemDate
		do check.bypassSave()			
	}
	
	quit
	
GETCHECKNUM(String CHECKNUMS())
	
	// Get all the tmpcheckcnv by account
	type ResultSet rsCID = Db.select("DISTINCT CID","TMPCHECKCNV")
	
	if rsCID.isEmpty() do { quit
		throw Class.new("Error","TMPCHECKCNV has no distinct CIDS!") 
	}
	
	// For each account find all the global check numbers
	while rsCID.next() do {
		type Number CID = rsCID.getCol("CID")
		type ResultSet rsGCheck = Db.select("CHKNUM","TMPCHECKCNV","CID=:CID")
		type String PREVALPHA
		type Number CURRCHK
		
		if rsGCheck.isEmpty() do { quit
			throw Class.new("Error","TMPCHECKCNV has no Check numbers")
		}
		
		set PREVALPHA = ""
		set CURRCHK = 0
		
		while rsGCheck.next() do {
			type String CHKNUM = rsGCheck.getCol("CHKNUM")
			
			/*
			  when the global check numbers alpha portion change
			  start a new "block" of local checks
			*/
			if PREVALPHA'=CHKNUM.extract(1,2) do {
				set CURRCHK = ((CURRCHK\1000) + 1) * 1000
				set PREVALPHA=CHKNUM.extract(1,2)
			}
			
			set CHECKNUMS(CHKNUM)=CURRCHK
			set CURRCHK=CURRCHK+1
		}	
	}
	
	quit 
 #OPTION ResultClass ON
Public String vSIG()	quit "60766^55581^John Varga^2079"	// Signature - LTD^TIME^USER^SIZE
