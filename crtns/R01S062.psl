R01S062	// IRSO99QC - IRS 1099-Q Report by Tax Identification
	// Copyright(c)2007 Sanchez Computer Associates, Inc.  All Rights Reserved - 09/10/2007 15:37 - root

	type public Number ER=0
	type public Number vbatchq
	type public String IO,RM,VRWOPT()
	type public String CTOF,PROTVAL
	type Number OLNTB
	type String %READ,RID,RN,%TAB,VFMQ

	set RID="IRSO99QC"
	set RN="IRS 1099-Q Report by Tax Identification"
	if IO.get()="" set IO=$I

	do INIT^%ZM()

	do VPREBQ quit:VFMQ.get()			// Pre-processor (before query)

	set %TAB("IO")=$$IO^SCATAB

	set %READ="IO/REQ,"

	// Skip device prompt option
	if VRWOPT("NOOPEN").get() set %READ=%READ.piece(",",2,99)

	set VFMQ=""
	if %READ'="" do { quit:VFMQ.get()="Q"
		set OLNTB=30
		set %READ="@RN/CEN#1,,"_%READ
		do ^UTLREAD
		}

	if 'vbatchq.get() do V0
	quit

V0	// External report entry point

	type public Number AUXPTR,ER,VTBLNAM
	type public String IO,IOPAR,IOSL,IOTYP,%MSKD,RM,VDISTKEY,VRWOPT()
	type public String CTOF,PROTVAL
	type Number vcrt,VD(),VFMQ,vh(),vI,vlc,VLC,VNEWHDR,VOFFLG,VPN,VR,VRG,vs(),VSEQ,VT()
	type String %TIM,BX1,BX2,BX3,CONAM,NAM,RID,RN,TAXID,VL,VLOF,VRF(),VSTATS(),vCOL,vHDG,vc1,vc2,vc3,vc4,vc5,vc6,vc7,vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vrundate,vsysdate

	type RecordCUVAR cuvar=Db.getRecord("CUVAR")

	set CONAM=CUVAR.conam
	set ER=0,RID="IRSO99QC",RN="IRS 1099-Q Report by Tax Identification"
	set VL=""

	use 0 if 'VRWOPT("NOOPEN").get() do { quit:ER
		if 'VRWOPT("IOPAR").get().isNull() set IOPAR = VRWOPT("IOPAR")
		else  if ((IOTYP.get()="RMS")!(IOTYP.get()="PNTQ")),('IOPAR.get().isLike("%/OCHSET=%")),$$VALID^%ZRTNS("UCIOENCD") do {
			// Accept warning if ^UCIOENCD does not exist
			#ACCEPT Date=07/26/06; Pgm=RussellDS; CR=22121; Group=MISMATCH
			type String CHRSET=$$^UCIOENCD("Report","IRSO99QC","V0","*")
			if 'CHRSET.isNull() set IOPAR = IOPAR_"/OCHSET="_CHRSET
		}
		do OPEN^SCAIO
	}
	set vcrt=(IOTYP="TRM")
	if 'vcrt set IOSL=60				// Non-interactive
	else  do {					// Interactive
		do TERM^%ZUSE(IO,"WIDTH=133")
		write $$CLEARXY^%TRMVT
		write $$SCR132^%TRMVT			// Switch to 132 col mode
		}

	do INIT^%ZM()

	set vCOL="[TMPRPT5]KEY3#46#12,[TMPRPT5]KEY4#59#12"

	// Print Report Banner Page
	if cuvar.banner,'VRWOPT("NOBANNER").get(),IOTYP'="TRM",'AUXPTR.get() do {
		type String VBNRINFO(),VWHERE


		set VWHERE="TMPRPT5.PID=:%ProcessID"
		set VBNRINFO("WHERE")=VWHERE

		set VBNRINFO("DESC")="IRS 1099-Q Report by Tax Identification"
		set VBNRINFO("PGM")="R01S062"
		set VBNRINFO("RID")="IRSO99QC"
		set VBNRINFO("TABLES")="TMPRPT5"

		set VBNRINFO("ORDERBY",1)="[SYSDEV,TMPRPT5]PID"
		set VBNRINFO("ORDERBY",2)="[SYSDEV,TMPRPT5]KEY1"
		set VBNRINFO("ORDERBY",3)="[SYSDEV,TMPRPT5]KEY2"
		set VBNRINFO("ORDERBY",4)="[SYSDEV,TMPRPT5]KEY3"
		set VBNRINFO("ORDERBY",5)="[SYSDEV,TMPRPT5]KEY4"
		set VBNRINFO("ORDERBY",6)="[SYSDEV,TMPRPT5]KEY5"

		set VBNRINFO("DOC",1)="This report allows an institution to identify Form 1099-Q recipients by tax"
		set VBNRINFO("DOC",2)="identification number."

		do ^DBSRWBNR(IO,.VBNRINFO)		// Print banner
		}

	// Initialize variables
	set (vc1,vc2,vc3,vc4,vc5,vc6,vc7)=""
	set (VFMQ,vlc,VLC,VOFFLG,VPN,VRG)=0
	set VNEWHDR=1
	set VLOF=""
	set %TIM=$$TIM^%ZM
	set vrundate=%CurrentDate.toString(),vsysdate=%SystemDate.toString()

	do {
		type Number I,J,K
		for I=0:1:6 do {
			set (vh(I),VD(I))=0,vs(I)=1	// Group break flags
			set VT(I)=0			// Group count
			for J=1:1:3 do {
				for K=1:1:3 set VT(I,J,K)=""	// Initialize function stats
				}
			}
		}

	do Db.delete("TMPRPTBR","JOBNO=:%ProcessID")	// Report browser data
	set vh(0)=0

	// Run report directly
	do VINILAST
	type ResultSet rwrs=Db.select("TMPRPT5.PID,TMPRPT5.KEY1,TMPRPT5.KEY2,TMPRPT5.KEY3,TMPRPT5.KEY4,TMPRPT5.KEY5,TMPRPT5.DATA","TMPRPT5","TMPRPT5.PID=:%ProcessID","TMPRPT5.PID,TMPRPT5.KEY1,TMPRPT5.KEY2,TMPRPT5.KEY3,TMPRPT5.KEY4,TMPRPT5.KEY5","","DQMODE=1")
	if ER.get() use 0 write $$MSG^%TRMVT(RM.get(),"",1)	// Debug Mode
	if rwrs.isEmpty() do VEXIT(1) quit
	while rwrs.next() do { quit:VFMQ
		type String V,VI
		set V=rwrs.getRow().toString()
		set VI=""
		do VGETDATA(V,VI)
		do VPRINT quit:VFMQ
		do VSAVLAST
		}
	do VEXIT(0)

	quit


VINILAST	// Initialize last access key values
	type Public String vovc1,vovc2,vovc3,vovc4,vovc5,vovc6
	set vovc1="",vovc2="",vovc3="",vovc4="",vovc5="",vovc6=""
	quit

VSAVLAST	// Save last access keys values
	type Public String vovc1,vc1,vovc2,vc2,vovc3,vc3,vovc4,vc4,vovc5,vc5,vovc6,vc6
	set vovc1=vc1,vovc2=vc2,vovc3=vc3,vovc4=vc4,vovc5=vc5,vovc6=vc6
	quit


VGETDATA(String V,String VI)	//
	type Public String vc1,vc2,vc3,vc4,vc5,vc6,vc7
	set vc1=V.piece($C(9),1)			// TMPRPT5.PID
	set vc2=V.piece($C(9),2)			// TMPRPT5.KEY1
	set vc3=V.piece($C(9),3)			// TMPRPT5.KEY2
	set vc4=V.piece($C(9),4)			// TMPRPT5.KEY3
	set vc5=V.piece($C(9),5)			// TMPRPT5.KEY4
	set vc6=V.piece($C(9),6)			// TMPRPT5.KEY5
	set vc7=V.piece($C(9),7)			// TMPRPT5.DATA
	quit

	// User-defined pre/post-processor code

VPREBQ	// Pre-processor (before query)

 /*
  ---- Revision History ------------------------------------------------

	05/23/07 - LANCE LAN - CR 24982
		 - Added logic for the Tax ID masking.

        04/24/06 - DHANALAKSHMI R - CR 20879
                   Modified the settings of AMT(1) to include only the
                   distribution made using the codes 1, 2, 5, 6, 7, 18, 
                   19 and 39.
                   Removed the declaration of the variables I,VAR to 
                   correct the compilation warning. 

        12/07/05 - TITOVE - CR 17287
                   Converted into PSL.
 */

 //Incoming=CTOF,PROTVAL

 type public Number CTOF,PROTVAL
 
 type Number AMT1, AMT2, TAXYR
 
 type RecordUTBLIRS utblirs = Db.getRecord("UTBLIRS", "KEY = '1098-Q'", 1)
 
 // Form Cutoff Amount
 set CTOF = utblirs.fctoff
 
 set TAXYR = %SystemDate.year() - 1
 
 // Create a temp table with report data
 
 type DbSet ds = Db.selectDbSet("IRA", "TAXYR = :TAXYR")
 
 while ds.next() do {
 	
 	type RecordIRA ira = ds.getRecord("IRA")
 	
 	type RecordIRATYPE iratype = Db.getRecord("IRATYPE", "ACN = :ira.acn, RPASEQ = :ira.rpaseq")
 
 	// Only select Coverdell
 	if (iratype.iratyp <> 12) quit
 	
	set AMT1 = ira.d1 + ira.d5 + ira.d6 + ira.d7 + ira.d18 + ira.d19 + ira.d39
	set AMT2 = ira.d2

	// Nothing to report	
	if (AMT1 + AMT2) = 0 quit
	
 	type RecordCIF cif = Db.getRecord("CIF", "ACN = :ira.acn", 1)
 
	if AMT1,(AMT1 '< CTOF) do {
		
		type RecordTMPRPT5 rpt5 = Db.getRecord("TMPRPT5", "PID = :%ProcessID, KEY1 = :ira.taxyr, KEY2 = :cif.taxid, KEY3 = :ira.acn, KEY4 = :ira.rpaseq, KEY5 = 1", 1)
	 
		set rpt5.data = cif.nam_"|"_AMT1
 
		do rpt5.save()
		}
	
	if AMT2,(AMT2 '< CTOF) do {
		
		type RecordTMPRPT5 tmp5 = Db.getRecord("TMPRPT5", "PID = :%ProcessID, KEY1 = :ira.taxyr, KEY2 = :cif.taxid, KEY3 = :ira.acn, KEY4 = :ira.rpaseq, KEY5 = 2", 1)
	 
		set tmp5.data = cif.nam_"|"_AMT2
 
		do tmp5.save()
		}		
        }
 
  /*
   Check if the data item protection scheme is set up on the
   CIF.TAXID column corresponding to report's TAXID variable field.
   After the protection value on the column is determined, and appears
   that a user class has no access to the column's value, the TAXID
   field will be masked in its pre-processor.
 */

 type ResultSet rs = Db.select("TAXID","CIF",,,,"/PROTECTION=2")

 if rs.next() set PROTVAL = rs.getColProt("TAXID")
 else  set PROTVAL = ""
	quit

VRPOST	// Report post-processor

 /*
  ---- Revision History ------------------------------------------------
 
        12/07/05 - TITOVE - CR 17287
                   Converted into PSL.
 */
 
 do Db.delete("TMPRPT5","PID=:%ProcessID")
	quit

VBRSAVE(Number LINE,String DATA)	// Save for report browser
	type RecordTMPRPTBR tmprptbr=Class.new("RecordTMPRPTBR")
	set tmprptbr.jobno=%ProcessID
	set tmprptbr.lineno=LINE
	set tmprptbr.pageno=0
	set tmprptbr.seq=0
	set tmprptbr.data=DATA
	do tmprptbr.bypassSave()
	quit

VEXIT(NOINFO)	// Exit from report
	type Public Number IOSL,vcrt,VFMQ,vh(),VLC,VPN,VRWOPT,VSTATS()
	type Public String IO,VTBLNAM
	type Number I,PN,vs(),z
	type String VL=""
	set vs(1)=0,vs(2)=0,vs(3)=0,vs(4)=0,vs(5)=0,vs(6)=0
	if 'VFMQ do VSUM
	if 'VFMQ do VRSUM
	if 'VFMQ do {
		// No information available to display
		if NOINFO=1 set VL=$$^MSG(4655) do VOM
		if vcrt set VL="" for z=VLC+1:1:IOSL do VOM

		if 'VTBLNAM.exists() do {
			set vs(2)=0
			do VRPOST			// Report Post-Processor
			}
		}

	if 'VFMQ,vcrt set PN=-1 do ^DBSRWBR(2)
	if 'VRWOPT("NOCLOSE").get() do CLOSE^SCAIO
	do Db.delete("TMPRPTBR","JOBNO=:%ProcessID")	// Report browser data

	quit

VPRINT	// Print section
	type Public Number VD(),VFMQ,VH0,vh(),VNEWHDR,VR,VRG,VRWOPT,VSEQ
	type Number vskp()

	if VRWOPT("NODTL").get() set vskp(5)=1,vskp(6)=1	// Skip detail
	do VBREAK
	do VSUM quit:VFMQ

	if VH0.get() set vh(0)=0,VNEWHDR=1 kill VH0	// Page Break
	if 'vh(0) do VHDG0 quit:VFMQ
	if 'vskp(6).get() do VDTL6 quit:VFMQ
	do VSTAT
	quit

VBREAK	//
	type Public Number VD(),vh(),VH0,vs(),VT()
	quit:'VT(6)
	type Public String vc1,vovc1,vc2,vovc2,vc3,vovc3,vc4,vovc4,vc5,vovc5,vc6,vovc6
	type Number vb1,vb2,vb3,vb4,vb5,vb6
	set (vb1,vb2,vb3,vb4,vb5,vb6)=0
	if vb1!(+vovc1'=+vc1) set vs(2)=0,vh(2)=0,VD(1)=0,vb2=1,vb3=1,vb4=1,vb5=1,vb6=1,VH0=1
	if vb2!(vovc2'=vc2) set vs(3)=0,vh(3)=0,VD(2)=0,vb3=1,vb4=1,vb5=1,vb6=1
	if vb3!(vovc3'=vc3) set vs(4)=0,vh(4)=0,VD(3)=0,vb4=1,vb5=1,vb6=1
	if vb4!(vovc4'=vc4) set vs(5)=0,vh(5)=0,VD(4)=0,vb5=1,vb6=1
	if vb5!(vovc5'=vc5) set vs(6)=0,vh(6)=0,VD(5)=0,vb6=1
	quit

VSUM	// Report Group Summary
	type Public Number VFMQ,vs()
	if 'vs(6) set vs(6)=1 do stat^DBSRWUTL(6)
	if 'vs(5) set vs(5)=1 do stat^DBSRWUTL(5)
	if 'vs(4) set vs(4)=1 do stat^DBSRWUTL(4)
	if 'vs(3) set vs(3)=1 do stat^DBSRWUTL(3)
	if 'vs(2) set vs(2)=1 do stat^DBSRWUTL(2)
	quit

VSTAT	// Data field statistics
	type Public Number VRWOPT(),VT(),BX1,BX2,BX3
	type Public String VSTATS

	set VT(6)=VT(6)+1
	set VT(6,1,1)=VT(6,1,1)+BX1			// @TOT(<<BX1>>)
	set VT(6,2,1)=VT(6,2,1)+BX2			// @TOT(<<BX2>>)
	set VT(6,3,1)=VT(6,3,1)+BX3			// @TOT(<<BX3>>)
	quit

VDTL6	// Detail
	type public String %TIM,BX1,BX2,BX3,CTOF,IOSL,NAM,PROTVAL,TAXID,V,VD(),VFMQ,VL,VLC,VO,VOFFLG,VPN,VRG,VT(),vc1,vc2,vc3,vc4,vc5,vc6,vc7,verror,vh(),vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vrundate,vsysdate

	if VLC+1>IOSL do VHDG0 quit:VFMQ

	do VP1 quit:VFMQ!verror.get()  set V=$E(TAXID,1,11) set VL=" "_V
	do VP2 quit:VFMQ!verror.get()  set V=$E(NAM,1,30)
	set VL=VL_$J("",14-VL.length())_V
	set VL=VL_$J("",45-VL.length())_$J(vc4,12)
	set VL=VL_$J("",58-VL.length())_$J(vc5,12)
	do VP3 quit:VFMQ!verror.get()  set V=$S(BX1="":"",1:$J(BX1,0,2))
	set VL=VL_$J("",72-VL.length())_V
	do VP4 quit:VFMQ!verror.get()  set V=$S(BX2="":"",1:$J(BX2,0,2))
	set VL=VL_$J("",92-VL.length())_V
	do VP5 quit:VFMQ!verror.get()  set V=$S(BX3="":"",1:$J(BX3,0,2))
	set VL=VL_$J("",112-VL.length())_V
	do VOM
	quit


VHDG0	// Page Header
	type Public Number ER,IOSL,vcrt,verror,VFMQ,vh(),VLC,VNEWHDR,VPN,VRG,VRWOPT()
	type public String %MSKD,%TIM,BX1,BX2,BX3,CONAM,CTOF,NAM,PROTVAL,RID,RN,TAXID,VL,vc1,vc2,vc3,vc4,vc5,vc6,vc7,vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vrundate,vsysdate
	type Number PN,V,VO
	if VRWOPT("NOHDR").get() quit			// Skip page header
	set vh(0)=1,VRG=0
	if VL'="" do VOM
	if vcrt,VPN>0 do { quit:VFMQ!'VNEWHDR
		type Number PN,X
		set VL=""
		for X=VLC+1:1:IOSL do VOM
		set PN=VPN
		do ^DBSRWBR(2)
		set VLC=0
		quit:VFMQ
		if VNEWHDR write $$CLEARXY^%TRMVT
		else  set VLC=VLC+8,VPN=VPN+1
		}

	set ER=0,VPN=VPN+1,VLC=0

	set VL=$E($G(CONAM),1,45)
	set VL=VL_$J("",100-VL.length())_"Run Date:"
	set VL=VL_$J("",110-VL.length())_$E(vrundate,1,10)
	set VL=VL_$J("",123-VL.length())_$E(%TIM,1,8)
	do VOM
	set VL=RN_"  ("_RID_")"
	set VL=VL_$J("",102-VL.length())_"System:"
	set VL=VL_$J("",110-VL.length())_$E(vsysdate,1,10)
	set VL=VL_$J("",122-VL.length())_"Page:"
	set VL=VL_$J("",128-VL.length())_$J(VPN,3)
	do VOM
	set VL="" do VOM
	set VL="1099-Q cut-off amount: "_CTOF
	do VOM
	set VL="" do VOM
	set VL=" "_"Tax ID       Customer Name                       Account     Sequence  Gross Distribution            Earnings               Basis"
	do VOM
	set VL="===================================================================================================================================="
	do VOM
	set VL="" do VOM

	set VNEWHDR=0
	if vcrt set PN=VPN do ^DBSRWBR(2,1)		// Lock report page heading

	quit


VRSUM	// Report Summary
	type Public Number IOSL,verror,VFMQ,vh,VLC,VT(),VX()
	type Public String %TIM,BX1,BX2,BX3,CTOF,NAM,TAXID,VPN,vovc1,vovc2,vovc3,vovc4,vovc5,vovc6,vrundate,vsysdate
	type Number I
	type String V,VL

	set VL=""
	if 'vh(0) do VHDG0 quit:VFMQ
	if VLC+2>IOSL do VHDG0 quit:VFMQ

	set VL="" do VOM
	set VL="Report Totals:"
	set V=(VT(0)+VT(1)+VT(2)+VT(3)+VT(4)+VT(5)+VT(6))	// @CNT(0,N,4)
	set VL=VL_$J("",16-VL.length())_$J(V,4)
	set VL=VL_$J("",21-VL.length())_"Accounts"
	set V=0						// @TOT(<<BX1>>,0)
	for I=0:1:6 set V=V+VT(I,1,1)
	set VL=VL_$J("",72-VL.length())_$S(V="":"",1:$J(V,0,2))
	set V=0						// @TOT(<<BX2>>,0)
	for I=0:1:6 set V=V+VT(I,2,1)
	set VL=VL_$J("",92-VL.length())_$S(V="":"",1:$J(V,0,2))
	set V=0						// @TOT(<<BX3>>,0)
	for I=0:1:6 set V=V+VT(I,3,1)
	set VL=VL_$J("",112-VL.length())_$S(V="":"",1:$J(V,0,2))
	do VOM
	quit

VOM	// Output print line
	type Public Number AUXPTR,vcrt,vlc,VLC,VRG
	type Public String IO,VL

	use IO

	// Advance to a new page
	if 'VLC,'vcrt do {				// Non-CRT device (form feed)
		if 'AUXPTR.get() write $C(12),!
		else  write $$PRNTFF^%TRMVT,!
		set $Y=1
		}

	if vcrt<2 write VL,!				// Output line buffer
	if vcrt set vlc=vlc+1 do VBRSAVE(vlc,VL)	// Save in BROWSER buffer
	set VLC=VLC+1,VL=""				// Reset line buffer
	quit

	// Pre/post-processors

VP1	// Column pre-processor - Variable: TAXID

	type public String vc3
        type public Number PROTVAL
        type public String TAXID

        set TAXID = vc3

        // If DATA-QWIK column protection scheme is set on CIF.TAXID column,
        // mask TAXID variable field's value.

        if PROTVAL = 3 set TAXID = "***********"

 
	quit

VP2	// Column pre-processor - Variable: NAM

	type public String vc7
 /*
  ---- Revision History ------------------------------------------------
 
        12/06/05 - TITOVE - CR 17287
                   Converted into PSL.
 */
 type public String NAM = vc7.piece("|",1)
	quit

VP3	// Column pre-processor - Variable: BX1

	type public String vc7
 /*
  ---- Revision History ------------------------------------------------
 
        12/06/05 - TITOVE - CR 17287
                   Converted into PSL.
 */
 type public Number BX1 = vc7.piece("|",2)
	quit

VP4	// Column pre-processor - Variable: BX2

 /*
  ---- Revision History ------------------------------------------------
 
        12/06/05 - TITOVE - CR 17287
                   Converted into PSL.
 */
 type public Number BX2
 
 set BX2 = ""
	quit

VP5	// Column pre-processor - Variable: BX3

 /*
  ---- Revision History ------------------------------------------------
 
        12/06/05 - TITOVE - CR 17287
                   Converted into PSL.
 */
 type public Number BX3
 
 set BX3 = ""
	quit
