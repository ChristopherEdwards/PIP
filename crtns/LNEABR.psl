LNEABR	// Re-run Escrow analysis at will
	/*
	       ORIG:  Neal E. Gorman
	  CALLED BY:
	      CALLS:
	   PROJ #'S:
	       DESC:
	   GLOBALS -
	       READ:
	        SET:
	      INPUT:
	     OUTPUT:

	---- Revision History -------------------------------------------------
	12/04/05 - Srinivar - CR 16890
		   Removed the ERR section since it is not used anywhere.
		   Removed the ^UTLERRR calls.
		   Replaced the sets of ER /ET with Runtim.setErrSTBLER() calls. 
		   Modified the section FILE to call INIT^BCHLNEAB directly.
		   Replaced the Q() array with dynamic sql statements.
		   Modified the code to conform to PSL standards
		   Code for the screen driver procedure has been 
	           restructured to include the code present in 
	           VPG and VPG0 to be in the INIT section .
	           Section VPG and VPG0 has been removed.
	           	           
	12/10/03 - CARROLLJ - CR7239
		   Added #ACCEPT prior to xecute command to correct compile
		   errors.

	11/15/02 - SHVACHKINAD/GRAY - 49794
		   Converted to PSL.

	09/10/00 - AGARWALS - 41778
	           Modified the FILE section to return the message "Analysis
	           has been re-run for 0 accounts" when an invalid account is
	           specified. It was returning "Cursor LNEABR is not open".
	           Also modified to be able to process multiple accounts
	           specified at the prompt e.g. "7000,7001,7002" or ">7000"

	08/31/00 - CHEUNGA - 41490
	           Modified the OPENCUR and the FILE sections to prevent an
	           undefined error when "ALL" is enter in for the Account
	           Number.


	*/
	
	do INIT quit
	
INIT	
	type Number %PG,%PAGE
	type public String VFMQ
	set (%PG,%PAGE)=1
	
        do VPG01 if "DFQ"[VFMQ do VER quit
        set %PG=%PG+1
        do VER
         
	quit

VPG01	// Set up
	type public String %READ,%TAB,VFMQ

	set %TAB("EFD")=".EFD5/XPP=D PP^LNEABR/MIN=1/MAX=80000"
	set %TAB("LCID")=".ACCOUNTS1/HLP=[LN]CID"
	set %READ="@@%FN,,,EFD/REQ,LCID/REQ"

	do ^UTLREAD
	if VFMQ'="Q" 
	quit

VPGT	// Set up
	
	type public String %READ,%TAB
	
	set %TAB("EFD")=".EFD5/MIN=1/MAX=80000"
	set %TAB("LCID")=".ACCOUNTS1/HLP=[LN]CID/XPP=D PP2^LNEABR"
	set %READ="@@%FN,,,EFD/REQ,LCID/REQ"

	do ^UTLREAD
	quit


VER     
	type public Boolean ER
	type public Number ARRCNT
	type public String VFMQ
	
	
	if ER!(%ProcessMode=2)!(%ProcessMode=4)!(VFMQ="Q") do END quit
	
	set ARRCNT=0
	do FILE
	do END
        quit

FILE	// File data

	type public String VFMQ
	
	type Date SVTJD
	type Number CID,RERUN
	type String DQQRY,WHERE
	
	set SVTJD=%SystemDate
	
	#ACCEPT DATE=12/10/03;PGM=John Carroll
	set %SystemDate=%EffectiveDate 
	set RERUN=1

	//I18N=OFF
	
	set DQQRY(1) = "[LN]ANOFFDT "_%EffectiveDate 
	set WHERE = " AND "_$$WHERE^SQLCONV(.DQQRY(), "LN")
	
	#ACCEPT DATE=01/23/06;PGM=srinivar
	type ResultSet rs = Db.select("CID", "LN","CID=:CID"_WHERE)
			
	//I18N=ON
	if rs.isEmpty() set VFMQ="Q" quit
	while rs.next() do {
		set CID=rs.getCol(1)
		do INIT^BCHLNEAB
		}
	quit

END	
	
	type public Boolean ARRCNT,ER
	type public String RM,%TAB,VFMQ
			
	kill %TAB 
	lock 
	if ER!(%ProcessMode=2)!(%ProcessMode=4) quit

	// Analysis has not been re-run
	if VFMQ="Q" set RM=$$^MSG(293)

	// Analysis has been re-run for ~p1 accounts
	else  set RM=$$^MSG(291,ARRCNT)
	set ER="W"
	quit


PP	// Post processor to EFD

	type public Boolean ER
	type public Date X
	
	type String ET
	
	if X="" quit
	// Invalid date
	if X'?5N set X=$$^SCAJD if X<0 set ER=1 set ET="INVLDDT" quit

	type ResultSet rs=Db.select("ANOFF","LN","ANOFF=:X")
	if rs.isEmpty() do {
		
		// No DAYEND file created for this date
		do Runtime.setErrSTBLER("LN","NODEENT") 
	}
	quit
 #OPTION ResultClass ON
Public String vSIG()	quit "60304^25068^Srinivasan, Rajesh^3464"	// Signature - LTD^TIME^USER^SIZE
